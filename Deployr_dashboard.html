<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deployr - AI DevOps Autopilot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
            }

            to {
                transform: translateX(0);
            }
        }

        .slide-in {
            animation: slideIn 0.3s ease-out;
        }

        /* Color palette based on logo */
        :root {
            --primary: #00BCD4;
            --primary-dark: #0097A7;
            --primary-light: #4DD0E1;
            --bg-dark: #1A1A1A;
            --bg-darker: #0F0F0F;
            --bg-card: #2A2A2A;
            --text-primary: #FFFFFF;
            --text-secondary: #B0B0B0;
            --border: #3A3A3A;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-primary);
        }

        .bg-primary {
            background-color: var(--primary);
        }

        .bg-primary-dark {
            background-color: var(--primary-dark);
        }

        .text-primary {
            color: var(--primary);
        }

        .border-primary {
            border-color: var(--primary);
        }

        .card {
            background-color: var(--bg-card);
            border: 1px solid var(--border);
        }

        .nav-button {
            transition: all 0.2s;
        }

        .nav-button:hover {
            background-color: rgba(0, 188, 212, 0.1);
        }

        .nav-button.active {
            background-color: rgba(0, 188, 212, 0.2);
            border-bottom: 2px solid var(--primary);
        }

        /* Subscription overlay */
        .subscription-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(8px);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .locked-feature {
            opacity: 0.5;
            pointer-events: none;
            position: relative;
        }

        .locked-feature::after {
            content: 'üîí';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
        }
    </style>
</head>

<body>
    <div id="app"></div>

    <!-- Subscription Upgrade Modal -->
    <div id="upgradeModal" style="display: none;" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-6">
        <div class="card rounded-xl max-w-md w-full p-8 shadow-2xl">
            <div class="text-center mb-6">
                <i class="fas fa-crown text-6xl mb-4" style="color: var(--primary);"></i>
                <h2 class="text-3xl font-bold mb-2">Upgrade to Pro</h2>
                <p class="text-gray-400">Continue monitoring with full access</p>
            </div>

            <div class="bg-black bg-opacity-50 rounded-lg p-6 mb-6 border border-primary">
                <div class="text-center mb-4">
                    <div class="text-5xl font-bold mb-2">$99</div>
                    <div class="text-gray-400">per month</div>
                </div>
                
                <div class="space-y-3 text-sm">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-check text-green-500"></i>
                        <span>AI-powered anomaly detection</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <i class="fas fa-check text-green-500"></i>
                        <span>Autonomous remediation</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <i class="fas fa-check text-green-500"></i>
                        <span>Root cause analysis</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <i class="fas fa-check text-green-500"></i>
                        <span>24/7 Slack alerts</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <i class="fas fa-check text-green-500"></i>
                        <span>Learning & pattern recognition</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <i class="fas fa-check text-green-500"></i>
                        <span>Unlimited monitored services</span>
                    </div>
                </div>
            </div>

            <button onclick="handleUpgrade()" class="w-full bg-primary hover:bg-primary-dark text-black py-4 rounded-lg font-bold text-lg mb-3 transition">
                <i class="fas fa-credit-card mr-2"></i>Upgrade Now
            </button>
            
            <button onclick="closeUpgradeModal()" class="w-full bg-gray-700 hover:bg-gray-600 py-3 rounded-lg font-semibold transition">
                Maybe Later
            </button>

            <p class="text-xs text-gray-500 text-center mt-4">
                Cancel anytime. No hidden fees.
            </p>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        const CURRENT_USER_ID = 'demo_user_123'; // Replace with actual auth
        
        let currentView = 'control-center';
        let autoRefresh = false;
        let refreshInterval = null;
        let subscription = null;

        let state = {
            stats: null,
            incidents: [],
            anomalies: [],
            services: [],
            pendingActions: [],
            actionHistory: [],
            learningStats: {},
            autonomousStatus: null,
            safetyStatus: null,
            outcomes: [],
            loading: true,
            selectedIncident: null,
            selectedAction: null
        };

        // ============================================================================
        // SUBSCRIPTION MANAGEMENT
        // ============================================================================
        
        async function initializeSubscription() {
            try {
                // Try to get from API
                const response = await fetch(`${API_BASE}/api/subscription/status/${CURRENT_USER_ID}`);
                
                if (response.ok) {
                    subscription = await response.json();
                } else {
                    // Create trial if doesn't exist
                    const signupRes = await fetch(`${API_BASE}/api/subscription/signup`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            user_id: CURRENT_USER_ID,
                            email: 'demo@deployr.com'
                        })
                    });
                    
                    if (signupRes.ok) {
                        subscription = await signupRes.json();
                    } else {
                        // Fallback to localStorage
                        subscription = getLocalSubscription();
                    }
                }
                
                // Check expiration
                checkSubscriptionExpiration();
                
            } catch (error) {
                console.error('Subscription init error:', error);
                subscription = getLocalSubscription();
            }
        }

        function getLocalSubscription() {
            let sub = localStorage.getItem('deployr_subscription');
            
            if (!sub) {
                const now = new Date();
                const trialEnd = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
                
                sub = {
                    user_id: CURRENT_USER_ID,
                    plan: 'pro',
                    status: 'trialing',
                    trial_start: now.toISOString(),
                    trial_end: trialEnd.toISOString(),
                    current_period_end: trialEnd.toISOString(),
                    created_at: now.toISOString()
                };
                
                localStorage.setItem('deployr_subscription', JSON.stringify(sub));
            } else {
                sub = JSON.parse(sub);
            }
            
            return sub;
        }

        function checkSubscriptionExpiration() {
            if (subscription.status === 'trialing') {
                const now = new Date();
                const trialEnd = new Date(subscription.trial_end);
                
                if (now > trialEnd) {
                    subscription.status = 'expired';
                    localStorage.setItem('deployr_subscription', JSON.stringify(subscription));
                }
            }
        }

        function getDaysRemaining() {
            if (!subscription || subscription.status !== 'trialing') return 0;
            
            const now = new Date();
            const trialEnd = new Date(subscription.trial_end);
            const diffTime = trialEnd - now;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            return Math.max(0, diffDays);
        }

        function isFeatureAllowed(feature) {
            if (!subscription) return false;
            
            const allowedFeatures = {
                'dashboard_view': ['trialing', 'active', 'expired', 'canceled'],
                'incidents_read': ['trialing', 'active', 'expired', 'canceled'],
                'auto_remediation': ['trialing', 'active'],
                'ai_reasoning': ['trialing', 'active'],
                'slack_alerts': ['trialing', 'active'],
                'autonomous_mode': ['trialing', 'active']
            };
            
            return allowedFeatures[feature]?.includes(subscription.status) || false;
        }

        function showUpgradeModal() {
            document.getElementById('upgradeModal').style.display = 'flex';
        }

        function closeUpgradeModal() {
            document.getElementById('upgradeModal').style.display = 'none';
        }

        async function handleUpgrade() {
            try {
                // Simulate payment (integrate Stripe here)
                const response = await fetch(`${API_BASE}/api/subscription/upgrade`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: CURRENT_USER_ID,
                        payment_provider_customer_id: 'cus_demo123',
                        payment_method_id: 'pm_demo123'
                    })
                });
                
                if (response.ok) {
                    subscription = await response.json();
                    localStorage.setItem('deployr_subscription', JSON.stringify(subscription));
                    closeUpgradeModal();
                    
                    // Show success message
                    showNotification('üéâ Welcome to Deployr Pro!', 'success');
                    
                    // Refresh page to enable features
                    setTimeout(() => render(), 500);
                } else {
                    showNotification('Upgrade failed. Please try again.', 'error');
                }
            } catch (error) {
                // Fallback for demo
                const now = new Date();
                const nextBilling = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000);
                
                subscription.status = 'active';
                subscription.current_period_end = nextBilling.toISOString();
                localStorage.setItem('deployr_subscription', JSON.stringify(subscription));
                
                closeUpgradeModal();
                showNotification('üéâ Upgraded to Pro! (Demo mode)', 'success');
                setTimeout(() => render(), 500);
            }
        }

        function showNotification(message, type) {
            const notif = document.createElement('div');
            notif.className = `fixed top-6 right-6 z-50 p-4 rounded-lg shadow-2xl slide-in ${
                type === 'success' ? 'bg-green-600' : 'bg-red-600'
            }`;
            notif.innerHTML = `
                <div class="flex items-center gap-3">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} text-2xl"></i>
                    <span class="font-semibold">${message}</span>
                </div>
            `;
            
            document.body.appendChild(notif);
            
            setTimeout(() => {
                notif.remove();
            }, 3000);
        }

        // ============================================================================
        // EXISTING DASHBOARD CODE (WITH SUBSCRIPTION CHECKS)
        // ============================================================================

        async function fetchAllData() {
            try {
                const [
                    statsRes, incidentsRes, anomaliesRes, servicesRes,
                    pendingRes, historyRes, learningRes,
                    autoStatusRes, safetyRes, outcomesRes
                ] = await Promise.all([
                    fetch(`${API_BASE}/api/stats`).catch(() => null),
                    fetch(`${API_BASE}/api/incidents?limit=20`).catch(() => null),
                    fetch(`${API_BASE}/api/anomalies?limit=50`).catch(() => null),
                    fetch(`${API_BASE}/api/services`).catch(() => null),
                    fetch(`${API_BASE}/api/v2/actions/pending`).catch(() => null),
                    fetch(`${API_BASE}/api/v2/actions/history?limit=30`).catch(() => null),
                    fetch(`${API_BASE}/api/v2/learning/stats`).catch(() => null),
                    fetch(`${API_BASE}/api/v3/autonomous/status`).catch(() => null),
                    fetch(`${API_BASE}/api/v3/autonomous/safety-status`).catch(() => null),
                    fetch(`${API_BASE}/api/v3/autonomous/outcomes?limit=30`).catch(() => null)
                ]);

                if (statsRes?.ok) state.stats = await statsRes.json();
                if (incidentsRes?.ok) state.incidents = (await incidentsRes.json()).incidents || [];
                if (anomaliesRes?.ok) state.anomalies = (await anomaliesRes.json()).anomalies || [];
                if (servicesRes?.ok) state.services = (await servicesRes.json()).services || [];
                if (pendingRes?.ok) state.pendingActions = (await pendingRes.json()).actions || [];
                if (historyRes?.ok) state.actionHistory = (await historyRes.json()).actions || [];
                if (learningRes?.ok) state.learningStats = await learningRes.json();
                if (autoStatusRes?.ok) state.autonomousStatus = await autoStatusRes.json();
                if (safetyRes?.ok) state.safetyStatus = await safetyRes.json();
                if (outcomesRes?.ok) {
                    const data = await outcomesRes.json();
                    state.outcomes = data.outcomes || [];
                }

                state.loading = false;
                render();
            } catch (error) {
                console.error('Error fetching data:', error);
                state.loading = false;
                renderError(error.message);
            }
        }

        function toggleAutoRefresh() {
            autoRefresh = !autoRefresh;
            if (autoRefresh) {
                refreshInterval = setInterval(fetchAllData, 10000);
            } else {
                clearInterval(refreshInterval);
            }
            render();
        }

        function switchView(view) {
            currentView = view;
            state.selectedIncident = null;
            state.selectedAction = null;
            render();
        }

        function renderError(message) {
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen flex items-center justify-center p-6">
                    <div class="card rounded-xl shadow-2xl p-8 max-w-2xl w-full">
                        <div class="text-center">
                            <i class="fas fa-exclamation-triangle text-6xl text-red-500 mb-4"></i>
                            <h2 class="text-2xl font-bold mb-4">Connection Error</h2>
                            <div class="bg-red-900/20 border border-red-600/50 rounded-lg p-4 mb-6">
                                <p class="text-sm text-red-300">${message}</p>
                            </div>
                            <button onclick="location.reload()" class="bg-primary hover:bg-primary-dark px-6 py-3 rounded-lg font-semibold transition text-black">
                                <i class="fas fa-redo mr-2"></i>Retry Connection
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function render() {
            if (state.loading) {
                document.getElementById('app').innerHTML = `
                    <div class="min-h-screen flex items-center justify-center">
                        <div class="text-center">
                            <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-primary mx-auto mb-4"></div>
                            <p class="text-gray-300">Loading Dashboard...</p>
                        </div>
                    </div>
                `;
                return;
            }

            const app = document.getElementById('app');
            app.innerHTML = `
                ${renderSubscriptionBanner()}
                ${renderHeader()}
                ${renderMainContent()}
                ${renderNotifications()}
            `;
        }

        function renderSubscriptionBanner() {
            if (!subscription) return '';
            
            const daysRemaining = getDaysRemaining();
            
            // Trial active
            if (subscription.status === 'trialing') {
                return `
                    <div class="bg-gradient-to-r from-cyan-600 to-blue-600 p-4 text-center">
                        <div class="max-w-7xl mx-auto flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-clock text-2xl"></i>
                                <span class="font-bold text-lg">
                                    ‚è≥ ${daysRemaining} ${daysRemaining === 1 ? 'Day' : 'Days'} Left in Free Trial
                                </span>
                            </div>
                            <button onclick="showUpgradeModal()" class="bg-white text-cyan-600 px-6 py-2 rounded-lg font-bold hover:bg-gray-100 transition">
                                Upgrade to Pro
                            </button>
                        </div>
                    </div>
                `;
            }
            
            // Trial expired
            if (subscription.status === 'expired') {
                return `
                    <div class="bg-red-900/90 p-4 text-center border-b-2 border-red-600">
                        <div class="max-w-7xl mx-auto flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-lock text-2xl text-red-400"></i>
                                <span class="font-bold text-lg">
                                    üîí Your trial has expired. Upgrade to continue monitoring.
                                </span>
                            </div>
                            <button onclick="showUpgradeModal()" class="bg-red-600 hover:bg-red-700 px-6 py-2 rounded-lg font-bold transition">
                                Upgrade Now
                            </button>
                        </div>
                    </div>
                `;
            }
            
            // Active subscription
            if (subscription.status === 'active') {
                return `
                    <div class="bg-green-900/30 p-3 text-center border-b border-green-600">
                        <div class="max-w-7xl mx-auto flex items-center justify-center gap-3">
                            <i class="fas fa-crown text-yellow-500"></i>
                            <span class="font-semibold">
                                Pro Plan Active - Next billing: ${new Date(subscription.current_period_end).toLocaleDateString()}
                            </span>
                        </div>
                    </div>
                `;
            }
            
            return '';
        }

        function renderHeader() {
            const pendingCount = state.pendingActions?.length || 0;
            const criticalIncidents = state.incidents?.filter(i => i.severity === 'critical').length || 0;
            const autoMode = state.autonomousStatus?.execution_mode || 'manual';
            
            // Check if premium features are locked
            const isPremiumLocked = !isFeatureAllowed('auto_remediation');
            
            return `
                <div class="card border-b sticky top-0 z-40 backdrop-blur-sm" style="background-color: rgba(42, 42, 42, 0.95);">
                    <div class="max-w-7xl mx-auto px-6 py-4">
                       <!-- Branding Section -->
                        <div class="flex items-center gap-4 mb-6">
                            <div class="flex items-center gap-4 mb-6">
                                <img src="img/deployr_logo.png" class="h-20 w-20 object-contain" />
                            </div>
                            <div>
                                <h1 class="text-3xl font-bold tracking-wide">Deployr</h1>
                                <p class="text-base text-gray-400">We watch so you don't have to.</p>
                            </div>
                            ${isPremiumLocked ? `
                                <div class="ml-auto">
                                    <button onclick="switchView('subscription')" class="bg-yellow-600 hover:bg-yellow-700 px-4 py-2 rounded-lg font-semibold flex items-center gap-2 transition">
                                        <i class="fas fa-crown"></i>
                                        View Subscription
                                    </button>
                                </div>
                            ` : ''}
                        </div>

                        <!-- Functional Controls -->
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-3">
                                ${renderModeIndicator(autoMode, isPremiumLocked)}
                            </div>
                            <div class="flex items-center gap-3">
                                <button onclick="toggleAutoRefresh()" class="${autoRefresh ? 'bg-green-600 hover:bg-green-700' : 'card hover:bg-opacity-80'} px-4 py-2 rounded-lg font-medium transition text-sm">
                                    <i class="fas ${autoRefresh ? 'fa-sync fa-spin' : 'fa-pause'} mr-2"></i>
                                    ${autoRefresh ? 'Live' : 'Paused'}
                                </button>
                                <button onclick="fetchAllData()" class="bg-primary hover:bg-primary-dark text-black px-4 py-2 rounded-lg font-medium transition text-sm">
                                    <i class="fas fa-sync mr-2"></i>Refresh
                                </button>
                            </div>
                        </div>

                        <!-- Stats Grid -->
                        <div class="grid grid-cols-4 gap-3 mb-4">
                            ${renderQuickStat('fa-exclamation-circle', 'Critical', criticalIncidents, criticalIncidents > 0 ? 'text-red-400' : 'text-gray-400')}
                            ${renderQuickStat('fa-clock', 'Pending', pendingCount, pendingCount > 0 ? 'text-orange-400' : 'text-gray-400')}
                            ${renderQuickStat('fa-check-circle', 'Success', state.outcomes.filter(o => o.success).length, 'text-green-400')}
                            ${renderQuickStat('fa-heartbeat', 'Healthy', state.stats?.healthy_services || 0, 'text-green-400')}
                        </div>

                        <!-- Navigation -->
                        <div class="flex gap-2 overflow-x-auto pb-2">
                            ${renderNavButton('control-center', 'fa-th-large', 'Control Center')}
                            ${renderNavButton('incidents', 'fa-exclamation-triangle', 'Incidents', criticalIncidents)}
                            ${renderNavButton('actions', 'fa-bolt', 'Actions', pendingCount, isPremiumLocked)}
                            ${renderNavButton('autonomous', 'fa-robot', 'Autonomous', 0, isPremiumLocked)}
                            ${renderNavButton('services', 'fa-server', 'Services')}
                            ${renderNavButton('analytics', 'fa-chart-line', 'Analytics')}
                            ${renderNavButton('subscription', 'fa-crown', 'Subscription', 0, false, true)}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderModeIndicator(mode, isLocked) {
            if (isLocked) {
                return `
                    <div class="bg-gray-700 text-gray-400 px-4 py-2 rounded-lg font-medium text-sm flex items-center gap-2">
                        <i class="fas fa-lock"></i>
                        <span class="uppercase tracking-wide">PREMIUM LOCKED</span>
                    </div>
                `;
            }

            const colors = {
                manual: 'bg-gray-700 text-gray-300',
                supervised: 'bg-blue-700 text-blue-200',
                autonomous: 'bg-green-700 text-green-200',
                night_mode: 'bg-purple-700 text-purple-200'
            };

            const icons = {
                manual: 'fa-hand-paper',
                supervised: 'fa-eye',
                autonomous: 'fa-robot',
                night_mode: 'fa-moon'
            };

            return `
                <div class="${colors[mode] || colors.manual} px-4 py-2 rounded-lg font-medium text-sm flex items-center gap-2">
                    <i class="fas ${icons[mode] || icons.manual}"></i>
                    <span class="uppercase tracking-wide">${mode.replace('_', ' ')}</span>
                </div>
            `;
        }

        function renderQuickStat(icon, label, value, colorClass) {
            return `
                <div class="card rounded-lg px-4 py-2 flex items-center gap-3">
                    <i class="fas ${icon} text-2xl ${colorClass}"></i>
                    <div>
                        <div class="text-xs text-gray-400">${label}</div>
                        <div class="text-xl font-bold ${colorClass}">${value}</div>
                    </div>
                </div>
            `;
        }

        function renderNavButton(view, icon, label, badge = 0, isLocked = false, isSpecial = false) {
            const isActive = currentView === view;
            return `
                <button onclick="switchView('${view}')" class="nav-button ${isActive ? 'active' : ''} px-6 py-3 rounded-t-lg font-medium transition relative whitespace-nowrap text-sm ${isActive ? 'text-primary' : 'text-gray-400'} ${isLocked ? 'opacity-50' : ''}">
                    <i class="fas ${icon} mr-2"></i>${label}
                    ${badge > 0 ? `<span class="absolute -top-1 -right-1 bg-orange-500 text-white text-xs px-2 py-0.5 rounded-full">${badge}</span>` : ''}
                    ${isLocked ? `<i class="fas fa-lock text-xs ml-1"></i>` : ''}
                    ${isSpecial ? `<i class="fas fa-star text-yellow-500 text-xs ml-1"></i>` : ''}
                </button>
            `;
        }

        function renderMainContent() {
            const views = {
                'control-center': renderControlCenter,
                'incidents': renderIncidentsView,
                'actions': renderActionsView,
                'autonomous': renderAutonomousView,
                'services': renderServicesView,
                'analytics': renderAnalyticsView,
                'subscription': renderSubscriptionView
            };

            const renderFunc = views[currentView] || renderControlCenter;

            return `
                <div class="max-w-7xl mx-auto px-6 py-6">
                    ${renderFunc()}
                </div>
            `;
        }

        function renderSubscriptionView() {
            if (!subscription) return '<div class="text-center">Loading subscription...</div>';
            
            const daysRemaining = getDaysRemaining();
            const isTrialing = subscription.status === 'trialing';
            const isActive = subscription.status === 'active';
            const isExpired = subscription.status === 'expired';
            
            return `
                <div class="space-y-6">
                    <h2 class="text-3xl font-bold mb-6 flex items-center gap-3">
                        <i class="fas fa-crown text-yellow-500"></i>
                        Subscription Management
                    </h2>

                    <!-- Current Status Card -->
                    <div class="card rounded-xl p-8 ${
                        isActive ? 'border-2 border-green-600' :
                        isTrialing ? 'border-2 border-cyan-600' :
                        'border-2 border-red-600'
                    }">
                        <div class="flex items-start justify-between mb-6">
                            <div>
                                <div class="flex items-center gap-3 mb-2">
                                    <i class="fas ${
                                        isActive ? 'fa-check-circle text-green-500' :
                                        isTrialing ? 'fa-clock text-cyan-500' :
                                        'fa-lock text-red-500'
                                    } text-3xl"></i>
                                    <h3 class="text-2xl font-bold capitalize">${subscription.status} ${isActive ? 'Pro' : isTrialing ? 'Trial' : ''} Plan</h3>
                                </div>
                                <p class="text-gray-400">
                                    ${isTrialing ? `${daysRemaining} days remaining in your trial` :
                                      isActive ? `Next billing: ${new Date(subscription.current_period_end).toLocaleDateString()}` :
                                      'Your trial has ended'}
                                </p>
                            </div>
                            ${!isActive ? `
                                <button onclick="showUpgradeModal()" class="bg-primary hover:bg-primary-dark text-black px-6 py-3 rounded-lg font-bold transition">
                                    <i class="fas fa-arrow-up mr-2"></i>Upgrade Now
                                </button>
                            ` : ''}
                        </div>

                        <div class="grid grid-cols-3 gap-4 mb-6">
                            <div class="bg-black bg-opacity-50 rounded-lg p-4">
                                <div class="text-sm text-gray-400 mb-1">Status</div>
                                <div class="text-xl font-bold capitalize">${subscription.status}</div>
                            </div>
                            <div class="bg-black bg-opacity-50 rounded-lg p-4">
                                <div class="text-sm text-gray-400 mb-1">Plan</div>
                                <div class="text-xl font-bold">Pro</div>
                            </div>
                            <div class="bg-black bg-opacity-50 rounded-lg p-4">
                                <div class="text-sm text-gray-400 mb-1">Started</div>
                                <div class="text-xl font-bold">${new Date(subscription.created_at).toLocaleDateString()}</div>
                            </div>
                        </div>

                        ${isExpired ? `
                            <div class="bg-red-900/20 border border-red-600/50 rounded-lg p-4">
                                <div class="flex items-start gap-3">
                                    <i class="fas fa-exclamation-circle text-red-500 text-xl mt-1"></i>
                                    <div>
                                        <div class="font-bold mb-1">Premium Features Paused</div>
                                        <p class="text-sm text-gray-300">
                                            Your AI monitoring, auto-remediation, and alerts are currently disabled. 
                                            Dashboard and incident history remain accessible.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                    </div>

                    <!-- Feature Access Matrix -->
                    <div class="card rounded-xl p-6">
                        <h3 class="text-xl font-bold mb-4">
                            <i class="fas fa-list-check text-primary mr-2"></i>Feature Access
                        </h3>
                        
                        <div class="space-y-3">
                            ${renderFeatureRow('Dashboard & Incident History', true, 'Always available')}
                            ${renderFeatureRow('AI Anomaly Detection', !isExpired, isExpired ? 'Requires active subscription' : 'Enabled')}
                            ${renderFeatureRow('Auto-Remediation Actions', !isExpired, isExpired ? 'Requires active subscription' : 'Enabled')}
                            ${renderFeatureRow('AI Root Cause Analysis', !isExpired, isExpired ? 'Requires active subscription' : 'Enabled')}
                            ${renderFeatureRow('Slack Alerts', !isExpired, isExpired ? 'Requires active subscription' : 'Enabled')}
                            ${renderFeatureRow('Autonomous Mode (Phase 3)', !isExpired, isExpired ? 'Requires active subscription' : 'Enabled')}
                            ${renderFeatureRow('Learning & Pattern Recognition', !isExpired, isExpired ? 'Requires active subscription' : 'Enabled')}
                        </div>
                    </div>

                    <!-- Pricing Info -->
                    ${!isActive ? `
                        <div class="card rounded-xl p-6 border-2 border-primary">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <h3 class="text-2xl font-bold mb-2">Deployr Pro</h3>
                                    <div class="text-4xl font-bold mb-4 text-primary">$99<span class="text-lg text-gray-400">/month</span></div>
                                    
                                    <div class="grid grid-cols-2 gap-4 mb-6">
                                        <div class="flex items-start gap-2">
                                            <i class="fas fa-check text-green-500 mt-1"></i>
                                            <div>
                                                <div class="font-semibold">Unlimited Monitoring</div>
                                                <div class="text-sm text-gray-400">Monitor all your services</div>
                                            </div>
                                        </div>
                                        <div class="flex items-start gap-2">
                                            <i class="fas fa-check text-green-500 mt-1"></i>
                                            <div>
                                                <div class="font-semibold">AI-Powered Analysis</div>
                                                <div class="text-sm text-gray-400">Root cause detection</div>
                                            </div>
                                        </div>
                                        <div class="flex items-start gap-2">
                                            <i class="fas fa-check text-green-500 mt-1"></i>
                                            <div>
                                                <div class="font-semibold">Auto-Remediation</div>
                                                <div class="text-sm text-gray-400">Automatic fixes</div>
                                            </div>
                                        </div>
                                        <div class="flex items-start gap-2">
                                            <i class="fas fa-check text-green-500 mt-1"></i>
                                            <div>
                                                <div class="font-semibold">24/7 Alerts</div>
                                                <div class="text-sm text-gray-400">Slack notifications</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <button onclick="showUpgradeModal()" class="bg-primary hover:bg-primary-dark text-black px-8 py-4 rounded-lg font-bold text-lg transition">
                                        <i class="fas fa-rocket mr-2"></i>Upgrade to Pro
                                    </button>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderFeatureRow(name, allowed, status) {
            return `
                <div class="flex items-center justify-between p-3 bg-black bg-opacity-30 rounded-lg">
                    <div class="flex items-center gap-3">
                        <i class="fas ${allowed ? 'fa-check-circle text-green-500' : 'fa-lock text-red-500'}"></i>
                        <span class="${allowed ? '' : 'text-gray-500'}">${name}</span>
                    </div>
                    <span class="text-sm ${allowed ? 'text-green-400' : 'text-red-400'}">${status}</span>
                </div>
            `;
        }

        // Continuing with existing render functions...
        function renderControlCenter() {
            const critical = state.incidents.filter(i => i.severity === 'critical').length;
            const pending = state.pendingActions.length;
            const autoSuccess = state.outcomes.filter(o => o.success).length;
            const autoTotal = state.outcomes.length;
            const successRate = autoTotal > 0 ? ((autoSuccess / autoTotal) * 100).toFixed(1) : 0;
            const isPremiumLocked = !isFeatureAllowed('auto_remediation');

            return `
                <div class="space-y-6">
                    ${isPremiumLocked ? `
                        <div class="bg-orange-900/20 border-2 border-orange-600 rounded-xl p-6">
                            <div class="flex items-start gap-4">
                                <i class="fas fa-exclamation-triangle text-orange-500 text-3xl"></i>
                                <div class="flex-1">
                                    <h3 class="text-xl font-bold mb-2">Premium Features Locked</h3>
                                    <p class="text-gray-300 mb-4">
                                        Your trial has ended. Upgrade to Pro to restore AI monitoring, auto-remediation, and real-time alerts.
                                    </p>
                                    <button onclick="showUpgradeModal()" class="bg-orange-600 hover:bg-orange-700 px-6 py-3 rounded-lg font-bold transition">
                                        <i class="fas fa-crown mr-2"></i>Upgrade Now
                                    </button>
                                </div>
                            </div>
                        </div>
                    ` : ''}

                    <div class="card rounded-xl p-6 shadow-xl">
                        <h2 class="text-2xl font-bold mb-6 flex items-center gap-3">
                            <i class="fas fa-th-large text-primary"></i>
                            System Health Overview
                        </h2>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="bg-black bg-opacity-30 rounded-lg p-6 border-l-4 border-blue-500">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="font-bold text-lg">Phase 1: Detection</h3>
                                    <span class="bg-blue-900/50 text-blue-300 px-3 py-1 rounded-full text-xs font-bold">ACTIVE</span>
                                </div>
                                <div class="space-y-3">
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-400">Critical Incidents</span>
                                        <span class="text-2xl font-bold ${critical > 0 ? 'text-red-400' : 'text-green-400'}">${critical}</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-400">Anomalies (24h)</span>
                                        <span class="text-2xl font-bold text-orange-400">${state.anomalies.length}</span>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-black bg-opacity-30 rounded-lg p-6 border-l-4 border-purple-500 ${isPremiumLocked ? 'opacity-50' : ''}">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="font-bold text-lg">Phase 2: Supervised</h3>
                                    <span class="bg-purple-900/50 text-purple-300 px-3 py-1 rounded-full text-xs font-bold">
                                        ${isPremiumLocked ? 'LOCKED' : 'ACTIVE'}
                                    </span>
                                </div>
                                <div class="space-y-3">
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-400">Pending Approval</span>
                                        <span class="text-2xl font-bold ${isPremiumLocked ? 'text-gray-600' : pending > 0 ? 'text-orange-400' : 'text-gray-400'}">${isPremiumLocked ? '‚Äî' : pending}</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-400">Actions Learned</span>
                                        <span class="text-2xl font-bold text-purple-400">${state.learningStats.total_actions_recorded || 0}</span>
                                    </div>
                                </div>
                                ${isPremiumLocked ? '<div class="absolute inset-0 flex items-center justify-center"><i class="fas fa-lock text-4xl text-gray-700"></i></div>' : ''}
                            </div>

                            <div class="bg-black bg-opacity-30 rounded-lg p-6 border-l-4 border-green-500 ${isPremiumLocked ? 'opacity-50' : ''}">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="font-bold text-lg">Phase 3: Autonomous</h3>
                                    <span class="bg-green-900/50 text-green-300 px-3 py-1 rounded-full text-xs font-bold">
                                        ${isPremiumLocked ? 'LOCKED' : state.autonomousStatus?.autonomous_enabled ? 'ENABLED' : 'DISABLED'}
                                    </span>
                                </div>
                                <div class="space-y-3">
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-400">Success Rate</span>
                                        <span class="text-2xl font-bold ${isPremiumLocked ? 'text-gray-600' : 'text-green-400'}">${isPremiumLocked ? '‚Äî' : successRate}%</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-400">Auto Executed</span>
                                        <span class="text-2xl font-bold text-green-400">${isPremiumLocked ? '‚Äî' : autoSuccess}</span>
                                    </div>
                                </div>
                                ${isPremiumLocked ? '<div class="absolute inset-0 flex items-center justify-center"><i class="fas fa-lock text-4xl text-gray-700"></i></div>' : ''}
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        ${renderRecentIncidents()}
                        ${renderRecentActions()}
                    </div>
                </div>
            `;
        }

        function renderRecentIncidents() {
            const recent = state.incidents.slice(0, 5);
            return `
                <div class="card rounded-xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold">
                            <i class="fas fa-exclamation-triangle text-primary mr-2"></i>Recent Incidents
                        </h3>
                        <button onclick="switchView('incidents')" class="text-sm text-primary hover:text-primary-light">
                            View All <i class="fas fa-arrow-right ml-1"></i>
                        </button>
                    </div>
                    
                    ${recent.length > 0 ? `
                        <div class="space-y-2">
                            ${recent.map(inc => `
                                <div class="bg-black bg-opacity-30 rounded-lg p-3 hover:bg-opacity-40 transition cursor-pointer">
                                    <div class="flex items-center justify-between mb-1">
                                        <span class="font-semibold">
                                            <i class="fas fa-server text-primary mr-2"></i>${inc.service}
                                        </span>
                                        <span class="px-2 py-1 rounded text-xs font-bold ${getSeverityClass(inc.severity)}">
                                            ${inc.severity}
                                        </span>
                                    </div>
                                    <div class="text-sm text-gray-400 truncate">${inc.root_cause}</div>
                                </div>
                            `).join('')}
                        </div>
                    ` : '<div class="text-center py-8 text-gray-500"><i class="fas fa-check-circle text-4xl text-green-500 mb-2"></i><br>No recent incidents</div>'}
                </div>
            `;
        }

        function renderRecentActions() {
            const recent = state.actionHistory.slice(0, 5);
            const isPremiumLocked = !isFeatureAllowed('auto_remediation');
            
            return `
                <div class="card rounded-xl p-6 ${isPremiumLocked ? 'opacity-50' : ''}">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold">
                            <i class="fas fa-bolt text-primary mr-2"></i>Recent Actions
                            ${isPremiumLocked ? '<i class="fas fa-lock text-sm ml-2 text-red-500"></i>' : ''}
                        </h3>
                    </div>
                    
                    ${isPremiumLocked ? `
                        <div class="text-center py-8">
                            <i class="fas fa-lock text-4xl text-red-500 mb-4"></i>
                            <p class="text-gray-400 mb-4">Premium feature locked</p>
                            <button onclick="showUpgradeModal()" class="bg-primary hover:bg-primary-dark text-black px-4 py-2 rounded-lg font-semibold transition">
                                Upgrade to Access
                            </button>
                        </div>
                    ` : recent.length > 0 ? `
                        <div class="space-y-2">
                            ${recent.map(action => `
                                <div class="bg-black bg-opacity-30 rounded-lg p-3">
                                    <div class="flex items-center justify-between mb-1">
                                        <span class="font-semibold">
                                            <i class="fas fa-cog text-primary mr-2"></i>${action.action_type}
                                        </span>
                                        <span class="px-2 py-1 rounded text-xs font-bold ${getStatusClass(action.status)}">
                                            ${action.status}
                                        </span>
                                    </div>
                                    <div class="text-sm text-gray-400">${action.service}</div>
                                </div>
                            `).join('')}
                        </div>
                    ` : '<div class="text-center py-8 text-gray-500">No recent actions</div>'}
                </div>
            `;
        }

        // Stub render functions for other views
        function renderIncidentsView() {
            return `
                <div class="space-y-6">
                    <div class="flex items-center justify-between">
                        <h2 class="text-2xl font-bold">
                            <i class="fas fa-exclamation-triangle text-primary mr-2"></i>Incident Management
                        </h2>
                        <div class="flex gap-2">
                            <button class="card hover:bg-opacity-80 px-4 py-2 rounded-lg text-sm">
                                <i class="fas fa-filter mr-2"></i>Filter
                            </button>
                            <button class="card hover:bg-opacity-80 px-4 py-2 rounded-lg text-sm">
                                <i class="fas fa-download mr-2"></i>Export
                            </button>
                        </div>
                    </div>

                    ${state.incidents.length > 0 ? `
                        <div class="space-y-3">
                            ${state.incidents.map(inc => `
                                <div class="card rounded-xl p-6 border-l-4 ${inc.severity === 'critical' ? 'border-red-500' : inc.severity === 'high' ? 'border-orange-500' : 'border-yellow-500'} hover:shadow-xl transition">
                                    <div class="flex items-start justify-between mb-4">
                                        <div class="flex-1">
                                            <div class="flex items-center gap-3 mb-2">
                                                <i class="fas ${inc.severity === 'critical' ? 'fa-exclamation-circle text-red-500' : 'fa-exclamation-triangle text-orange-500'} text-2xl"></i>
                                                <div>
                                                    <h3 class="font-bold text-lg">${inc.service}</h3>
                                                    <div class="text-sm text-gray-400">
                                                        <i class="fas fa-clock mr-1"></i>${new Date(inc.timestamp).toLocaleString()}
                                                    </div>
                                                </div>
                                            </div>
                                            <p class="text-gray-300 mb-3">${inc.root_cause}</p>
                                            <div class="flex gap-4 text-sm">
                                                <span class="text-gray-400">
                                                    <i class="fas fa-chart-line mr-1"></i>${inc.anomaly_count} anomalies
                                                </span>
                                                <span class="text-gray-400">
                                                    <i class="fas fa-percent mr-1"></i>${inc.confidence} percent confidence
                                                </span>
                                                <span class="text-gray-400">
                                                    <i class="fas fa-users mr-1"></i>${inc.customer_impact}
                                                </span>
                                            </div>
                                        </div>
                                        <span class="px-3 py-1 rounded-full text-xs font-bold ${getSeverityClass(inc.severity)}">
                                            ${inc.severity.toUpperCase()}
                                        </span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : `
                        <div class="card rounded-xl p-12 text-center">
                            <i class="fas fa-check-circle text-6xl text-green-500 mb-4"></i>
                            <p class="text-xl font-semibold mb-2">No Active Incidents</p>
                            <p class="text-gray-400">All systems operating normally</p>
                        </div>
                    `}
                </div>
            `;
        }
        
        function renderActionsView() { 
            const isPremiumLocked = !isFeatureAllowed('auto_remediation');
            if (isPremiumLocked) {
                return `
                    <div class="text-center py-20">
                        <i class="fas fa-lock text-6xl text-red-500 mb-6"></i>
                        <h2 class="text-3xl font-bold mb-4">Premium Feature</h2>
                        <p class="text-gray-400 mb-6 max-w-md mx-auto">
                            Action management requires an active subscription. Upgrade to access AI-powered auto-remediation.
                        </p>
                        <button onclick="showUpgradeModal()" class="bg-primary hover:bg-primary-dark text-black px-8 py-4 rounded-lg font-bold text-lg transition">
                            <i class="fas fa-arrow-up mr-2"></i>Upgrade Now
                        </button>
                    </div>
                `;
            }
            
            return `
                <div class="space-y-6">
                    <h2 class="text-2xl font-bold">
                        <i class="fas fa-bolt text-primary mr-2"></i>Action Management
                    </h2>

                    ${state.pendingActions.length > 0 ? `
                        <div class="bg-orange-900/20 border-2 border-orange-600/50 rounded-xl p-6">
                            <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                                <i class="fas fa-clock text-orange-400"></i>
                                Pending Approval (${state.pendingActions.length})
                            </h3>
                            <div class="space-y-4">
                                ${state.pendingActions.map(action => `
                                    <div class="card rounded-lg p-5 border-l-4 ${action.risk === 'low' ? 'border-green-500' : action.risk === 'high' ? 'border-red-500' : 'border-orange-500'}">
                                        <div class="flex items-start justify-between mb-3">
                                            <div class="flex-1">
                                                <div class="flex items-center gap-3 mb-2">
                                                    <h4 class="text-lg font-bold">${action.action_type.replace(/_/g, ' ').toUpperCase()}</h4>
                                                    <span class="px-2 py-1 rounded-full text-xs font-bold ${getRiskClass(action.risk)}">
                                                        <i class="fas fa-shield-alt mr-1"></i>${action.risk.toUpperCase()} RISK
                                                    </span>
                                                </div>
                                                <div class="text-sm text-gray-400 mb-2">
                                                    <i class="fas fa-server mr-1"></i>${action.service}
                                                </div>
                                                <div class="bg-black bg-opacity-30 rounded p-3 mb-3">
                                                    <div class="text-sm font-semibold mb-1">Reasoning:</div>
                                                    <div class="text-sm text-gray-300">${action.reasoning}</div>
                                                </div>
                                            </div>
                                            <div class="flex gap-2 ml-4">
                                                <button onclick="approveAction('${action.id}')" class="bg-green-600 hover:bg-green-700 px-6 py-3 rounded-lg font-bold transition">
                                                    <i class="fas fa-check mr-2"></i>Approve
                                                </button>
                                                <button class="bg-red-600 hover:bg-red-700 px-6 py-3 rounded-lg font-bold transition">
                                                    <i class="fas fa-times mr-2"></i>Reject
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : `
                        <div class="card rounded-xl p-12 text-center">
                            <i class="fas fa-check-circle text-6xl text-green-500 mb-4"></i>
                            <p class="text-xl font-semibold mb-2">No Pending Actions</p>
                            <p class="text-gray-400">All actions have been processed</p>
                        </div>
                    `}

                    <div class="card rounded-xl p-6">
                        <h3 class="text-xl font-bold mb-4">
                            <i class="fas fa-history text-primary mr-2"></i>Action History
                        </h3>
                        ${state.actionHistory.length > 0 ? `
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-black bg-opacity-30 border-b" style="border-color: var(--border);">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-bold">Action</th>
                                            <th class="px-4 py-3 text-left text-xs font-bold">Service</th>
                                            <th class="px-4 py-3 text-left text-xs font-bold">Status</th>
                                            <th class="px-4 py-3 text-left text-xs font-bold">Risk</th>
                                            <th class="px-4 py-3 text-left text-xs font-bold">Time</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y" style="border-color: var(--border);">
                                        ${state.actionHistory.map(action => `
                                            <tr class="hover:bg-black hover:bg-opacity-20 transition">
                                                <td class="px-4 py-3 font-semibold">${action.action_type}</td>
                                                <td class="px-4 py-3 text-sm">${action.service}</td>
                                                <td class="px-4 py-3">
                                                    <span class="px-2 py-1 rounded text-xs font-bold ${getStatusClass(action.status)}">
                                                        ${action.status}
                                                    </span>
                                                </td>
                                                <td class="px-4 py-3">
                                                    <span class="px-2 py-1 rounded text-xs font-bold ${getRiskClass(action.risk)}">
                                                        ${action.risk}
                                                    </span>
                                                </td>
                                                <td class="px-4 py-3 text-sm text-gray-400">${new Date(action.proposed_at).toLocaleString()}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : '<div class="text-center py-8 text-gray-500">No action history</div>'}
                    </div>
                </div>
            `;
        }
        
        function renderAutonomousView() { 
            const isPremiumLocked = !isFeatureAllowed('autonomous_mode');
            if (isPremiumLocked) {
                return `
                    <div class="text-center py-20">
                        <i class="fas fa-robot text-6xl text-red-500 mb-6"></i>
                        <h2 class="text-3xl font-bold mb-4">Autonomous Mode Locked</h2>
                        <p class="text-gray-400 mb-6 max-w-md mx-auto">
                            Autonomous execution requires an active Pro subscription. Let AI handle incidents automatically.
                        </p>
                        <button onclick="showUpgradeModal()" class="bg-primary hover:bg-primary-dark text-black px-8 py-4 rounded-lg font-bold text-lg transition">
                            <i class="fas fa-arrow-up mr-2"></i>Upgrade to Pro
                        </button>
                    </div>
                `;
            }
            
            const status = state.autonomousStatus || {};
            const safety = state.safetyStatus || {};
            const outcomes = state.outcomes || [];
            const stats = outcomes.reduce((acc, o) => {
                acc.total++;
                if (o.success) acc.successes++;
                return acc;
            }, { total: 0, successes: 0 });
            stats.success_rate = stats.total > 0 ? (stats.successes / stats.total * 100).toFixed(1) : 0;

            return `
                <div class="space-y-6">
                    <h2 class="text-2xl font-bold">
                        <i class="fas fa-robot text-primary mr-2"></i>Autonomous Execution Control
                    </h2>

                    <div class="card rounded-xl p-6">
                        <h3 class="text-xl font-bold mb-4">Execution Mode</h3>
                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                            ${['manual', 'supervised', 'autonomous', 'night_mode'].map(mode => `
                                <button class="p-6 rounded-lg border-2 transition ${status.execution_mode === mode ? 'border-primary bg-primary bg-opacity-10' : 'border-gray-700 hover:border-gray-600'} text-left">
                                    <div class="text-3xl mb-2">
                                        <i class="fas ${{ manual: 'fa-hand-paper', supervised: 'fa-eye', autonomous: 'fa-robot', night_mode: 'fa-moon' }[mode]} text-primary"></i>
                                    </div>
                                    <div class="font-bold mb-1">${mode.replace('_', ' ').toUpperCase()}</div>
                                    <div class="text-xs text-gray-400">
                                        ${{
                    manual: 'All actions require approval',
                    supervised: 'Low-risk auto-approved',
                    autonomous: 'High-confidence auto-exec',
                    night_mode: 'Auto during off-hours'
                }[mode]}
                                    </div>
                                </button>
                            `).join('')}
                        </div>
                    </div>

                    <div class="card rounded-xl p-6">
                        <h3 class="text-xl font-bold mb-4">
                            <i class="fas fa-chart-line text-primary mr-2"></i>Autonomous Performance
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-green-900/20 rounded-lg p-6 border border-green-700/50">
                                <div class="text-sm text-gray-400 mb-2">
                                    <i class="fas fa-check-circle mr-1"></i>Success Rate
                                </div>
                                <div class="text-4xl font-bold text-green-400">${stats.success_rate} percent</div>
                                <div class="text-sm text-gray-500 mt-1">${stats.successes} of ${stats.total} actions</div>
                            </div>
                            <div class="bg-blue-900/20 rounded-lg p-6 border border-blue-700/50">
                                <div class="text-sm text-gray-400 mb-2">
                                    <i class="fas fa-bolt mr-1"></i>Total Executed
                                </div>
                                <div class="text-4xl font-bold text-primary">${stats.total}</div>
                            </div>
                            <div class="bg-purple-900/20 rounded-lg p-6 border border-purple-700/50">
                                <div class="text-sm text-gray-400 mb-2">
                                    <i class="fas fa-percentage mr-1"></i>Avg Confidence
                                </div>
                                <div class="text-4xl font-bold text-purple-400">${status.confidence_threshold || 75} percent</div>
                            </div>
                        </div>
                    </div>

                    <div class="card rounded-xl p-6">
                        <h3 class="text-xl font-bold mb-4">
                            <i class="fas fa-history text-primary mr-2"></i>Recent Autonomous Actions
                        </h3>
                        ${outcomes.length > 0 ? `
                            <div class="space-y-2">
                                ${outcomes.slice(0, 10).map(outcome => `
                                    <div class="p-4 rounded-lg border-l-4 ${outcome.success ? 'bg-green-900/20 border-green-500' : 'bg-red-900/20 border-red-500'}">
                                        <div class="flex items-center justify-between">
                                            <div class="flex-1">
                                                <div class="flex items-center gap-2 mb-1">
                                                    <i class="fas ${outcome.success ? 'fa-check-circle text-green-400' : 'fa-times-circle text-red-400'}"></i>
                                                    <span class="font-bold">${outcome.action_type}</span>
                                                    <span class="text-gray-400 text-sm">
                                                        <i class="fas fa-percentage mr-1"></i>Confidence: ${outcome.confidence} percent
                                                    </span>
                                                </div>
                                                <div class="text-sm text-gray-400">
                                                    <i class="fas fa-clock mr-1"></i>${new Date(outcome.timestamp).toLocaleString()}
                                                </div>
                                            </div>
                                            <div class="text-lg font-bold ${outcome.success ? 'text-green-400' : 'text-red-400'}">
                                                ${outcome.success ? 'SUCCESS' : 'FAILED'}
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<div class="text-center py-8 text-gray-500"><i class="fas fa-info-circle text-4xl text-gray-600 mb-2"></i><br>No autonomous actions yet</div>'}
                    </div>
                </div>
            `;
        }
        
        function renderServicesView() {
            return `
                <div class="space-y-6">
                    <h2 class="text-2xl font-bold">
                        <i class="fas fa-server text-primary mr-2"></i>Service Health Dashboard
                    </h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${state.services.map(service => `
                            <div class="card rounded-xl p-6 border-l-4 ${service.status === 'healthy' ? 'border-green-500' : 'border-orange-500'} hover:shadow-xl transition">
                                <div class="flex items-center justify-between mb-4">
                                    <div>
                                        <h3 class="font-bold text-lg">${service.name}</h3>
                                        <div class="flex items-center gap-2 mt-1">
                                            <div class="w-2 h-2 rounded-full ${service.status === 'healthy' ? 'bg-green-500 animate-pulse' : 'bg-orange-500'}"></div>
                                            <span class="text-sm text-gray-400">${service.status}</span>
                                        </div>
                                    </div>
                                    <i class="fas ${service.status === 'healthy' ? 'fa-check-circle text-green-500' : 'fa-exclamation-triangle text-orange-500'} text-3xl"></i>
                                </div>

                                ${service.metrics ? `
                                    <div class="grid grid-cols-2 gap-3 mb-4">
                                        ${service.metrics.latency_ms ? `
                                            <div class="bg-blue-900/30 rounded-lg p-3 border border-blue-700/50">
                                                <div class="text-xs text-gray-400">
                                                    <i class="fas fa-tachometer-alt mr-1"></i>Latency
                                                </div>
                                                <div class="text-lg font-bold">${service.metrics.latency_ms}ms</div>
                                            </div>
                                        ` : ''}
                                        ${service.metrics.error_rate_percent !== undefined ? `
                                            <div class="bg-red-900/30 rounded-lg p-3 border border-red-700/50">
                                                <div class="text-xs text-gray-400">
                                                    <i class="fas fa-exclamation-triangle mr-1"></i>Error Rate
                                                </div>
                                                <div class="text-lg font-bold">${service.metrics.error_rate_percent} percent</div>
                                            </div>
                                        ` : ''}
                                    </div>
                                ` : ''}

                                <div class="flex justify-between text-sm text-gray-400 pt-3" style="border-top: 1px solid var(--border);">
                                    <span><i class="fas fa-chart-line mr-1"></i>${service.anomaly_count} anomalies</span>
                                    <span><i class="fas fa-exclamation-circle mr-1"></i>${service.incident_count} incidents</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        function renderAnalyticsView() {
            const totalIncidents = state.incidents.length;
            const criticalIncidents = state.incidents.filter(i => i.severity === 'critical').length;
            const avgConfidence = state.incidents.length > 0
                ? state.incidents.reduce((sum, i) => sum + (i.confidence || 0), 0) / state.incidents.length
                : 0;

            return `
                <div class="space-y-6">
                    <h2 class="text-2xl font-bold">
                        <i class="fas fa-chart-line text-primary mr-2"></i>Analytics and Insights
                    </h2>

                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="bg-gradient-to-br from-blue-600 to-blue-700 rounded-xl p-6 text-white">
                            <div class="text-sm opacity-90 mb-2">
                                <i class="fas fa-exclamation-triangle mr-1"></i>Total Incidents
                            </div>
                            <div class="text-4xl font-bold">${totalIncidents}</div>
                        </div>
                        <div class="bg-gradient-to-br from-red-600 to-red-700 rounded-xl p-6 text-white">
                            <div class="text-sm opacity-90 mb-2">
                                <i class="fas fa-exclamation-circle mr-1"></i>Critical
                            </div>
                            <div class="text-4xl font-bold">${criticalIncidents}</div>
                        </div>
                        <div class="bg-gradient-to-br from-green-600 to-green-700 rounded-xl p-6 text-white">
                            <div class="text-sm opacity-90 mb-2">
                                <i class="fas fa-percentage mr-1"></i>Avg Confidence
                            </div>
                            <div class="text-4xl font-bold">${avgConfidence.toFixed(0)}%</div>
                        </div>
                        <div style="background: linear-gradient(135deg, var(--primary), var(--primary-dark));" class="rounded-xl p-6 text-black">
                            <div class="text-sm opacity-90 mb-2">
                                <i class="fas fa-chart-line mr-1"></i>Anomalies
                            </div>
                            <div class="text-4xl font-bold">${state.anomalies.length}</div>
                        </div>
                    </div>

                    <div class="card rounded-xl p-6">
                        <h3 class="text-xl font-bold mb-4">
                            <i class="fas fa-brain text-primary mr-2"></i>Learning Progress
                        </h3>
                        <div class="space-y-4">
                            <div>
                                <div class="flex justify-between mb-2">
                                    <span>
                                        <i class="fas fa-database mr-1 text-primary"></i>Incidents Analyzed
                                    </span>
                                    <span class="font-bold">${state.learningStats.total_incidents_learned || 0}</span>
                                </div>
                                <div class="w-full bg-gray-700 rounded-full h-2">
                                    <div class="h-2 rounded-full" style="width: ${Math.min((state.learningStats.total_incidents_learned || 0) * 2, 100)}%; background-color: var(--primary);"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between mb-2">
                                    <span>
                                        <i class="fas fa-cog mr-1 text-primary"></i>Actions Recorded
                                    </span>
                                    <span class="font-bold">${state.learningStats.total_actions_recorded || 0}</span>
                                </div>
                                <div class="w-full bg-gray-700 rounded-full h-2">
                                    <div class="h-2 rounded-full" style="width: ${Math.min((state.learningStats.total_actions_recorded || 0) * 3, 100)}%; background-color: var(--primary);"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card rounded-xl p-6">
                        <h3 class="text-xl font-bold mb-4">
                            <i class="fas fa-heartbeat text-primary mr-2"></i>Service Health Distribution
                        </h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            ${renderHealthMetric('Healthy', state.services.filter(s => s.status === 'healthy').length, 'green')}
                            ${renderHealthMetric('Degraded', state.services.filter(s => s.status === 'degraded').length, 'orange')}
                            ${renderHealthMetric('Critical', state.services.filter(s => s.status === 'critical').length, 'red')}
                            ${renderHealthMetric('Total', state.services.length, 'primary')}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderHealthMetric(label, value, colorClass) {
            const colorMap = {
                'green': 'bg-green-600',
                'orange': 'bg-orange-600',
                'red': 'bg-red-600',
                'primary': 'bg-primary'
            };
            
            const textColorMap = {
                'green': 'text-green-400',
                'orange': 'text-orange-400',
                'red': 'text-red-400',
                'primary': 'text-primary'
            };
            
            return `
                <div class="card rounded-lg p-4">
                    <div class="text-sm text-gray-400 mb-2">${label}</div>
                    <div class="text-3xl font-bold ${textColorMap[colorClass] || 'text-primary'}">${value}</div>
                    <div class="w-full ${colorMap[colorClass] || 'bg-primary'} h-1 rounded-full mt-2"></div>
                </div>
            `;
        }
        
        function getRiskClass(risk) {
            const classes = {
                low: 'bg-green-900/50 text-green-300',
                medium: 'bg-orange-900/50 text-orange-300',
                high: 'bg-red-900/50 text-red-300'
            };
            return classes[risk] || classes.medium;
        }
        
         function renderNotifications() {
            const criticalIncidents = state.incidents.filter(i => i.severity === 'critical').length;
            const urgentActions = state.pendingActions.filter(a => a.risk === 'high').length;

            if (criticalIncidents === 0 && urgentActions === 0) return '';

            return `
                <div class="fixed bottom-6 right-6 space-y-3 max-w-md z-50">
                    ${criticalIncidents > 0 ? `
                        <div class="bg-red-900 border-2 border-red-600 rounded-lg p-4 shadow-2xl slide-in">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-exclamation-circle text-3xl text-red-400 animate-pulse"></i>
                                <div>
                                    <div class="font-bold">Critical Alert</div>
                                    <div class="text-sm">${criticalIncidents} critical incident${criticalIncidents > 1 ? 's' : ''} detected</div>
                                </div>
                                <button onclick="switchView('incidents')" class="ml-auto bg-red-700 hover:bg-red-600 px-3 py-1 rounded text-sm font-bold">
                                    View
                                </button>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${urgentActions > 0 ? `
                        <div class="bg-orange-900 border-2 border-orange-600 rounded-lg p-4 shadow-2xl slide-in">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-bolt text-3xl text-orange-400 animate-pulse"></i>
                                <div>
                                    <div class="font-bold">Action Required</div>
                                    <div class="text-sm">${urgentActions} high-risk action${urgentActions > 1 ? 's' : ''} pending</div>
                                </div>
                                <button onclick="switchView('actions')" class="ml-auto bg-orange-700 hover:bg-orange-600 px-3 py-1 rounded text-sm font-bold">
                                    Review
                                </button>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // Helper functions
        function getSeverityClass(severity) {
            const classes = {
                critical: 'bg-red-900/50 text-red-300',
                high: 'bg-orange-900/50 text-orange-300',
                medium: 'bg-yellow-900/50 text-yellow-300',
                low: 'bg-blue-900/50 text-blue-300'
            };
            return classes[severity] || classes.medium;
        }

        function getStatusClass(status) {
            const classes = {
                pending: 'bg-yellow-900/50 text-yellow-300',
                approved: 'bg-blue-900/50 text-blue-300',
                success: 'bg-green-900/50 text-green-300',
                failed: 'bg-red-900/50 text-red-300'
            };
            return classes[status] || classes.pending;
        }

        async function approveAction(actionId) {
            if (!confirm('Approve this action for execution?')) return;

            try {
                const response = await fetch(`${API_BASE}/api/v2/actions/approve`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action_id: actionId,
                        approved_by: 'dashboard_user',
                        notes: 'Approved via Deployr dashboard'
                    })
                });

                if (response.ok) {
                    showNotification('Action approved successfully', 'success');
                    fetchAllData();
                } else {
                    showNotification('Failed to approve action', 'error');
                }
            } catch (error) {
                showNotification('Error: ' + error.message, 'error');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await initializeSubscription();
            await fetchAllData();
        });
    </script>
</body>

</html>