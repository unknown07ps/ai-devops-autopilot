<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deployr - ‚ÄúFix the oops. Without Ops.‚Äù</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Lucide Icons - Modern minimal icons like ChatGPT -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* ============================================
           DEPLOYR PROFESSIONAL DEVOPS UI - GLOWY THEME
           ============================================ */

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
            }

            to {
                transform: translateX(0);
            }
        }

        @keyframes glow {

            0%,
            100% {
                box-shadow: 0 0 5px var(--primary), 0 0 10px var(--primary-glow);
            }

            50% {
                box-shadow: 0 0 15px var(--primary), 0 0 25px var(--primary-glow);
            }
        }

        @keyframes borderGlow {

            0%,
            100% {
                border-color: var(--primary);
            }

            50% {
                border-color: var(--primary-light);
            }
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }

        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        .slide-in {
            animation: slideIn 0.3s ease-out;
        }

        .animate-glow {
            animation: glow 2s ease-in-out infinite;
        }

        .animate-border-glow {
            animation: borderGlow 2s ease-in-out infinite;
        }

        /* Enhanced Color Palette - Glowy Dark Theme */
        :root {
            --primary: #00BCD4;
            --primary-dark: #0097A7;
            --primary-light: #4DD0E1;
            --primary-glow: rgba(0, 188, 212, 0.4);
            --bg-dark: #0D1117;
            --bg-darker: #010409;
            --bg-card: #161B22;
            --bg-elevated: #21262D;
            --text-primary: #FFFFFF;
            --text-secondary: #B8C4CE;
            --text-muted: #64748B;
            --border: #30363D;
            --border-glow: rgba(0, 188, 212, 0.3);
            --success: #22C55E;
            --success-glow: rgba(34, 197, 94, 0.3);
            --warning: #F59E0B;
            --warning-glow: rgba(245, 158, 11, 0.3);
            --error: #EF4444;
            --error-glow: rgba(239, 68, 68, 0.3);
            --info: #3B82F6;
            --purple: #A855F7;
        }

        * {
            scrollbar-width: thin;
            scrollbar-color: var(--primary) var(--bg-darker);
        }

        *::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        *::-webkit-scrollbar-track {
            background: var(--bg-darker);
        }

        *::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }

        body {
            background: linear-gradient(135deg, var(--bg-dark) 0%, var(--bg-darker) 100%);
            color: var(--text-primary);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
        }

        /* Card Styles - Glow only on hover */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .card:hover {
            border-color: var(--primary);
            box-shadow: 0 0 20px var(--primary-glow);
        }

        .card-glow {
            background: var(--bg-card);
            border: 1px solid var(--primary);
        }

        .card-glow:hover {
            box-shadow: 0 0 20px var(--primary-glow);
        }

        .card-success {
            border-color: var(--success);
        }

        .card-success:hover {
            box-shadow: 0 0 15px var(--success-glow);
        }

        .card-warning {
            border-color: var(--warning);
        }

        .card-warning:hover {
            box-shadow: 0 0 15px var(--warning-glow);
        }

        .card-error {
            border-color: var(--error);
        }

        .card-error:hover {
            box-shadow: 0 0 15px var(--error-glow);
        }

        /* Buttons - Glow only on hover */
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: #000;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            box-shadow: 0 0 20px var(--primary-glow);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--primary);
            border: 1px solid var(--primary);
            color: #000;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: var(--primary-light);
            border-color: var(--primary-light);
        }

        /* Navigation - Glow only on hover */
        .nav-button {
            transition: all 0.3s ease;
            position: relative;
        }

        .nav-button:hover {
            background: rgba(0, 188, 212, 0.1);
        }

        .nav-button.active {
            background: rgba(0, 188, 212, 0.15);
            border-bottom: 2px solid var(--primary);
        }

        .nav-button.active:hover {
            box-shadow: 0 4px 15px -5px var(--primary-glow);
        }

        .nav-button.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary);
        }

        /* Status Indicators - Clean colors, glow on hover only */
        .status-healthy {
            color: var(--success);
        }

        .status-warning {
            color: var(--warning);
        }

        .status-critical {
            color: var(--error);
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            transition: box-shadow 0.3s ease;
        }

        .status-dot.healthy {
            background: var(--success);
        }

        .status-dot.healthy:hover {
            box-shadow: 0 0 10px var(--success);
        }

        .status-dot.warning {
            background: var(--warning);
        }

        .status-dot.warning:hover {
            box-shadow: 0 0 10px var(--warning);
        }

        .status-dot.critical {
            background: var(--error);
            animation: pulse 1s infinite;
        }

        .status-dot.critical:hover {
            box-shadow: 0 0 10px var(--error);
        }

        /* Logo - No glow, just the logo image */
        .logo-glow {
            transition: transform 0.3s ease;
        }

        .logo-glow:hover {
            transform: scale(1.02);
        }

        /* Metric Cards with Glow */
        .metric-card {
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-elevated) 100%);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            border-color: var(--primary);
            box-shadow: 0 0 20px var(--primary-glow);
            transform: translateY(-2px);
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Chart Container */
        .chart-container {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            position: relative;
        }

        .chart-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--primary-light), var(--primary));
            border-radius: 12px 12px 0 0;
        }

        /* Phase Cards */
        .phase-card {
            background: linear-gradient(180deg, var(--bg-card) 0%, rgba(22, 27, 34, 0.8) 100%);
            border-radius: 16px;
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
        }

        .phase-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
        }

        .phase-card.phase-detection::before {
            background: var(--info);
        }

        .phase-card.phase-detection:hover::before {
            box-shadow: 0 0 15px var(--info);
        }

        .phase-card.phase-supervised::before {
            background: var(--purple);
        }

        .phase-card.phase-supervised:hover::before {
            box-shadow: 0 0 15px var(--purple);
        }

        .phase-card.phase-autonomous::before {
            background: var(--success);
        }

        .phase-card.phase-autonomous:hover::before {
            box-shadow: 0 0 15px var(--success);
        }

        /* Mode Selection Cards - Glow only on hover */
        .mode-card {
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mode-card:hover {
            border-color: var(--primary);
            box-shadow: 0 0 20px var(--primary-glow);
        }

        .mode-card.active {
            border-color: var(--primary);
            background: rgba(0, 188, 212, 0.1);
        }

        .mode-card.active:hover {
            box-shadow: 0 0 20px var(--primary-glow);
        }

        .mode-card .mode-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            color: var(--text-muted);
            transition: all 0.3s ease;
        }

        .mode-card:hover .mode-icon {
            color: var(--primary);
        }

        .mode-card.active .mode-icon {
            color: var(--primary);
        }

        /* Subscription Cards - Consistent styling with hover effects */
        .subscription-card {
            transition: all 0.3s ease;
        }

        .subscription-card:hover {
            transform: scale(1.02);
            box-shadow: 0 0 30px rgba(0, 188, 212, 0.3), 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        /* Subscription Buttons - Consistent styling */
        .subscription-btn {
            background: var(--primary);
            color: #000;
            border: none;
            cursor: pointer;
        }

        .subscription-btn:hover {
            background: #00e5ff;
            box-shadow: 0 0 20px rgba(0, 188, 212, 0.5);
        }

        .subscription-btn:disabled {
            background: rgba(100, 100, 100, 0.3);
            color: var(--text-muted);
            cursor: not-allowed;
        }

        .subscription-btn:disabled:hover {
            box-shadow: none;
        }

        /* Sidebar Layout */
        .app-layout {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 260px;
            background: var(--bg-card);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            z-index: 50;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sidebar-logo img {
            width: 48px;
            height: 48px;
            object-fit: contain;
        }

        .sidebar-logo-text h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .sidebar-logo-text p {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .sidebar-nav {
            flex: 1;
            padding: 1rem 0;
            overflow-y: auto;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            margin: 4px 12px;
            border-radius: 10px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
            font-weight: 500;
            position: relative;
        }

        .nav-item:hover {
            background: rgba(0, 188, 212, 0.1);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: rgba(0, 188, 212, 0.15);
            color: var(--primary);
            border-left: 3px solid var(--primary);
            margin-left: 9px;
        }

        .nav-item i {
            width: 20px;
            text-align: center;
            font-size: 1rem;
        }

        .nav-item .badge {
            margin-left: auto;
            background: var(--warning);
            color: #000;
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 600;
        }

        .nav-item .badge.error {
            background: var(--error);
            color: #fff;
        }

        .nav-item .lock-icon {
            margin-left: auto;
            color: var(--text-muted);
            font-size: 0.75rem;
        }

        .sidebar-section-header {
            padding: 16px 20px 8px 20px;
            margin-top: 8px;
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--primary);
            border-top: 1px solid var(--border);
        }

        .sidebar-footer {
            padding: 1rem;
            border-top: 1px solid var(--border);
        }

        .upgrade-banner {
            background: rgba(0, 188, 212, 0.1);
            border: 1px solid var(--primary);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }

        .upgrade-banner-title {
            color: var(--primary);
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 4px;
        }

        .upgrade-banner-subtitle {
            color: var(--text-muted);
            font-size: 0.75rem;
            margin-bottom: 12px;
        }

        .upgrade-banner-btn {
            width: 100%;
            padding: 10px;
            background: var(--primary);
            color: #000;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .upgrade-banner-btn:hover {
            background: #00e5ff;
        }

        .main-content {
            flex: 1;
            margin-left: 260px;
            min-height: 100vh;
            transition: margin-left 0.3s ease;
        }

        /* Collapsed sidebar state */
        .sidebar.collapsed {
            transform: translateX(-260px);
        }

        .sidebar.collapsed+.main-content,
        .main-content.expanded {
            margin-left: 0;
        }

        /* Sidebar toggle button */
        .sidebar-toggle {
            position: fixed;
            top: 16px;
            left: 16px;
            z-index: 60;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .sidebar-toggle:hover {
            background: rgba(0, 188, 212, 0.1);
            color: var(--primary);
            border-color: var(--primary);
        }

        .sidebar-toggle.sidebar-open {
            left: 220px;
        }

        .sidebar-toggle.sidebar-closed {
            left: 16px;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .main-content {
                margin-left: 260px;
            }

            .main-content.expanded {
                margin-left: 0;
            }
        }

        @media (max-width: 1024px) {

            /* Tablet - sidebar overlays content */
            .sidebar {
                transform: translateX(-260px);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .sidebar.collapsed {
                transform: translateX(-260px);
            }

            .main-content {
                margin-left: 0 !important;
            }

            .sidebar-toggle {
                left: 16px !important;
            }

            .sidebar-toggle.sidebar-open {
                left: 16px !important;
            }

            /* Overlay when sidebar is open on tablet/mobile */
            .sidebar-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 45;
                opacity: 0;
                visibility: hidden;
                transition: all 0.3s ease;
            }

            .sidebar-overlay.active {
                opacity: 1;
                visibility: visible;
            }

            /* Stats grid responsive */
            .grid-cols-4 {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {

            /* Mobile adjustments */
            .sidebar {
                width: 280px;
                transform: translateX(-280px);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .grid-cols-4 {
                grid-template-columns: repeat(2, 1fr);
            }

            .sidebar-toggle {
                top: 12px;
                left: 12px;
                width: 36px;
                height: 36px;
            }

            /* Top bar branding responsive */
            .topbar-branding img {
                width: 60px !important;
                height: 60px !important;
            }

            .topbar-branding h1 {
                font-size: 1.5rem !important;
            }
        }

        @media (max-width: 640px) {

            /* Small mobile */
            .grid-cols-4 {
                grid-template-columns: 1fr;
            }

            .p-6 {
                padding: 1rem;
            }

            .px-6 {
                padding-left: 1rem;
                padding-right: 1rem;
            }

            .topbar-branding img {
                width: 48px !important;
                height: 48px !important;
            }

            .topbar-branding h1 {
                font-size: 1.25rem !important;
            }

            .topbar-branding p {
                display: none;
            }
        }

        /* Subscription overlay */
        .subscription-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(8px);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .locked-feature {
            opacity: 0.5;
            pointer-events: none;
            position: relative;
        }

        .locked-feature::after {
            content: '\f023';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            color: var(--error);
            text-shadow: 0 0 20px var(--error-glow);
        }

        /* Glassmorphism effect */
        .glass {
            background: rgba(22, 27, 34, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(48, 54, 61, 0.5);
        }

        /* Text glow for headings */
        .text-glow {
            text-shadow: 0 0 20px var(--primary-glow);
        }

        .text-glow-success {
            text-shadow: 0 0 20px var(--success-glow);
        }

        .text-glow-warning {
            text-shadow: 0 0 20px var(--warning-glow);
        }

        .text-glow-error {
            text-shadow: 0 0 20px var(--error-glow);
        }

        /* Gradient text */
        .gradient-text {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Progress bars with glow */
        .progress-bar {
            height: 8px;
            background: var(--bg-elevated);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
            box-shadow: 0 0 10px var(--primary);
            border-radius: 4px;
            transition: width 0.5s ease;
        }
    </style>
</head>

<body>
    <div id="app"></div>



    <script>
        const API_BASE = 'http://localhost:8000';
        const CURRENT_USER_ID = 'demo_user_123'; // Replace with actual auth

        let currentView = 'control-center';
        let autoRefresh = false;
        let refreshInterval = null;
        let subscription = null;

        let state = {
            stats: null,
            incidents: [],
            anomalies: [],
            services: [],
            pendingActions: [],
            actionHistory: [],
            learningStats: {},
            autonomousStatus: null,
            safetyStatus: null,
            outcomes: [],
            resolvedIncidents: [],  // Track resolved incidents
            loading: true,
            selectedIncident: null,
            selectedAction: null,
            // Intelligence panel real-time data
            alertTriageStats: null,
            mttrStats: null,
            costStats: null,
            productionModelStats: null
        };

        // Filter state for incidents view
        let incidentFilters = {
            severity: 'all',
            status: 'all',
            service: 'all',
            dateRange: '7d'
        };

        // Helper function to get filtered incidents (used by renderIncidentsView)
        function getFilteredIncidents() {
            let filtered = [...state.incidents];

            // Filter by severity
            if (incidentFilters.severity !== 'all') {
                filtered = filtered.filter(i => i.severity === incidentFilters.severity);
            }

            // Filter by service
            if (incidentFilters.service !== 'all') {
                filtered = filtered.filter(i => i.service === incidentFilters.service);
            }

            // Filter by date range
            if (incidentFilters.dateRange !== 'all') {
                const now = new Date();
                let cutoff;
                switch (incidentFilters.dateRange) {
                    case '24h':
                        cutoff = new Date(now - 24 * 60 * 60 * 1000);
                        break;
                    case '7d':
                        cutoff = new Date(now - 7 * 24 * 60 * 60 * 1000);
                        break;
                    case '30d':
                        cutoff = new Date(now - 30 * 24 * 60 * 60 * 1000);
                        break;
                    default:
                        cutoff = null;
                }
                if (cutoff) {
                    filtered = filtered.filter(i => new Date(i.timestamp) >= cutoff);
                }
            }

            return filtered;
        }

        // ============================================================================
        // DEMO DATA LOADER - Load realistic demo incidents
        // ============================================================================

        async function loadDemoData() {
            try {
                const response = await fetch('/demo_data.json?t=' + Date.now());
                if (response.ok) {
                    const demoData = await response.json();
                    state.incidents = demoData.incidents || [];
                    // Preserve manually-created pending actions
                    const manualActions = state.pendingActions.filter(a => a.proposed_by === 'manual_request' || a.id?.startsWith('manual_'));
                    state.pendingActions = [...manualActions, ...(demoData.pendingActions || [])];
                    state.anomalies = demoData.anomalies || [];
                    // Preserve local outcomes
                    const localOutcomes = state.outcomes.filter(o => o.action_id?.startsWith('resolve_') || o.action_id?.startsWith('manual_'));
                    state.outcomes = [...localOutcomes, ...(demoData.outcomes || [])];
                    state.services = demoData.services || state.services;
                    state.learningStats = demoData.learningStats || state.learningStats;
                    if (demoData.autonomousStatus) {
                        state.autonomousStatus = demoData.autonomousStatus;
                    }
                    console.log('‚úÖ Demo data loaded:', {
                        incidents: state.incidents.length,
                        actions: state.pendingActions.length,
                        anomalies: state.anomalies.length
                    });
                    return true;
                }
            } catch (e) {
                console.log('‚ÑπÔ∏è No demo data available, using defaults');
            }
            return false;
        }

        // ============================================================================
        // LIVE API DATA FETCHER - Fetch real-time data from the API
        // ============================================================================

        async function fetchAllData() {
            // Preserve local-only state before fetching
            const manualPendingActions = state.pendingActions.filter(a => a.proposed_by === 'manual_request' || a.id?.startsWith('manual_'));
            const localResolvedIncidents = [...state.resolvedIncidents];
            const localActionHistory = [...state.actionHistory];
            const incidentsInReview = manualPendingActions.map(a => a.incident_id);

            try {
                // Fetch all data in parallel
                const [statsRes, incidentsRes, servicesRes, autonomousRes, safetyRes, outcomesRes] = await Promise.all([
                    fetch(`${API_BASE}/api/stats`).catch(() => null),
                    fetch(`${API_BASE}/api/incidents?limit=100`).catch(() => null),
                    fetch(`${API_BASE}/api/services`).catch(() => null),
                    fetch(`${API_BASE}/api/v3/autonomous/status/public`).catch(() => null),
                    fetch(`${API_BASE}/api/v3/autonomous/safety-status/public`).catch(() => null),
                    fetch(`${API_BASE}/api/v3/autonomous/outcomes/public?limit=100`).catch(() => null)
                ]);

                let hasData = false;

                // Process stats
                if (statsRes?.ok) {
                    state.stats = await statsRes.json();
                    hasData = true;
                }

                // Process incidents - but filter out those that are already in manual review
                if (incidentsRes?.ok) {
                    const data = await incidentsRes.json();
                    const apiIncidents = data.incidents || data || [];
                    // Filter out incidents that are already in manual review pending actions
                    state.incidents = apiIncidents.filter(inc => !incidentsInReview.includes(inc.id));
                    hasData = true;
                    console.log(`üìä Loaded ${state.incidents.length} live incidents (${incidentsInReview.length} in review)`);
                }

                // Process services
                if (servicesRes?.ok) {
                    const data = await servicesRes.json();
                    state.services = data.services || data || [];
                }

                // Process autonomous status
                if (autonomousRes?.ok) {
                    state.autonomousStatus = await autonomousRes.json();
                }

                // Process safety status
                if (safetyRes?.ok) {
                    state.safetyStatus = await safetyRes.json();
                }

                // Process outcomes - preserve local outcomes
                if (outcomesRes?.ok) {
                    const data = await outcomesRes.json();
                    const localOutcomes = state.outcomes.filter(o => o.action_id?.startsWith('resolve_') || o.action_id?.startsWith('manual_'));
                    const apiOutcomes = data.outcomes || data || [];
                    state.outcomes = [...localOutcomes, ...apiOutcomes.filter(o => !localOutcomes.some(lo => lo.action_id === o.action_id))];
                }

                // Restore local-only state (these don't come from API)
                state.pendingActions = manualPendingActions;
                state.resolvedIncidents = localResolvedIncidents;
                state.actionHistory = localActionHistory;

                if (hasData) {
                    state.loading = false;
                    render();
                    return true;
                }

                return false;
            } catch (error) {
                console.error('‚ùå Failed to fetch live data:', error);
                // Restore preserved state on error
                state.pendingActions = manualPendingActions;
                state.resolvedIncidents = localResolvedIncidents;
                state.actionHistory = localActionHistory;
                return false;
            }
        }

        // ============================================================================
        // SUBSCRIPTION MANAGEMENT (Keep existing - no changes)
        // ============================================================================

        async function initializeSubscription() {
            try {
                const response = await fetch(`${API_BASE}/api/subscription/status/${CURRENT_USER_ID}`);

                if (response.ok) {
                    subscription = await response.json();
                    // Force trialing status for demo to unlock all features
                    if (subscription.status === 'expired' || subscription.status === 'canceled') {
                        subscription.status = 'trialing';
                        const now = new Date();
                        subscription.trial_end = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000).toISOString();
                    }
                } else {
                    const signupRes = await fetch(`${API_BASE}/api/subscription/signup`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            user_id: CURRENT_USER_ID,
                            email: 'demo@deployr.com'
                        })
                    });

                    if (signupRes.ok) {
                        subscription = await signupRes.json();
                    } else {
                        subscription = getLocalSubscription();
                    }
                }

                checkSubscriptionExpiration();

            } catch (error) {
                console.error('Subscription init error:', error);
                subscription = getLocalSubscription();
            }
        }

        function getLocalSubscription() {
            let sub = localStorage.getItem('deployr_subscription');

            if (!sub) {
                const now = new Date();
                const trialEnd = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);

                sub = {
                    user_id: CURRENT_USER_ID,
                    plan: 'pro',
                    status: 'trialing',
                    trial_start: now.toISOString(),
                    trial_end: trialEnd.toISOString(),
                    current_period_end: trialEnd.toISOString(),
                    created_at: now.toISOString()
                };

                localStorage.setItem('deployr_subscription', JSON.stringify(sub));
            } else {
                sub = JSON.parse(sub);
            }

            return sub;
        }

        function checkSubscriptionExpiration() {
            if (subscription.status === 'trialing') {
                const now = new Date();
                const trialEnd = new Date(subscription.trial_end);

                if (now > trialEnd) {
                    subscription.status = 'expired';
                    localStorage.setItem('deployr_subscription', JSON.stringify(subscription));
                }
            }
        }

        function getDaysRemaining() {
            if (!subscription || subscription.status !== 'trialing') return 0;

            const now = new Date();
            const trialEnd = new Date(subscription.trial_end);
            const diffTime = trialEnd - now;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            return Math.max(0, diffDays);
        }

        function isFeatureAllowed(feature) {
            // DEMO MODE: Always allow all features
            return true;

            // Production code (commented out for demo):
            // if (!subscription) return false;
            // const allowedFeatures = {
            //     'dashboard_view': ['trialing', 'active', 'expired', 'canceled'],
            //     'incidents_read': ['trialing', 'active', 'expired', 'canceled'],
            //     'auto_remediation': ['trialing', 'active'],
            //     'ai_reasoning': ['trialing', 'active'],
            //     'slack_alerts': ['trialing', 'active'],
            //     'autonomous_mode': ['trialing', 'active']
            // };
            // return allowedFeatures[feature]?.includes(subscription.status) || false;
        }

        function showUpgradeModal() {
            document.getElementById('upgradeModal').style.display = 'flex';
        }

        function closeUpgradeModal() {
            document.getElementById('upgradeModal').style.display = 'none';
        }

        async function handleUpgrade(plan = 'advanced') {
            const planNames = {
                'essential': 'Essential',
                'advanced': 'Advanced',
                'ultimate': 'Ultimate'
            };
            const planName = planNames[plan] || 'Advanced';

            try {
                const response = await fetch(`${API_BASE}/api/subscription/upgrade`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: CURRENT_USER_ID,
                        plan: plan,
                        payment_provider_customer_id: 'cus_demo123',
                        payment_method_id: 'pm_demo123'
                    })
                });

                if (response.ok) {
                    subscription = await response.json();
                    localStorage.setItem('deployr_subscription', JSON.stringify(subscription));
                    closeUpgradeModal();
                    showNotification(`Welcome to Deployr ${planName}!`, 'success');
                    setTimeout(() => render(), 500);
                } else {
                    showNotification('Upgrade failed. Please try again.', 'error');
                }
            } catch (error) {
                const now = new Date();
                const nextBilling = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000);

                subscription.status = 'active';
                subscription.plan = plan;
                subscription.current_period_end = nextBilling.toISOString();
                localStorage.setItem('deployr_subscription', JSON.stringify(subscription));

                closeUpgradeModal();
                showNotification(`Upgraded to ${planName}! (Demo mode)`, 'success');
                setTimeout(() => render(), 500);
            }
        }

        function showNotification(message, type) {
            const notif = document.createElement('div');
            notif.className = `fixed top-6 right-6 z-50 p-4 rounded-lg shadow-2xl slide-in ${type === 'success' ? 'bg-green-600' : 'bg-red-600'
                }`;
            notif.innerHTML = `
                <div class="flex items-center gap-3">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} text-2xl"></i>
                    <span class="font-semibold">${message}</span>
                </div>
            `;

            document.body.appendChild(notif);

            setTimeout(() => {
                notif.remove();
            }, 3000);
        }

        // ============================================================================
        // DATA FETCHING (Keep existing - no changes)
        // ============================================================================

        async function fetchAllData() {
            try {
                const [
                    statsRes, incidentsRes, anomaliesRes, servicesRes,
                    pendingRes, historyRes, learningRes, learningStatsV5Res,
                    autoStatusRes, safetyRes, outcomesRes,
                    // Intelligence APIs
                    alertTriageRes, mttrRes, costRes, prodModelRes,
                    // Resolved incidents
                    resolvedRes
                ] = await Promise.all([
                    fetch(`${API_BASE}/api/stats`).catch(() => null),
                    fetch(`${API_BASE}/api/incidents?limit=20`).catch(() => null),
                    fetch(`${API_BASE}/api/anomalies?limit=50`).catch(() => null),
                    fetch(`${API_BASE}/api/services`).catch(() => null),
                    fetch(`${API_BASE}/api/v2/actions/pending`).catch(() => null),
                    fetch(`${API_BASE}/api/v2/actions/history?limit=30`).catch(() => null),
                    fetch(`${API_BASE}/api/v2/learning/stats`).catch(() => null),
                    fetch(`${API_BASE}/api/v5/learning/stats`).catch(() => null),
                    fetch(`${API_BASE}/api/v3/autonomous/status/public`).catch(() => null),
                    fetch(`${API_BASE}/api/v3/autonomous/safety-status/public`).catch(() => null),
                    fetch(`${API_BASE}/api/v3/autonomous/outcomes/public?limit=30`).catch(() => null),
                    // Intelligence panel APIs
                    fetch(`${API_BASE}/api/intelligence/alert-triage`).catch(() => null),
                    fetch(`${API_BASE}/api/intelligence/mttr`).catch(() => null),
                    fetch(`${API_BASE}/api/intelligence/cost`).catch(() => null),
                    fetch(`${API_BASE}/api/intelligence/production-model`).catch(() => null),
                    // Resolved incidents
                    fetch(`${API_BASE}/api/incidents/resolved`).catch(() => null)
                ]);

                if (statsRes?.ok) state.stats = await statsRes.json();
                if (incidentsRes?.ok) state.incidents = (await incidentsRes.json()).incidents || [];
                if (anomaliesRes?.ok) state.anomalies = (await anomaliesRes.json()).anomalies || [];
                if (servicesRes?.ok) state.services = (await servicesRes.json()).services || [];
                if (pendingRes?.ok) state.pendingActions = (await pendingRes.json()).actions || [];
                if (historyRes?.ok) state.actionHistory = (await historyRes.json()).actions || [];
                if (learningRes?.ok) state.learningStats = await learningRes.json();

                // Merge V5 learning stats (comprehensive knowledge base stats)
                if (learningStatsV5Res?.ok) {
                    const v5Stats = await learningStatsV5Res.json();
                    if (!v5Stats.error) {
                        state.learningStats = {
                            ...state.learningStats,
                            total_patterns: v5Stats.knowledge_base?.total_patterns || 580,
                            autonomous_safe: v5Stats.knowledge_base?.autonomous_safe_count || 45,
                            by_category: v5Stats.knowledge_base?.by_category || {},
                            success_rate: v5Stats.learning_engine?.success_rate || 94,
                            patterns_promoted: v5Stats.learning_engine?.patterns_promoted || 12,
                            patterns_demoted: v5Stats.learning_engine?.patterns_demoted || 0
                        };
                    }
                }

                if (autoStatusRes?.ok) state.autonomousStatus = await autoStatusRes.json();
                if (safetyRes?.ok) state.safetyStatus = await safetyRes.json();
                if (outcomesRes?.ok) {
                    const data = await outcomesRes.json();
                    state.outcomes = data.outcomes || [];
                }

                // Intelligence panel data
                if (alertTriageRes?.ok) state.alertTriageStats = await alertTriageRes.json();
                if (mttrRes?.ok) state.mttrStats = await mttrRes.json();
                if (costRes?.ok) state.costStats = await costRes.json();
                if (prodModelRes?.ok) state.productionModelStats = await prodModelRes.json();

                // Resolved incidents from API (persisted in Redis)
                if (resolvedRes?.ok) {
                    const data = await resolvedRes.json();
                    state.resolvedIncidents = data.resolved_incidents || [];
                }

                state.loading = false;
                render();
                return true; // Indicate success
            } catch (error) {
                console.error('Error fetching data:', error);
                state.loading = false;
                renderError(error.message);
                return false;
            }
        }

        // Helper function for pattern category badges
        function renderPatternCategoryBadge(category, icon, color, count) {
            return `
                <div class="bg-black bg-opacity-40 rounded-lg p-3 border hover:scale-105 transition cursor-pointer" 
                     style="border-color: ${color}40;" 
                     onmouseover="this.style.borderColor='${color}80'" 
                     onmouseout="this.style.borderColor='${color}40'">
                    <div class="flex items-center gap-2">
                        <i class="fas ${icon}" style="color: ${color};"></i>
                        <span class="text-xs text-gray-400 capitalize">${category}</span>
                    </div>
                    <div class="text-xl font-bold text-white mt-1">${count}</div>
                </div>
            `;
        }

        function toggleAutoRefresh() {
            autoRefresh = !autoRefresh;
            if (autoRefresh) {
                refreshInterval = setInterval(fetchAllData, 10000);
            } else {
                clearInterval(refreshInterval);
            }
            render();
        }

        function switchView(view) {
            // Save sidebar scroll position before switching (check both elements)
            const sidebarElement = document.getElementById('sidebar');
            const sidebarNav = document.querySelector('.sidebar-nav');
            const scrollableEl = sidebarNav || sidebarElement;
            const scrollPos = scrollableEl ? scrollableEl.scrollTop : 0;

            currentView = view;
            state.selectedIncident = null;
            state.selectedAction = null;
            render();

            // Restore sidebar scroll position after render (multiple attempts for reliability)
            requestAnimationFrame(() => {
                const sidebar = document.getElementById('sidebar');
                const nav = document.querySelector('.sidebar-nav');

                // Try restoring on both elements
                if (sidebar) sidebar.scrollTop = scrollPos;
                if (nav) nav.scrollTop = scrollPos;

                // Second attempt after a short delay
                setTimeout(() => {
                    if (sidebar) sidebar.scrollTop = scrollPos;
                    if (nav) nav.scrollTop = scrollPos;
                }, 50);
            });

            // Reinitialize charts when switching to control-center
            if (view === 'control-center') {
                initializeCharts();
            }

            // Load logs when switching to logs view
            if (view === 'logs') {
                loadLogs();
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            const toggleBtn = document.getElementById('sidebarToggle');

            const isCollapsed = sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('expanded', isCollapsed);

            // Update toggle button
            toggleBtn.classList.toggle('sidebar-open', !isCollapsed);
            toggleBtn.classList.toggle('sidebar-closed', isCollapsed);

            // Update icon
            const iconName = isCollapsed ? 'panel-left-open' : 'panel-left-close';
            toggleBtn.innerHTML = `<i data-lucide="${iconName}" style="width: 20px; height: 20px;"></i>`;

            // Reinitialize Lucide icons for the button
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }

            // Save state to localStorage
            localStorage.setItem('sidebarCollapsed', isCollapsed);
        }

        function renderError(message) {
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen flex items-center justify-center p-6">
                    <div class="card rounded-xl shadow-2xl p-8 max-w-2xl w-full">
                        <div class="text-center">
                            <i class="data-lucide="alert-triangle" style="width: 16px; height: 16px;" text-6xl text-red-500 mb-4"></i>
                            <h2 class="text-2xl font-bold mb-4">Connection Error</h2>
                            <div class="bg-red-900/20 border border-red-600/50 rounded-lg p-4 mb-6">
                                <p class="text-sm text-red-300">${message}</p>
                            </div>
                            <button onclick="location.reload()" class="bg-primary hover:bg-primary-dark px-6 py-3 rounded-lg font-semibold transition text-black">
                                <i class="data-lucide="rotate-cw" style="width: 16px; height: 16px;" mr-2"></i>Retry Connection
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function render() {
            if (state.loading) {
                document.getElementById('app').innerHTML = `
                    <div class="min-h-screen flex items-center justify-center">
                        <div class="text-center">
                            <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-primary mx-auto mb-4"></div>
                            <p class="text-gray-300">Loading Dashboard...</p>
                        </div>
                    </div>
                `;
                return;
            }

            const app = document.getElementById('app');
            const sidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
            app.innerHTML = `
                <button onclick="toggleSidebar()" class="sidebar-toggle ${sidebarCollapsed ? 'sidebar-closed' : 'sidebar-open'}" id="sidebarToggle">
                    <i data-lucide="${sidebarCollapsed ? 'panel-left-open' : 'panel-left-close'}" style="width: 20px; height: 20px;"></i>
                </button>
                <div class="app-layout">
                    ${renderSidebar(sidebarCollapsed)}
                    <div class="main-content ${sidebarCollapsed ? 'expanded' : ''}" id="mainContent">
                        ${renderSubscriptionBanner()}
                        ${renderTopBar()}
                        <div class="p-6">
                            ${renderMainContent()}
                        </div>
                    </div>
                </div>
                ${renderNotifications()}
            `;

            // Initialize Lucide icons after render
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        function renderSidebar(isCollapsed = false) {
            const pendingCount = state.pendingActions?.length || 0;
            const criticalIncidents = state.incidents?.filter(i => i.severity === 'critical').length || 0;
            const isPremiumLocked = !isFeatureAllowed('auto_remediation');

            return `
                <aside class="sidebar ${isCollapsed ? 'collapsed' : ''}" id="sidebar">
                    <div class="sidebar-header">
                        <div class="sidebar-logo">
                            <img src="img/deployr_logo.png" alt="Deployr Logo" class="logo-glow" />
                            <div class="sidebar-logo-text">
                                <h1>Deployr</h1>
                                <p>Fix the oops. Without Ops.</p>
                            </div>
                        </div>
                    </div>
                    
                    <nav class="sidebar-nav">
                        ${renderSidebarNavItem('control-center', 'layout-dashboard', 'Control Center')}
                        ${renderSidebarNavItem('incidents', 'alert-triangle', 'Incidents', criticalIncidents > 0 ? criticalIncidents : 0, criticalIncidents > 0 ? 'error' : '')}
                        ${renderSidebarNavItem('actions', 'zap', 'Actions', pendingCount, '', isPremiumLocked)}
                        ${renderSidebarNavItem('autonomous', 'bot', 'Autonomous', 0, '', isPremiumLocked)}
                        ${renderSidebarNavItem('services', 'server', 'Services')}
                        ${renderSidebarNavItem('analytics', 'bar-chart-2', 'Analytics')}
                        ${renderSidebarNavItem('integration', 'plug', 'Integration')}
                        ${renderSidebarNavItem('logs', 'scroll-text', 'Logs')}
                        ${renderSidebarNavItem('subscription', 'crown', 'Subscription')}
                        
                        <div class="sidebar-section-header">
                            <span>Intelligence</span>
                        </div>
                        ${renderSidebarNavItem('intelligence-model', 'network', 'Production Model')}
                        ${renderSidebarNavItem('intelligence-alerts', 'bell-off', 'Alert Triage')}
                        ${renderSidebarNavItem('intelligence-mttr', 'gauge', 'MTTR Engine')}
                        ${renderSidebarNavItem('intelligence-timeline', 'git-commit', 'Timeline')}
                        ${renderSidebarNavItem('intelligence-cost', 'dollar-sign', 'Cost Insights')}
                    </nav>
                    
                    ${subscription?.status !== 'active' ? `
                        <div class="sidebar-footer">
                            <div class="upgrade-banner">
                                <div class="upgrade-banner-title">
                                    <i data-lucide="crown" style="width: 16px; height: 16px; display: inline-block; vertical-align: middle; margin-right: 4px;"></i>Upgrade to Pro
                                </div>
                                <div class="upgrade-banner-subtitle">
                                    ${subscription?.status === 'trialing' ? `${getDaysRemaining()} days left in trial` : 'Unlock all features'}
                                </div>
                                <button onclick="switchView('subscription')" class="upgrade-banner-btn">
                                    View Plans
                                </button>
                            </div>
                        </div>
                    ` : ''}
                </aside>
            `;
        }

        function renderSidebarNavItem(view, icon, label, badge = 0, badgeType = '', isLocked = false) {
            const isActive = currentView === view;
            return `
                <div onclick="switchView('${view}')" class="nav-item ${isActive ? 'active' : ''} ${isLocked ? 'opacity-60' : ''}">
                    <i data-lucide="${icon}" style="width: 20px; height: 20px;"></i>
                    <span>${label}</span>
                    ${badge > 0 ? `<span class="badge ${badgeType}">${badge}</span>` : ''}
                    ${isLocked ? '<i data-lucide="lock" class="lock-icon" style="width: 14px; height: 14px;"></i>' : ''}
                </div>
            `;
        }

        function renderTopBar() {
            const autoMode = state.autonomousStatus?.execution_mode || 'manual';
            const isPremiumLocked = !isFeatureAllowed('auto_remediation');
            const pendingCount = state.pendingActions?.length || 0;
            const criticalIncidents = state.incidents?.filter(i => i.severity === 'critical').length || 0;

            return `
                <div class="glass border-b" style="border-color: var(--border);">
                    <div class="px-6 py-4">
                        <!-- Branding Row -->
                        <div class="topbar-branding flex items-center gap-5 mb-5">
                            <img src="img/deployr_logo.png" class="h-28 w-28 object-contain logo-glow" alt="Deployr Logo" />
                            <div>
                                <h1 class="text-4xl font-bold tracking-wide" style="color: var(--text-primary);">Deployr</h1>
                                <p class="text-base" style="color: var(--text-secondary);">Fix the oops. Without Ops.</p>
                            </div>
                        </div>
                        
                        <!-- Controls Row -->
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-3">
                                ${renderModeIndicator(autoMode, isPremiumLocked)}
                            </div>
                            <div class="flex items-center gap-3">
                                <button onclick="toggleAutoRefresh()" class="${autoRefresh ? 'btn-primary' : 'btn-secondary'} px-4 py-2 rounded-lg font-medium text-sm flex items-center gap-2">
                                    <span class="status-dot ${autoRefresh ? 'healthy' : ''}"></span>
                                    ${autoRefresh ? 'Live' : 'Paused'}
                                </button>
                                <button onclick="fetchAllData()" class="btn-primary px-4 py-2 rounded-lg font-medium text-sm flex items-center gap-2">
                                    <i data-lucide="refresh-cw" style="width: 16px; height: 16px;"></i>
                                    Refresh
                                </button>
                            </div>
                        </div>
                        
                        <!-- Stats Grid -->
                        <div class="grid grid-cols-4 gap-4 mt-4">
                            ${renderQuickStat('alert-circle', 'Critical Alerts', criticalIncidents, criticalIncidents > 0 ? 'error' : 'muted')}
                            ${renderQuickStat('clock', 'Pending Actions', pendingCount, pendingCount > 0 ? 'warning' : 'muted')}
                            ${renderQuickStat('check-circle', 'Successful', state.outcomes.filter(o => o.success).length, 'success')}
                            ${renderQuickStat('heart-pulse', 'Healthy Services', state.stats?.healthy_services || 0, 'success')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderSubscriptionBanner() {
            if (!subscription) return '';

            const daysRemaining = getDaysRemaining();

            // Trial active - banner removed, upgrade button is in header
            if (subscription.status === 'trialing') {
                return '';
            }

            // Trial expired
            if (subscription.status === 'expired') {
                return `
                    <div class="bg-red-900/90 p-4 text-center border-b-2 border-red-600">
                        <div class="max-w-7xl mx-auto flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <i data-lucide="lock" class="text-red-400" style="width: 24px; height: 24px;"></i>
                                <span class="font-bold text-lg">
                                    Your trial has expired. Upgrade to continue monitoring.
                                </span>
                            </div>
                            <button onclick="showUpgradeModal()" class="bg-red-600 hover:bg-red-700 px-6 py-2 rounded-lg font-bold transition">
                                Upgrade Now
                            </button>
                        </div>
                    </div>
                `;
            }

            // Active subscription
            if (subscription.status === 'active') {
                return `
                    <div class="bg-green-900/30 p-3 text-center border-b border-green-600">
                        <div class="max-w-7xl mx-auto flex items-center justify-center gap-3">
                            <i data-lucide="crown" class="text-yellow-500" style="width: 20px; height: 20px;"></i>
                            <span class="font-semibold">
                                Pro Plan Active - Next billing: ${new Date(subscription.current_period_end).toLocaleDateString()}
                            </span>
                        </div>
                    </div>
                `;
            }

            return '';
        }

        function renderHeader() {
            const pendingCount = state.pendingActions?.length || 0;
            const criticalIncidents = state.incidents?.filter(i => i.severity === 'critical').length || 0;
            const autoMode = state.autonomousStatus?.execution_mode || 'manual';

            // Check if premium features are locked
            const isPremiumLocked = !isFeatureAllowed('auto_remediation');

            return `
                <div class="glass border-b z-40" style="border-color: var(--border);">
                    <div class="max-w-7xl mx-auto px-6 py-5">
                       <!-- Branding Section -->
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center gap-5">
                                <img src="img/deployr_logo.png" class="h-28 w-28 object-contain logo-glow" alt="Deployr Logo" />
                                <div>
                                    <h1 class="text-4xl font-bold tracking-wide" style="color: var(--text-primary);">Deployr</h1>
                                    <p class="text-base" style="color: var(--text-secondary);">Fix the oops. Without Ops.</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-4">
                                <button onclick="toggleAutoRefresh()" class="${autoRefresh ? 'btn-primary' : 'btn-secondary'} px-4 py-2.5 rounded-lg font-medium text-sm flex items-center gap-2">
                                    <span class="status-dot ${autoRefresh ? 'healthy' : ''}"></span>
                                    ${autoRefresh ? 'Live' : 'Paused'}
                                </button>
                                <button onclick="fetchAllData()" class="btn-primary px-4 py-2.5 rounded-lg font-medium text-sm flex items-center gap-2">
                                    <i class="data-lucide="refresh-cw" style="width: 16px; height: 16px;""></i>
                                    Refresh
                                </button>
                            </div>
                        </div>

                        <!-- Mode & Status Bar -->
                        <div class="flex items-center justify-between mb-5">
                            <div class="flex items-center gap-4">
                                ${renderModeIndicator(autoMode, isPremiumLocked)}
                                ${subscription?.status !== 'active' ? `
                                    <button onclick="switchView('subscription')" class="px-4 py-2 rounded-lg font-medium text-sm flex items-center gap-2 transition" style="background: rgba(0, 188, 212, 0.15); border: 1px solid var(--primary); color: var(--primary);">
                                        <i class="data-lucide="crown" style="width: 16px; height: 16px;""></i>
                                        <span>Upgrade</span>
                                        ${subscription?.status === 'trialing' ? `<span class="text-xs opacity-75">(${getDaysRemaining()}d left)</span>` : ''}
                                    </button>
                                ` : ''}
                            </div>
                        </div>

                        <!-- Stats Grid -->
                        <div class="grid grid-cols-4 gap-4 mb-5">
                            ${renderQuickStat('fa-exclamation-circle', 'Critical Alerts', criticalIncidents, criticalIncidents > 0 ? 'error' : 'muted')}
                            ${renderQuickStat('fa-clock', 'Pending Actions', pendingCount, pendingCount > 0 ? 'warning' : 'muted')}
                            ${renderQuickStat('fa-check-circle', 'Successful', state.outcomes.filter(o => o.success).length, 'success')}
                            ${renderQuickStat('fa-heartbeat', 'Healthy Services', state.stats?.healthy_services || 0, 'success')}
                        </div>

                        <!-- Navigation -->
                        <div class="flex justify-center gap-1 overflow-x-auto pb-2">
                            ${renderNavButton('control-center', 'fa-th-large', 'Control Center')}
                            ${renderNavButton('incidents', 'fa-exclamation-triangle', 'Incidents', criticalIncidents)}
                            ${renderNavButton('actions', 'fa-bolt', 'Actions', pendingCount, isPremiumLocked)}
                            ${renderNavButton('autonomous', 'fa-robot', 'Autonomous', 0, isPremiumLocked)}
                            ${renderNavButton('services', 'fa-server', 'Services')}
                            ${renderNavButton('analytics', 'fa-chart-line', 'Analytics')}
                            ${renderNavButton('subscription', 'fa-crown', 'Subscription')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderModeIndicator(mode, isLocked) {
            if (isLocked) {
                return `
                    <div class="bg-gray-700 text-gray-400 px-4 py-2 rounded-lg font-medium text-sm flex items-center gap-2">
                        <i data-lucide="lock" style="width: 16px; height: 16px;"></i>
                        <span class="uppercase tracking-wide">PREMIUM LOCKED</span>
                    </div>
                `;
            }

            const colors = {
                manual: 'bg-gray-700 text-gray-300',
                supervised: 'bg-blue-700 text-blue-200',
                autonomous: 'bg-green-700 text-green-200',
                night_mode: 'bg-purple-700 text-purple-200'
            };

            const icons = {
                manual: 'hand',
                supervised: 'eye',
                autonomous: 'bot',
                night_mode: 'moon'
            };

            return `
                <div class="${colors[mode] || colors.manual} px-4 py-2 rounded-lg font-medium text-sm flex items-center gap-2">
                    <i data-lucide="${icons[mode] || icons.manual}" style="width: 16px; height: 16px;"></i>
                    <span class="uppercase tracking-wide">${mode.replace('_', ' ')}</span>
                </div>
            `;
        }

        function renderQuickStat(icon, label, value, statusType) {
            const statusClasses = {
                success: 'status-healthy',
                warning: 'status-warning',
                error: 'status-critical',
                muted: ''
            };
            const glowClasses = {
                success: 'card-success',
                warning: 'card-warning',
                error: 'card-error',
                muted: ''
            };
            const statusClass = statusClasses[statusType] || '';
            const glowClass = value > 0 ? (glowClasses[statusType] || '') : '';

            return `
                <div class="metric-card ${glowClass}">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: var(--bg-elevated);">
                            <i data-lucide="${icon}" class="${statusClass}" style="width: 24px; height: 24px;"></i>
                        </div>
                        <div>
                            <div class="text-xs uppercase tracking-wider" style="color: var(--text-muted);">${label}</div>
                            <div class="text-2xl font-bold ${statusClass}">${value}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderNavButton(view, icon, label, badge = 0, isLocked = false, isSpecial = false) {
            const isActive = currentView === view;
            return `
                <button onclick="switchView('${view}')" class="nav-button ${isActive ? 'active' : ''} px-6 py-3 rounded-t-lg font-medium transition relative whitespace-nowrap text-sm ${isActive ? 'text-primary' : 'text-gray-400'} ${isLocked ? 'opacity-50' : ''}">
                    <i class="fas ${icon} mr-2"></i>${label}
                    ${badge > 0 ? `<span class="absolute -top-1 -right-1 bg-orange-500 text-white text-xs px-2 py-0.5 rounded-full">${badge}</span>` : ''}
                    ${isLocked ? `<i class="data-lucide="lock" style="width: 16px; height: 16px;" text-xs ml-1"></i>` : ''}
                    ${isSpecial ? `<i class="data-lucide="star" style="width: 16px; height: 16px;" text-yellow-500 text-xs ml-1"></i>` : ''}
                </button>
            `;
        }

        function renderMainContent() {
            const views = {
                'control-center': renderControlCenter,
                'incidents': renderIncidentsView,
                'actions': renderActionsView,
                'autonomous': renderAutonomousView,
                'services': renderServicesView,
                'analytics': renderAnalyticsView,
                'integration': renderIntegrationView,
                'logs': renderLogsView,
                'subscription': renderSubscriptionView,
                'intelligence-model': renderIntelligenceModel,
                'intelligence-alerts': renderAlertTriage,
                'intelligence-mttr': renderMTTREngine,
                'intelligence-timeline': renderTimelineView,
                'intelligence-cost': renderCostInsights
            };

            const renderFunc = views[currentView] || renderControlCenter;

            return `
                <div class="max-w-7xl mx-auto px-6 py-6">
                    ${renderFunc()}
                </div>
            `;
        }

        // Logs state
        let logsState = {
            logs: [],
            search: '',
            modeFilter: 'all',
            serviceFilter: 'all',
            page: 1,
            limit: 20,
            total: 0,
            loading: false
        };

        async function loadLogs() {
            logsState.loading = true;
            try {
                const params = new URLSearchParams({
                    page: logsState.page,
                    limit: logsState.limit
                });
                if (logsState.search) params.append('search', logsState.search);
                if (logsState.modeFilter !== 'all') params.append('mode', logsState.modeFilter);
                if (logsState.serviceFilter !== 'all') params.append('service', logsState.serviceFilter);

                const response = await fetch(`${API_BASE}/api/logs?${params}`);
                if (response.ok) {
                    const data = await response.json();
                    logsState.logs = data.logs || [];
                    logsState.total = data.total || 0;
                }
            } catch (error) {
                console.error('Failed to load logs:', error);
            }
            logsState.loading = false;
            render();
        }

        async function deleteLogEntry(logId) {
            if (!logId || !confirm('Are you sure you want to delete this log entry?')) return;

            try {
                const response = await fetch(`${API_BASE}/api/logs/${logId}`, { method: 'DELETE' });
                if (response.ok) {
                    showNotification('Log entry deleted successfully', 'success');
                    loadLogs();
                } else {
                    showNotification('Failed to delete log entry', 'error');
                }
            } catch (error) {
                showNotification('Failed to delete log entry', 'error');
            }
        }

        async function exportLogs(format) {
            try {
                const params = new URLSearchParams({ format });
                if (logsState.modeFilter !== 'all') params.append('mode', logsState.modeFilter);
                if (logsState.serviceFilter !== 'all') params.append('service', logsState.serviceFilter);

                const response = await fetch(`${API_BASE}/api/logs/export?${params}`);
                if (response.ok) {
                    const data = await response.json();

                    // Create download
                    const blob = format === 'csv'
                        ? new Blob([data.data], { type: 'text/csv' })
                        : new Blob([JSON.stringify(data.data, null, 2)], { type: 'application/json' });

                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = data.filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    showNotification(`Exported ${data.total} log entries as ${format.toUpperCase()}`, 'success');
                }
            } catch (error) {
                showNotification('Failed to export logs', 'error');
            }
        }

        function updateLogsFilter(field, value) {
            logsState[field] = value;
            logsState.page = 1; // Reset to first page
            loadLogs();
        }

        function renderLogsView() {
            // Get unique services from logs for filter dropdown
            const services = [...new Set(logsState.logs.map(l => l.service).filter(Boolean))];

            return `
                <div class="space-y-6">
                    <!-- Header -->
                    <div class="flex items-center justify-between">
                        <div>
                            <h1 class="text-2xl font-bold" style="color: var(--text-primary);">
                                <i data-lucide="scroll-text" class="inline-block mr-2" style="width: 28px; height: 28px; color: var(--primary); vertical-align: middle;"></i>
                                Action Logs
                            </h1>
                            <p class="text-sm" style="color: var(--text-muted);">Permanent log of all manual and autonomous actions</p>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="exportLogs('csv')" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg flex items-center gap-2 transition">
                                <i data-lucide="download" style="width: 16px; height: 16px;"></i> Export CSV
                            </button>
                            <button onclick="exportLogs('json')" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg flex items-center gap-2 transition">
                                <i data-lucide="file-json" style="width: 16px; height: 16px;"></i> Export JSON
                            </button>
                            <button onclick="loadLogs()" class="px-4 py-2 bg-primary hover:bg-primary/80 text-white rounded-lg flex items-center gap-2 transition">
                                <i data-lucide="refresh-cw" style="width: 16px; height: 16px;"></i> Refresh
                            </button>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="card rounded-xl p-4">
                        <div class="flex flex-wrap gap-4 items-center">
                            <!-- Search -->
                            <div class="flex-1 min-w-[200px]">
                                <div class="relative">
                                    <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2" style="width: 18px; height: 18px; color: var(--text-muted);"></i>
                                    <input type="text" 
                                           placeholder="Search logs..." 
                                           value="${logsState.search}"
                                           onchange="updateLogsFilter('search', this.value)"
                                           onkeypress="if(event.key==='Enter') updateLogsFilter('search', this.value)"
                                           class="w-full bg-black/40 border border-gray-700 rounded-lg pl-10 pr-4 py-2 text-white placeholder-gray-400 focus:border-primary focus:outline-none">
                                </div>
                            </div>
                            
                            <!-- Mode Filter -->
                            <select onchange="updateLogsFilter('modeFilter', this.value)" 
                                    class="bg-black/40 border border-gray-700 rounded-lg px-4 py-2 text-white focus:border-primary focus:outline-none">
                                <option value="all" ${logsState.modeFilter === 'all' ? 'selected' : ''}>All Modes</option>
                                <option value="autonomous" ${logsState.modeFilter === 'autonomous' ? 'selected' : ''}>Autonomous</option>
                                <option value="manual" ${logsState.modeFilter === 'manual' ? 'selected' : ''}>Manual</option>
                            </select>
                            
                            <!-- Service Filter -->
                            <select onchange="updateLogsFilter('serviceFilter', this.value)"
                                    class="bg-black/40 border border-gray-700 rounded-lg px-4 py-2 text-white focus:border-primary focus:outline-none">
                                <option value="all">All Services</option>
                                ${services.map(s => `<option value="${s}" ${logsState.serviceFilter === s ? 'selected' : ''}>${s}</option>`).join('')}
                            </select>
                            
                            <!-- Results count -->
                            <div class="text-sm text-gray-400">
                                Showing ${logsState.logs.length} of ${logsState.total} logs
                            </div>
                        </div>
                    </div>

                    <!-- Logs Table -->
                    <div class="card rounded-xl overflow-hidden">
                        ${logsState.loading ? `
                            <div class="p-8 text-center text-gray-400">
                                <i data-lucide="loader-2" class="inline-block animate-spin" style="width: 24px; height: 24px;"></i>
                                <p class="mt-2">Loading logs...</p>
                            </div>
                        ` : logsState.logs.length === 0 ? `
                            <div class="p-8 text-center text-gray-400">
                                <i data-lucide="inbox" class="inline-block mb-2" style="width: 48px; height: 48px;"></i>
                                <p class="text-lg font-semibold">No logs found</p>
                                <p class="text-sm">Logs will appear here when actions are executed</p>
                            </div>
                        ` : `
                            <table class="w-full table-fixed">
                                <thead class="bg-black/40">
                                    <tr class="text-left text-xs uppercase tracking-wider text-gray-400">
                                        <th class="px-4 py-3 w-40">Timestamp</th>
                                        <th class="px-4 py-3 w-24">Mode</th>
                                        <th class="px-4 py-3">Action</th>
                                        <th class="px-4 py-3 w-32">Service</th>
                                        <th class="px-4 py-3 w-24">Status</th>
                                        <th class="px-4 py-3 w-28">Executed By</th>
                                        <th class="px-4 py-3 w-20">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-700/50">
                                    ${logsState.logs.map(log => `
                                        <tr class="hover:bg-black/20 transition">
                                            <td class="px-4 py-3 text-sm text-gray-300">
                                                ${log.created_at ? new Date(log.created_at).toLocaleString() : 'N/A'}
                                            </td>
                                            <td class="px-4 py-3">
                                                <span class="px-2 py-1 rounded-full text-xs font-semibold ${log.mode === 'autonomous' ? 'bg-purple-500/20 text-purple-400' : 'bg-blue-500/20 text-blue-400'}">
                                                    ${log.mode === 'autonomous' ? 'Auto' : 'Manual'}
                                                </span>
                                            </td>
                                            <td class="px-4 py-3">
                                                <span class="text-white font-medium">${log.action_type || 'unknown'}</span>
                                                ${log.description ? `<p class="text-xs text-gray-400 mt-1">${log.description}</p>` : ''}
                                            </td>
                                            <td class="px-4 py-3 text-gray-300">${log.service || 'N/A'}</td>
                                            <td class="px-4 py-3">
                                                <span class="px-2 py-1 rounded-full text-xs font-semibold ${log.success ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}">
                                                    ${log.success ? 'Success' : 'Failed'}
                                                </span>
                                            </td>
                                            <td class="px-4 py-3 text-sm text-gray-400">${log.executed_by || 'N/A'}</td>
                                            <td class="px-4 py-3">
                                                ${log.log_id ? `
                                                    <button onclick="deleteLogEntry(${log.log_id})" class="text-red-400 hover:text-red-300 transition" title="Delete log">
                                                        <i data-lucide="trash-2" style="width: 16px; height: 16px;"></i>
                                                    </button>
                                                ` : ''}
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                            
                            <!-- Pagination -->
                            <div class="flex items-center justify-between px-4 py-3 bg-black/20">
                                <button onclick="logsState.page = Math.max(1, logsState.page - 1); loadLogs();"
                                        class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg disabled:opacity-50 disabled:cursor-not-allowed transition"
                                        ${logsState.page <= 1 ? 'disabled' : ''}>
                                    <i data-lucide="chevron-left" style="width: 16px; height: 16px; display: inline-block;"></i> Previous
                                </button>
                                <span class="text-gray-400">
                                    Page ${logsState.page} of ${Math.ceil(logsState.total / logsState.limit) || 1}
                                </span>
                                <button onclick="logsState.page++; loadLogs();"
                                        class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg disabled:opacity-50 disabled:cursor-not-allowed transition"
                                        ${logsState.logs.length < logsState.limit ? 'disabled' : ''}>
                                    Next <i data-lucide="chevron-right" style="width: 16px; height: 16px; display: inline-block;"></i>
                                </button>
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        function renderIntegrationView() {
            return `
                <div class="space-y-6">
                    <!-- Header -->
                    <div class="text-center mb-8">
                        <h1 class="text-3xl font-bold mb-2" style="color: var(--text-primary);">
                            <i data-lucide="plug" class="inline-block text-primary mr-3" style="width: 32px; height: 32px; vertical-align: middle;"></i>
                            Integration Hub
                        </h1>
                        <p class="text-gray-400">Connect your infrastructure to Deployr in minutes</p>
                    </div>

                    <!-- Main Integration Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- API Key -->
                        <div class="card-glow rounded-xl p-6 flex flex-col">
                            <div class="flex items-center gap-3 mb-3">
                                <i data-lucide="key" class="text-primary" style="width: 24px; height: 24px;"></i>
                                <h3 class="text-xl font-bold text-white">API Key</h3>
                            </div>
                            <p class="text-sm text-gray-400 mb-4 h-10">Use your API key to authenticate requests to Deployr</p>
                            <div class="flex items-center gap-2 bg-black bg-opacity-50 rounded-lg p-3 mb-4">
                                <code class="text-sm text-gray-400 flex-1 truncate">sk_live_deployr_‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</code>
                                <button onclick="copyApiKey()" class="text-primary hover:text-cyan-300 transition p-1">
                                    <i data-lucide="copy" style="width: 18px; height: 18px;"></i>
                                </button>
                            </div>
                            <div class="flex gap-2 mt-auto">
                                <button onclick="showApiKey()" class="flex-1 py-2.5 text-sm font-medium rounded-lg bg-primary/10 text-primary hover:bg-primary/20 transition">
                                    Show Key
                                </button>
                                <button onclick="regenerateApiKey()" class="flex-1 py-2.5 text-sm font-medium rounded-lg border border-primary/30 text-primary hover:bg-primary/10 transition">
                                    Regenerate
                                </button>
                            </div>
                        </div>

                        <!-- Webhook -->
                        <div class="card-glow rounded-xl p-6 flex flex-col">
                            <div class="flex items-center gap-3 mb-3">
                                <i data-lucide="webhook" class="text-purple-400" style="width: 24px; height: 24px;"></i>
                                <h3 class="text-xl font-bold text-white">Webhooks</h3>
                            </div>
                            <p class="text-sm text-gray-400 mb-4 h-10">Receive real-time notifications for events</p>
                            <div class="flex items-center gap-2 bg-black bg-opacity-50 rounded-lg p-3 mb-4">
                                <code class="text-sm text-gray-400 flex-1 truncate">https://api.deployr.io/v1/webhook</code>
                                <button onclick="copyWebhook()" class="text-purple-400 hover:text-purple-300 transition p-1">
                                    <i data-lucide="copy" style="width: 18px; height: 18px;"></i>
                                </button>
                            </div>
                            <button onclick="configureWebhooks()" class="w-full py-2.5 text-sm font-medium rounded-lg bg-purple-500/10 text-purple-400 border border-purple-500/30 hover:bg-purple-500/20 transition mt-auto">
                                Configure Events
                            </button>
                        </div>

                        <!-- SDK & Agents -->
                        <div class="card-glow rounded-xl p-6 flex flex-col">
                            <div class="flex items-center gap-3 mb-3">
                                <i data-lucide="package" class="text-green-400" style="width: 24px; height: 24px;"></i>
                                <h3 class="text-xl font-bold text-white">SDK & Agents</h3>
                            </div>
                            <p class="text-sm text-gray-400 mb-4 h-10">Download SDKs for your preferred language</p>
                            <div class="grid grid-cols-2 gap-2 mb-4">
                                <button onclick="showSDKInstall('python')" class="py-2 px-3 bg-black bg-opacity-50 rounded-lg text-sm text-gray-300 hover:text-white hover:bg-opacity-70 transition flex items-center justify-center gap-2">
                                    <i data-lucide="file-code" style="width: 16px; height: 16px;"></i> Python
                                </button>
                                <button onclick="showSDKInstall('nodejs')" class="py-2 px-3 bg-black bg-opacity-50 rounded-lg text-sm text-gray-300 hover:text-white hover:bg-opacity-70 transition flex items-center justify-center gap-2">
                                    <i data-lucide="file-code" style="width: 16px; height: 16px;"></i> Node.js
                                </button>
                                <button onclick="showSDKInstall('go')" class="py-2 px-3 bg-black bg-opacity-50 rounded-lg text-sm text-gray-300 hover:text-white hover:bg-opacity-70 transition flex items-center justify-center gap-2">
                                    <i data-lucide="file-code" style="width: 16px; height: 16px;"></i> Go
                                </button>
                                <button onclick="showSDKInstall('java')" class="py-2 px-3 bg-black bg-opacity-50 rounded-lg text-sm text-gray-300 hover:text-white hover:bg-opacity-70 transition flex items-center justify-center gap-2">
                                    <i data-lucide="file-code" style="width: 16px; height: 16px;"></i> Java
                                </button>
                            </div>
                            <button onclick="showAllSDKs()" class="block w-full py-2.5 text-sm font-medium rounded-lg bg-green-500/10 text-green-400 border border-green-500/30 hover:bg-green-500/20 transition text-center mt-auto">
                                View All SDKs
                            </button>
                        </div>
                    </div>

                    <!-- Quick Setup Section -->
                    <div class="card-glow rounded-xl p-6">
                        <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                            <i data-lucide="terminal" class="text-primary" style="width: 22px; height: 22px;"></i>
                            Quick Setup
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-black bg-opacity-50 rounded-lg p-4 border border-gray-700">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="w-6 h-6 rounded-full bg-primary text-black text-sm font-bold flex items-center justify-center">1</span>
                                    <span class="font-semibold text-white">Install Agent</span>
                                </div>
                                <pre class="text-sm text-green-400 overflow-x-auto"><code>pip install deployr-agent</code></pre>
                            </div>
                            <div class="bg-black bg-opacity-50 rounded-lg p-4 border border-gray-700">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="w-6 h-6 rounded-full bg-primary text-black text-sm font-bold flex items-center justify-center">2</span>
                                    <span class="font-semibold text-white">Initialize</span>
                                </div>
                                <pre class="text-sm text-green-400 overflow-x-auto"><code>deployr init --api-key YOUR_KEY</code></pre>
                            </div>
                            <div class="bg-black bg-opacity-50 rounded-lg p-4 border border-gray-700">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="w-6 h-6 rounded-full bg-primary text-black text-sm font-bold flex items-center justify-center">3</span>
                                    <span class="font-semibold text-white">Connect</span>
                                </div>
                                <pre class="text-sm text-green-400 overflow-x-auto"><code>deployr connect</code></pre>
                            </div>
                        </div>
                    </div>

                    <!-- Integration Status -->
                    <div class="card-glow rounded-xl p-6">
                        <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                            <i data-lucide="activity" class="text-primary" style="width: 22px; height: 22px;"></i>
                            Connection Status
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div class="bg-black bg-opacity-30 rounded-lg p-4 border border-green-500/20">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="w-2 h-2 rounded-full bg-green-500"></span>
                                    <span class="text-sm text-gray-400">Agent Status</span>
                                </div>
                                <div class="text-xl font-bold text-green-400">Connected</div>
                            </div>
                            <div class="bg-black bg-opacity-30 rounded-lg p-4 border border-primary/20">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="w-2 h-2 rounded-full bg-primary"></span>
                                    <span class="text-sm text-gray-400">Last Sync</span>
                                </div>
                                <div class="text-xl font-bold text-white">2 min ago</div>
                            </div>
                            <div class="bg-black bg-opacity-30 rounded-lg p-4 border border-purple-500/20">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="w-2 h-2 rounded-full bg-purple-500"></span>
                                    <span class="text-sm text-gray-400">Webhooks</span>
                                </div>
                                <div class="text-xl font-bold text-purple-400">3 Active</div>
                            </div>
                            <div class="bg-black bg-opacity-30 rounded-lg p-4 border border-orange-500/20">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="w-2 h-2 rounded-full bg-orange-500"></span>
                                    <span class="text-sm text-gray-400">Events Today</span>
                                </div>
                                <div class="text-xl font-bold text-orange-400">1,247</div>
                            </div>
                        </div>
                    </div>

                    <!-- Documentation Links -->
                    <div class="card-glow rounded-xl p-6">
                        <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                            <i data-lucide="book-open" class="text-primary" style="width: 22px; height: 22px;"></i>
                            Documentation
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <button onclick="showDocumentation('getting-started')" class="flex items-center gap-3 p-4 bg-black bg-opacity-30 rounded-lg border border-gray-700 hover:border-primary/50 transition cursor-pointer text-left">
                                <i data-lucide="rocket" class="text-primary" style="width: 20px; height: 20px;"></i>
                                <span class="text-gray-300 hover:text-white">Getting Started</span>
                            </button>
                            <button onclick="showDocumentation('api-reference')" class="flex items-center gap-3 p-4 bg-black bg-opacity-30 rounded-lg border border-gray-700 hover:border-primary/50 transition cursor-pointer text-left">
                                <i data-lucide="code" class="text-primary" style="width: 20px; height: 20px;"></i>
                                <span class="text-gray-300 hover:text-white">API Reference</span>
                            </button>
                            <button onclick="showDocumentation('security-guide')" class="flex items-center gap-3 p-4 bg-black bg-opacity-30 rounded-lg border border-gray-700 hover:border-primary/50 transition cursor-pointer text-left">
                                <i data-lucide="shield" class="text-primary" style="width: 20px; height: 20px;"></i>
                                <span class="text-gray-300 hover:text-white">Security Guide</span>
                            </button>
                            <button onclick="showDocumentation('faq')" class="flex items-center gap-3 p-4 bg-black bg-opacity-30 rounded-lg border border-gray-700 hover:border-primary/50 transition cursor-pointer text-left">
                                <i data-lucide="help-circle" class="text-primary" style="width: 20px; height: 20px;"></i>
                                <span class="text-gray-300 hover:text-white">FAQ</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderSubscriptionView() {
            if (!subscription) return '<div class="text-center">Loading subscription...</div>';

            const daysRemaining = getDaysRemaining();
            const isTrialing = subscription.status === 'trialing';
            const isActive = subscription.status === 'active';
            const isExpired = subscription.status === 'expired';
            const currentPlan = subscription.plan || 'free';

            return `
                <div class="relative -mx-6 -mt-6 px-6 pt-6 pb-12 min-h-screen" style="
                    background: 
                        radial-gradient(ellipse at 20% 20%, rgba(0, 188, 212, 0.06) 0%, transparent 50%),
                        radial-gradient(ellipse at 80% 30%, rgba(139, 92, 246, 0.06) 0%, transparent 50%),
                        linear-gradient(180deg, var(--bg-dark) 0%, #0a0a0f 100%);
                ">
                    <!-- Header -->
                    <div class="text-center mb-12 relative">
                        <h2 class="text-5xl font-bold mb-3" style="color: #FFFFFF;">
                            Ascend to Royalty
                        </h2>
                        <p class="text-xl" style="color: var(--text-secondary);">Unlock Exclusive DevOps Privileges</p>
                    </div>

                    <!-- Pricing Cards -->
                    <div class="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
                        
                        <!-- Essential Plan - Free -->
                        <div class="subscription-card relative rounded-2xl p-6 transition-all duration-300 flex flex-col" style="
                            background: linear-gradient(180deg, rgba(30, 35, 45, 0.9) 0%, rgba(20, 25, 30, 0.95) 100%);
                            border: 1px solid rgba(100, 100, 100, 0.3);
                            min-height: 580px;
                        ">
                            <div class="mb-6">
                                <h3 class="text-2xl font-bold mb-2" style="color: #FFFFFF;">Essential</h3>
                                <div class="flex items-baseline gap-1">
                                    <span class="text-4xl font-bold" style="color: var(--primary);">Free</span>
                                    <span class="text-sm" style="color: var(--text-muted);">/forever</span>
                                </div>
                            </div>
                            
                            <div class="space-y-3 flex-grow">
                                ${renderPlanFeature('fa-eye', 'Incident Detection', true)}
                                ${renderPlanFeature('fa-chart-line', 'Basic Dashboard', true)}
                                ${renderPlanFeature('fa-history', 'Incident History (7 days)', true)}
                                ${renderPlanFeature('fa-server', 'Up to 3 Services', true)}
                                ${renderPlanFeature('fa-user-check', 'Supervised Mode Only', true)}
                                ${renderPlanFeature('fa-brain', 'AI Analysis', false)}
                                ${renderPlanFeature('fa-robot', 'Auto-Remediation', false)}
                                ${renderPlanFeature('fa-graduation-cap', 'Pattern Learning', false)}
                            </div>
                            
                            <button onclick="handleUpgrade('essential')" class="subscription-btn w-full py-3 rounded-xl font-bold transition mt-8" ${currentPlan === 'free' ? 'disabled' : ''}>
                                <i class="data-lucide="check" style="width: 16px; height: 16px;"-circle mr-2"></i>${currentPlan === 'free' ? 'Current Plan' : 'Select Plan'}
                            </button>
                        </div>

                        <!-- Advanced Plan - $199 (Most Popular) -->
                        <div class="subscription-card relative rounded-2xl p-6 transition-all duration-300 flex flex-col" style="
                            background: linear-gradient(180deg, rgba(30, 35, 45, 0.95) 0%, rgba(20, 25, 30, 0.98) 100%);
                            border: 2px solid var(--primary);
                            min-height: 580px;
                        ">
                            <!-- Most Popular Badge -->
                            <div class="absolute -top-3 right-6 px-4 py-1 rounded-full text-xs font-bold" style="
                                background: var(--primary);
                                color: #000;
                            ">Most Popular</div>
                            
                            <div class="mb-6">
                                <h3 class="text-2xl font-bold mb-2" style="color: #FFFFFF;">Advanced</h3>
                                <div class="flex items-baseline gap-1">
                                    <span class="text-lg" style="color: var(--text-muted);">$</span>
                                    <span class="text-4xl font-bold" style="color: var(--primary);">199</span>
                                    <span class="text-sm" style="color: var(--text-muted);">/month</span>
                                </div>
                            </div>
                            
                            <div class="space-y-3 flex-grow">
                                ${renderPlanFeature('fa-eye', 'Incident Detection', true)}
                                ${renderPlanFeature('fa-chart-line', 'Advanced Dashboard', true)}
                                ${renderPlanFeature('fa-history', 'Incident History (30 days)', true)}
                                ${renderPlanFeature('fa-server', 'Up to 15 Services', true)}
                                ${renderPlanFeature('fa-brain', 'AI Root Cause Analysis', true)}
                                ${renderPlanFeature('fa-robot', 'Auto-Remediation', true)}
                                ${renderPlanFeature('fa-graduation-cap', 'Pattern Learning', true)}
                                ${renderPlanFeature('fa-bell', 'Slack & Email Alerts', true)}
                                ${renderPlanFeature('fa-shield-alt', 'Autonomous Mode', true)}
                                ${renderPlanFeature('fa-clock', '1,000 Actions/month', true)}
                                ${renderPlanFeature('fa-globe', 'Single Region', true)}
                            </div>
                            
                            <button onclick="handleUpgrade('advanced')" class="subscription-btn w-full py-3 rounded-xl font-bold transition mt-8">
                                <i class="data-lucide="rocket" style="width: 16px; height: 16px;" mr-2"></i>Get Started
                            </button>
                        </div>

                        <!-- Ultimate Plan - $499 -->
                        <div class="subscription-card relative rounded-2xl p-6 transition-all duration-300 overflow-hidden flex flex-col" style="
                            background: linear-gradient(180deg, rgba(30, 35, 45, 0.9) 0%, rgba(20, 25, 30, 0.95) 100%);
                            border: 1px solid rgba(180, 180, 200, 0.4);
                            min-height: 580px;
                        ">
                            <!-- Silver shine effect -->
                            <div style="position: absolute; top: 0; left: 0; right: 0; height: 80px; background: linear-gradient(180deg, rgba(200, 200, 220, 0.15) 0%, transparent 100%); pointer-events: none;"></div>
                            
                            <div class="mb-6 relative">
                                <h3 class="text-2xl font-bold mb-2" style="color: #FFFFFF;">Ultimate</h3>
                                <div class="flex items-baseline gap-1">
                                    <span class="text-lg" style="color: var(--text-muted);">$</span>
                                    <span class="text-4xl font-bold" style="color: var(--primary);">499</span>
                                    <span class="text-sm" style="color: var(--text-muted);">/month</span>
                                </div>
                            </div>
                            
                            <div class="space-y-3 flex-grow relative">
                                <div class="text-sm font-semibold mb-2" style="color: var(--primary);">All Advanced Features with Higher Limits:</div>
                                ${renderPlanFeature('fa-infinity', 'Unlimited Services', true)}
                                ${renderPlanFeature('fa-history', 'Incident History (Unlimited)', true)}
                                ${renderPlanFeature('fa-clock', 'Unlimited Actions/month', true)}
                                ${renderPlanFeature('fa-globe', 'Multi-Region (Up to 5)', true)}
                                ${renderPlanFeature('fa-code-branch', 'Custom Runbooks', true)}
                                ${renderPlanFeature('fa-user-tie', 'Dedicated Account Manager', true)}
                                ${renderPlanFeature('fa-file-alt', 'Compliance Reports (SOC2, HIPAA)', true)}
                                ${renderPlanFeature('fa-headset', '24/7 Priority Support', true)}
                                ${renderPlanFeature('fa-lock', 'SSO & RBAC', true)}
                            </div>
                            
                            <button onclick="handleUpgrade('ultimate')" class="subscription-btn w-full py-3 rounded-xl font-bold transition mt-8">
                                <i class="data-lucide="crown" style="width: 16px; height: 16px;" mr-2"></i>Get Started
                            </button>
                        </div>
                    </div>

                    <!-- FAQ Section -->
                    <div class="max-w-4xl mx-auto" style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 32px;">
                        <h3 class="text-2xl font-bold mb-6">Frequently Asked Questions</h3>
                        <div class="space-y-4">
                            <div class="p-4 rounded-lg" style="background: var(--bg-dark);">
                                <div class="font-bold mb-2"><i class="data-lucide="help-circle" style="width: 16px; height: 16px;" text-primary mr-2"></i>Can I switch plans anytime?</div>
                                <p style="color: var(--text-secondary);">Yes! You can upgrade or downgrade your plan at any time. Changes take effect immediately.</p>
                            </div>
                            <div class="p-4 rounded-lg" style="background: var(--bg-dark);">
                                <div class="font-bold mb-2"><i class="data-lucide="help-circle" style="width: 16px; height: 16px;" text-primary mr-2"></i>What happens to my data if I downgrade?</div>
                                <p style="color: var(--text-secondary);">Your incident history and learned patterns are preserved. Premium features are simply disabled until you upgrade again.</p>
                            </div>
                            <div class="p-4 rounded-lg" style="background: var(--bg-dark);">
                                <div class="font-bold mb-2"><i class="data-lucide="help-circle" style="width: 16px; height: 16px;" text-primary mr-2"></i>Is there a free trial for paid plans?</div>
                                <p style="color: var(--text-secondary);">Yes! All new users get a 14-day free trial of Advanced features. No credit card required to start.</p>
                            </div>
                        </div>
                        
                        <div class="mt-6 pt-6" style="border-top: 1px solid var(--border);">
                            <a href="#" class="text-primary hover:underline"><i class="data-lucide="headphones" style="width: 16px; height: 16px;" mr-2"></i>Contact Support</a>
                        </div>
                    </div>
                </div>
                `;
        }

        function renderPlanFeature(icon, name, included, type = 'normal') {
            const highlightStyle = type === 'highlight' ? 'background: rgba(0, 188, 212, 0.15); padding: 8px 12px; margin: -4px -12px; border-radius: 8px;' : '';
            return `
                <div class="flex items-center justify-between" style="${highlightStyle}">
                    <div class="flex items-center gap-3">
                        <i class="fas ${icon} w-5 text-center" style="color: ${included ? 'var(--primary)' : 'var(--text-muted)'};"></i>
                        <span style="color: ${included ? '#FFFFFF' : 'var(--text-muted)'}; ${!included ? 'text-decoration: line-through;' : ''}">${name}</span>
                    </div>
                    ${included ? '<i class="data-lucide="check" style="width: 16px; height: 16px;"" style="color: var(--primary);"></i>' : '<i class="data-lucide="x" style="width: 16px; height: 16px;"" style="color: var(--text-muted);"></i>'}
                </div>
            `;
        }

        function renderFeatureRow(name, allowed, status) {
            return `
                <div class="flex items-center justify-between p-3 bg-black bg-opacity-30 rounded-lg">
                    <div class="flex items-center gap-3">
                        <i class="fas ${allowed ? 'fa-check-circle text-green-500' : 'fa-lock text-red-500'}"></i>
                        <span class="${allowed ? '' : 'text-gray-500'}">${name}</span>
                    </div>
                    <span class="text-sm ${allowed ? 'text-green-400' : 'text-red-400'}">${status}</span>
                </div>
            `;
        }

        // Continuing with existing render functions...
        function renderControlCenter() {
            const critical = state.incidents.filter(i => i.severity === 'critical').length;
            const pending = state.pendingActions.length;
            const autoSuccess = state.outcomes.filter(o => o.success).length;
            const autoTotal = state.outcomes.length;
            const successRate = autoTotal > 0 ? ((autoSuccess / autoTotal) * 100).toFixed(1) : 0;
            const isPremiumLocked = !isFeatureAllowed('auto_remediation');

            return `
                <div class="space-y-6">
                    ${isPremiumLocked ? `
                        <div class="bg-orange-900/20 border-2 border-orange-600 rounded-xl p-6">
                            <div class="flex items-start gap-4">
                                <i class="data-lucide="alert-triangle" style="width: 16px; height: 16px;" text-orange-500 text-3xl"></i>
                                <div class="flex-1">
                                    <h3 class="text-xl font-bold mb-2">Premium Features Locked</h3>
                                    <p class="text-gray-300 mb-4">
                                        Your trial has ended. Upgrade to Pro to restore AI monitoring, auto-remediation, and real-time alerts.
                                    </p>
                                    <button onclick="showUpgradeModal()" class="bg-orange-600 hover:bg-orange-700 px-6 py-3 rounded-lg font-bold transition">
                                        <i class="data-lucide="crown" style="width: 16px; height: 16px;" mr-2"></i>Upgrade Now
                                    </button>
                                </div>
                            </div>
                        </div>
                    ` : ''}

                    <div class="card-glow rounded-xl p-6">
                        <h2 class="text-2xl font-bold mb-6 flex items-center gap-3">
                            <i data-lucide="layout-grid" class="text-primary" style="width: 24px; height: 24px;"></i>
                            <span style="color: var(--primary);">System Health Overview</span>
                        </h2>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <!-- Phase 1: Detection -->
                            <div class="phase-card phase-detection">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="font-bold text-lg">Phase 1: Detection</h3>
                                    <span class="px-3 py-1 rounded-full text-xs font-bold" style="background: rgba(59, 130, 246, 0.2); color: #60A5FA; box-shadow: 0 0 10px rgba(59, 130, 246, 0.3);">ACTIVE</span>
                                </div>
                                <div class="space-y-4">
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm" style="color: var(--text-muted);">Critical Incidents</span>
                                        <span class="text-2xl font-bold ${critical > 0 ? 'status-critical' : 'status-healthy'}">${critical}</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm" style="color: var(--text-muted);">Anomalies (24h)</span>
                                        <span class="text-2xl font-bold status-warning">${state.anomalies.length}</span>
                                    </div>
                                    <div class="progress-bar mt-2">
                                        <div class="progress-fill" style="width: ${Math.min(state.anomalies.length * 5, 100)}%;"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Phase 2: Supervised -->
                            <div class="phase-card phase-supervised ${isPremiumLocked ? 'opacity-50' : ''}">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="font-bold text-lg">Phase 2: Supervised</h3>
                                    <span class="px-3 py-1 rounded-full text-xs font-bold" style="background: ${isPremiumLocked ? 'rgba(100, 100, 100, 0.2)' : 'rgba(168, 85, 247, 0.2)'}; color: ${isPremiumLocked ? '#888' : '#C084FC'}; box-shadow: 0 0 10px ${isPremiumLocked ? 'transparent' : 'rgba(168, 85, 247, 0.3)'};">
                                        ${isPremiumLocked ? 'LOCKED' : 'ACTIVE'}
                                    </span>
                                </div>
                                <div class="space-y-4">
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm" style="color: var(--text-muted);">Pending Approval</span>
                                        <span class="text-2xl font-bold ${isPremiumLocked ? '' : pending > 0 ? 'status-warning' : ''}" style="color: ${isPremiumLocked ? 'var(--text-muted)' : ''}">${isPremiumLocked ? '‚Äî' : pending}</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm" style="color: var(--text-muted);">Actions Learned</span>
                                        <span class="text-2xl font-bold" style="color: #C084FC;">${state.learningStats.total_actions_recorded || 0}</span>
                                    </div>
                                    <div class="progress-bar mt-2">
                                        <div class="progress-fill" style="width: ${Math.min((state.learningStats.total_actions_recorded || 0) * 3, 100)}%; background: linear-gradient(90deg, #A855F7, #C084FC);"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Phase 3: Autonomous -->
                            <div class="phase-card phase-autonomous ${isPremiumLocked ? 'opacity-50' : ''}">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="font-bold text-lg">Phase 3: Autonomous</h3>
                                    <span class="px-3 py-1 rounded-full text-xs font-bold" style="background: ${isPremiumLocked ? 'rgba(100, 100, 100, 0.2)' : 'rgba(34, 197, 94, 0.2)'}; color: ${isPremiumLocked ? '#888' : '#4ADE80'}; box-shadow: 0 0 10px ${isPremiumLocked ? 'transparent' : 'rgba(34, 197, 94, 0.3)'};">
                                        ${isPremiumLocked ? 'LOCKED' : state.autonomousStatus?.autonomous_enabled ? 'ENABLED' : 'DISABLED'}
                                    </span>
                                </div>
                                <div class="space-y-4">
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm" style="color: var(--text-muted);">Success Rate</span>
                                        <span class="text-2xl font-bold ${isPremiumLocked ? '' : 'status-healthy'}" style="color: ${isPremiumLocked ? 'var(--text-muted)' : ''}">${isPremiumLocked ? '‚Äî' : successRate}%</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm" style="color: var(--text-muted);">Auto Executed</span>
                                        <span class="text-2xl font-bold status-healthy">${isPremiumLocked ? '‚Äî' : autoSuccess}</span>
                                    </div>
                                    <div class="progress-bar mt-2">
                                        <div class="progress-fill" style="width: ${successRate}%; background: linear-gradient(90deg, #22C55E, #4ADE80);"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Incident Trend Chart -->
                        <div class="chart-container mb-6">
                            <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                                <i class="data-lucide="area-chart" style="width: 16px; height: 16px;" gradient-text"></i>
                                Incident Trend (24h)
                            </h3>
                            <div style="height: 200px;">
                                <canvas id="incidentTrendChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Learning Intelligence Panel -->
                    <div class="card-glow rounded-xl p-6 mb-6">
                        <h2 class="text-2xl font-bold mb-6 flex items-center gap-3">
                            <i data-lucide="brain" class="text-primary" style="width: 28px; height: 28px;"></i>
                            <span style="color: var(--primary);">Learning Intelligence</span>
                            <span class="ml-auto px-3 py-1 rounded-full text-xs font-bold" style="background: rgba(0, 188, 212, 0.2); color: var(--primary);">
                                ${state.learningStats?.total_patterns || '580+'}+ Patterns
                            </span>
                        </h2>
                        
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                            <!-- Knowledge Base Stats -->
                            <div class="bg-black bg-opacity-30 rounded-lg p-4 border border-primary/20 hover:border-primary/50 transition">
                                <div class="flex items-center gap-2 mb-2">
                                    <i data-lucide="book-open" class="text-primary" style="width: 20px; height: 20px;"></i>
                                    <span class="text-sm text-gray-400">Knowledge Base</span>
                                </div>
                                <div class="text-3xl font-bold text-white">${state.learningStats?.total_patterns || 580}</div>
                                <div class="text-xs text-gray-500">Total Patterns</div>
                            </div>
                            
                            <!-- Autonomous Safe -->
                            <div class="bg-black bg-opacity-30 rounded-lg p-4 border border-green-500/20 hover:border-green-500/50 transition">
                                <div class="flex items-center gap-2 mb-2">
                                    <i data-lucide="shield-check" class="text-green-400" style="width: 20px; height: 20px;"></i>
                                    <span class="text-sm text-gray-400">Autonomous Safe</span>
                                </div>
                                <div class="text-3xl font-bold text-green-400">${state.learningStats?.autonomous_safe || 45}</div>
                                <div class="text-xs text-gray-500">Auto-Execute Ready</div>
                            </div>
                            
                            <!-- Learning Rate -->
                            <div class="bg-black bg-opacity-30 rounded-lg p-4 border border-purple-500/20 hover:border-purple-500/50 transition">
                                <div class="flex items-center gap-2 mb-2">
                                    <i data-lucide="target" class="text-purple-400" style="width: 20px; height: 20px;"></i>
                                    <span class="text-sm text-gray-400">Success Rate</span>
                                </div>
                                <div class="text-3xl font-bold text-purple-400">${state.learningStats?.success_rate || 94}%</div>
                                <div class="text-xs text-gray-500">Action Accuracy</div>
                            </div>
                            
                            <!-- Patterns Promoted -->
                            <div class="bg-black bg-opacity-30 rounded-lg p-4 border border-cyan-500/20 hover:border-cyan-500/50 transition">
                                <div class="flex items-center gap-2 mb-2">
                                    <i data-lucide="trending-up" class="text-cyan-400" style="width: 20px; height: 20px;"></i>
                                    <span class="text-sm text-gray-400">Promoted</span>
                                </div>
                                <div class="text-3xl font-bold text-cyan-400">${state.learningStats?.patterns_promoted || 12}</div>
                                <div class="text-xs text-gray-500">To Autonomous</div>
                            </div>
                        </div>
                        
                        <!-- Pattern Categories Breakdown -->
                        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-3">
                            ${renderPatternCategoryBadge('kubernetes', 'fa-dharmachakra', '#326CE5', state.learningStats?.by_category?.kubernetes || 150)}
                            ${renderPatternCategoryBadge('database', 'fa-database', '#336791', state.learningStats?.by_category?.database || 130)}
                            ${renderPatternCategoryBadge('cloud', 'fa-cloud', '#FF9900', state.learningStats?.by_category?.cloud || 100)}
                            ${renderPatternCategoryBadge('application', 'fa-code', '#68A063', state.learningStats?.by_category?.application || 55)}
                            ${renderPatternCategoryBadge('cicd', 'fa-rocket', '#FC6D26', state.learningStats?.by_category?.cicd || 45)}
                            ${renderPatternCategoryBadge('network', 'fa-network-wired', '#00BCD4', state.learningStats?.by_category?.network || 32)}
                            ${renderPatternCategoryBadge('security', 'fa-shield-alt', '#E53935', state.learningStats?.by_category?.security || 30)}
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        ${renderRecentIncidents()}
                        ${renderRecentActions()}
                    </div>
                </div>
            `;
        }

        function renderRecentIncidents() {
            const recent = state.incidents.slice(0, 5);
            return `
                <div class="card rounded-xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold">
                            <i class="data-lucide="alert-triangle" style="width: 16px; height: 16px;" text-primary mr-2"></i>Recent Incidents
                        </h3>
                        <button onclick="switchView('incidents')" class="text-sm text-primary hover:text-primary-light">
                            View All <i class="data-lucide="arrow-right" style="width: 16px; height: 16px;" ml-1"></i>
                        </button>
                    </div>
                    
                    ${recent.length > 0 ? `
                        <div class="space-y-2">
                            ${recent.map(inc => `
                                <div class="bg-black bg-opacity-30 rounded-lg p-3 hover:bg-opacity-40 transition cursor-pointer">
                                    <div class="flex items-center justify-between mb-1">
                                        <span class="font-semibold">
                                            <i class="data-lucide="server" style="width: 16px; height: 16px;" text-primary mr-2"></i>${inc.service}
                                        </span>
                                        <span class="px-2 py-1 rounded text-xs font-bold ${getSeverityClass(inc.severity)}">
                                            ${inc.severity}
                                        </span>
                                    </div>
                                    <div class="text-sm text-gray-400 truncate">${inc.root_cause}</div>
                                </div>
                            `).join('')}
                        </div>
                    ` : '<div class="text-center py-8 text-gray-500"><i class="data-lucide="check" style="width: 16px; height: 16px;"-circle text-4xl text-green-500 mb-2"></i><br>No recent incidents</div>'}
                </div>
            `;
        }

        function renderRecentActions() {
            const recent = state.actionHistory.slice(0, 5);
            const isPremiumLocked = !isFeatureAllowed('auto_remediation');

            return `
                <div class="card rounded-xl p-6 ${isPremiumLocked ? 'opacity-50' : ''}">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold">
                            <i class="data-lucide="zap" style="width: 16px; height: 16px;" text-primary mr-2"></i>Recent Actions
                            ${isPremiumLocked ? '<i class="data-lucide="lock" style="width: 16px; height: 16px;" text-sm ml-2 text-red-500"></i>' : ''}
                        </h3>
                    </div>
                    
                    ${isPremiumLocked ? `
                        <div class="text-center py-8">
                            <i class="data-lucide="lock" style="width: 16px; height: 16px;" text-4xl text-red-500 mb-4"></i>
                            <p class="text-gray-400 mb-4">Premium feature locked</p>
                            <button onclick="showUpgradeModal()" class="bg-primary hover:bg-primary-dark text-black px-4 py-2 rounded-lg font-semibold transition">
                                Upgrade to Access
                            </button>
                        </div>
                    ` : recent.length > 0 ? `
                        <div class="space-y-2">
                            ${recent.map(action => `
                                <div class="bg-black bg-opacity-30 rounded-lg p-3">
                                    <div class="flex items-center justify-between mb-1">
                                        <span class="font-semibold">
                                            <i class="data-lucide="settings" style="width: 16px; height: 16px;" text-primary mr-2"></i>${action.action_type}
                                        </span>
                                        <span class="px-2 py-1 rounded text-xs font-bold ${getStatusClass(action.status)}">
                                            ${action.status}
                                        </span>
                                    </div>
                                    <div class="text-sm text-gray-400">${action.service}</div>
                                </div>
                            `).join('')}
                        </div>
                    ` : '<div class="text-center py-8 text-gray-500">No recent actions</div>'}
                </div>
            `;
        }

        // Stub render functions for other views
        function renderIncidentsView() {
            const filteredIncidents = getFilteredIncidents();
            const hasActiveFilters = incidentFilters.severity !== 'all' || incidentFilters.service !== 'all' || incidentFilters.dateRange !== '7d';

            return `
                <div class="space-y-6">
                    <div class="flex items-center justify-between flex-wrap gap-4">
                        <h2 class="text-2xl font-bold">
                            <i class="data-lucide="alert-triangle" style="width: 16px; height: 16px;" text-primary mr-2"></i>Incident Management
                        </h2>
                        <div class="flex gap-2">
                            <button onclick="showFilterModal()" class="card hover:bg-opacity-80 px-4 py-2 rounded-lg text-sm flex items-center gap-2 transition ${hasActiveFilters ? 'border border-primary' : ''}">
                                <i data-lucide="filter" style="width: 16px; height: 16px;"></i>Filter
                                ${hasActiveFilters ? '<span class="w-2 h-2 rounded-full bg-primary"></span>' : ''}
                            </button>
                            <button onclick="showExportModal()" class="card hover:bg-opacity-80 px-4 py-2 rounded-lg text-sm flex items-center gap-2 transition">
                                <i data-lucide="download" style="width: 16px; height: 16px;"></i>Export
                            </button>
                        </div>
                    </div>
                    
                    ${hasActiveFilters ? `
                        <div class="flex items-center gap-2 flex-wrap">
                            <span class="text-sm text-gray-400">Active filters:</span>
                            ${incidentFilters.severity !== 'all' ? `<span class="px-2 py-1 bg-primary/20 text-primary rounded text-xs">${incidentFilters.severity}</span>` : ''}
                            ${incidentFilters.service !== 'all' ? `<span class="px-2 py-1 bg-primary/20 text-primary rounded text-xs">${incidentFilters.service}</span>` : ''}
                            ${incidentFilters.dateRange !== '7d' ? `<span class="px-2 py-1 bg-primary/20 text-primary rounded text-xs">${incidentFilters.dateRange}</span>` : ''}
                            <button onclick="resetFilters()" class="text-xs text-gray-400 hover:text-white underline">Clear all</button>
                        </div>
                    ` : ''}

                    ${filteredIncidents.length > 0 ? `
                        <div class="space-y-3">
                            ${filteredIncidents.map(inc => `
                                <div class="card rounded-xl p-6 border-l-4 ${inc.severity === 'critical' ? 'border-red-500' : inc.severity === 'high' ? 'border-orange-500' : 'border-yellow-500'} hover:shadow-xl transition">
                                    <div class="flex items-start justify-between mb-4">
                                        <div class="flex-1">
                                            <div class="flex items-center gap-3 mb-2">
                                                <i data-lucide="${inc.severity === 'critical' ? 'alert-circle' : 'alert-triangle'}" class="${inc.severity === 'critical' ? 'text-red-500' : 'text-orange-500'}" style="width: 28px; height: 28px;"></i>
                                                <div>
                                                    <h3 class="font-bold text-lg">${inc.title || inc.service}</h3>
                                                    <div class="text-sm text-gray-400">
                                                        ${inc.service} ‚Ä¢ ${new Date(inc.timestamp).toLocaleString()}
                                                    </div>
                                                </div>
                                            </div>
                                            <p class="text-gray-300 mb-3">${inc.description || 'No description available'}</p>
                                            <div class="flex gap-4 text-sm">
                                                <span class="text-gray-400">
                                                    <i data-lucide="server" style="width: 14px; height: 14px; display: inline;"></i> ${inc.affected_pods || 1} pods affected
                                                </span>
                                                <span class="text-primary">
                                                    <i data-lucide="percent" style="width: 14px; height: 14px; display: inline;"></i> ${inc.confidence || inc.analysis?.root_cause?.confidence || 60}% confidence
                                                </span>
                                                <span class="text-gray-400">
                                                    <i data-lucide="tag" style="width: 14px; height: 14px; display: inline;"></i> ${inc.type || inc.analysis?.severity || 'latency_spike'}
                                                </span>
                                            </div>
                                            ${inc.suggested_action ? `
                                                <div class="mt-3 p-3 bg-black bg-opacity-30 rounded-lg border border-primary/20">
                                                    <span class="text-xs text-primary font-semibold">Suggested Action:</span>
                                                    <p class="text-sm text-gray-300 mt-1">${inc.suggested_action}</p>
                                                </div>
                                            ` : ''}
                                            <div class="mt-4 flex gap-2">
                                                <button onclick="resolveIncident('${inc.id}', 'autonomous')" class="px-4 py-2 rounded-lg text-sm font-semibold bg-green-600 hover:bg-green-500 text-white transition flex items-center gap-2">
                                                    <i data-lucide="bot" style="width: 14px; height: 14px;"></i>Resolve Auto
                                                </button>
                                                <button onclick="resolveIncident('${inc.id}', 'manual')" class="px-4 py-2 rounded-lg text-sm font-semibold bg-blue-600 hover:bg-blue-500 text-white transition flex items-center gap-2">
                                                    <i data-lucide="user" style="width: 14px; height: 14px;"></i>Resolve Manual
                                                </button>
                                            </div>
                                        </div>
                                        <span class="px-3 py-1 rounded-full text-xs font-bold ${getSeverityClass(inc.severity)}">
                                            ${inc.severity.toUpperCase()}
                                        </span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : `
                        <div class="card rounded-xl p-12 text-center">
                            <i class="data-lucide="check" style="width: 16px; height: 16px;"-circle text-6xl text-green-500 mb-4"></i>
                            <p class="text-xl font-semibold mb-2">No Active Incidents</p>
                            <p class="text-gray-400">All systems operating normally</p>
                        </div>
                    `}
                    
                    ${state.resolvedIncidents.length > 0 ? `
                        <div class="mt-8">
                            <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                                <i data-lucide="check-circle" class="text-green-500" style="width: 20px; height: 20px;"></i>
                                Resolved Incidents History
                                <span class="text-sm font-normal text-gray-400">(${state.resolvedIncidents.length})</span>
                            </h3>
                            <div class="space-y-2">
                                ${state.resolvedIncidents.slice(0, 10).map(inc => `
                                    <div class="card rounded-lg p-4 border-l-4 ${inc.resolution_mode === 'autonomous' ? 'border-green-500 bg-green-900/10' : 'border-blue-500 bg-blue-900/10'}">
                                        <div class="flex items-center justify-between">
                                            <div class="flex-1">
                                                <div class="flex items-center gap-3 mb-1">
                                                    <i data-lucide="${inc.resolution_mode === 'autonomous' ? 'bot' : 'user'}" class="${inc.resolution_mode === 'autonomous' ? 'text-green-400' : 'text-blue-400'}" style="width: 18px; height: 18px;"></i>
                                                    <span class="font-bold">${inc.title || inc.service}</span>
                                                    <span class="px-2 py-0.5 rounded text-xs font-semibold ${inc.resolution_mode === 'autonomous' ? 'bg-green-600/30 text-green-400' : 'bg-blue-600/30 text-blue-400'}">
                                                        ${inc.resolution_mode === 'autonomous' ? 'AUTO RESOLVED' : 'MANUAL'}
                                                    </span>
                                                </div>
                                                <div class="text-sm text-gray-400">
                                                    ${inc.service} ‚Ä¢ Resolved by ${inc.resolved_by} ‚Ä¢ ${new Date(inc.resolved_at).toLocaleString()}
                                                </div>
                                            </div>
                                            <span class="px-3 py-1 rounded-full text-xs font-bold bg-green-600/20 text-green-400">
                                                RESOLVED
                                            </span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            ${state.resolvedIncidents.length > 10 ? `
                                <div class="text-center mt-4">
                                    <button class="text-primary hover:underline text-sm">View all ${state.resolvedIncidents.length} resolved incidents</button>
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderActionsView() {
            const isPremiumLocked = !isFeatureAllowed('auto_remediation');
            if (isPremiumLocked) {
                return `
                    <div class="text-center py-20">
                        <i class="data-lucide="lock" style="width: 16px; height: 16px;" text-6xl text-red-500 mb-6"></i>
                        <h2 class="text-3xl font-bold mb-4">Premium Feature</h2>
                        <p class="text-gray-400 mb-6 max-w-md mx-auto">
                            Action management requires an active subscription. Upgrade to access AI-powered auto-remediation.
                        </p>
                        <button onclick="showUpgradeModal()" class="bg-primary hover:bg-primary-dark text-black px-8 py-4 rounded-lg font-bold text-lg transition">
                            <i class="data-lucide="arrow-up" style="width: 16px; height: 16px;" mr-2"></i>Upgrade Now
                        </button>
                    </div>
                `;
            }

            return `
                <div class="space-y-6">
                    <h2 class="text-2xl font-bold">
                        <i class="data-lucide="zap" style="width: 16px; height: 16px;" text-primary mr-2"></i>Action Management
                    </h2>

                    ${state.pendingActions.length > 0 ? `
                        <div class="bg-orange-900/20 border-2 border-orange-600/50 rounded-xl p-6">
                            <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                                <i class="data-lucide="clock" style="width: 16px; height: 16px;" text-orange-400"></i>
                                Pending Approval (${state.pendingActions.length})
                            </h3>
                            <div class="space-y-4">
                                ${state.pendingActions.map(action => `
                                    <div class="card rounded-lg p-5 border-l-4 ${action.risk === 'low' ? 'border-green-500' : action.risk === 'high' ? 'border-red-500' : 'border-orange-500'}">
                                        <div class="flex items-start justify-between mb-3">
                                            <div class="flex-1">
                                                <div class="flex items-center gap-3 mb-2">
                                                    <h4 class="text-lg font-bold">${action.action_type.replace(/_/g, ' ').toUpperCase()}</h4>
                                                    <span class="px-2 py-1 rounded-full text-xs font-bold ${getRiskClass(action.risk)}">
                                                        <i class="data-lucide="shield" style="width: 16px; height: 16px;" mr-1"></i>${action.risk.toUpperCase()} RISK
                                                    </span>
                                                </div>
                                                <div class="text-sm text-gray-400 mb-2">
                                                    <i class="data-lucide="server" style="width: 16px; height: 16px;" mr-1"></i>${action.service}
                                                </div>
                                                <div class="bg-black bg-opacity-30 rounded p-3 mb-3">
                                                    <div class="text-sm font-semibold mb-1">Reasoning:</div>
                                                    <div class="text-sm text-gray-300">${action.reasoning}</div>
                                                </div>
                                            </div>
                                            <div class="flex gap-2 ml-4">
                                                <button onclick="approveAction('${action.id}')" class="bg-green-600 hover:bg-green-700 px-6 py-3 rounded-lg font-bold transition">
                                                    <i class="data-lucide="check" style="width: 16px; height: 16px;" mr-2"></i>Approve
                                                </button>
                                                <button onclick="rejectAction('${action.id}')" class="bg-red-600 hover:bg-red-700 px-6 py-3 rounded-lg font-bold transition">
                                                    <i class="data-lucide="x" style="width: 16px; height: 16px;" mr-2"></i>Reject
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : `
                        <div class="card rounded-xl p-12 text-center">
                            <i class="data-lucide="check" style="width: 16px; height: 16px;"-circle text-6xl text-green-500 mb-4"></i>
                            <p class="text-xl font-semibold mb-2">No Pending Actions</p>
                            <p class="text-gray-400">All actions have been processed</p>
                        </div>
                    `}

                    <div class="card rounded-xl p-6">
                        <h3 class="text-xl font-bold mb-4">
                            <i class="data-lucide="history" style="width: 16px; height: 16px;" text-primary mr-2"></i>Action History
                        </h3>
                        ${state.actionHistory.length > 0 ? `
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-black bg-opacity-30 border-b" style="border-color: var(--border);">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-bold">Action</th>
                                            <th class="px-4 py-3 text-left text-xs font-bold">Service</th>
                                            <th class="px-4 py-3 text-left text-xs font-bold">Status</th>
                                            <th class="px-4 py-3 text-left text-xs font-bold">Risk</th>
                                            <th class="px-4 py-3 text-left text-xs font-bold">Time</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y" style="border-color: var(--border);">
                                        ${state.actionHistory.map(action => `
                                            <tr class="hover:bg-black hover:bg-opacity-20 transition">
                                                <td class="px-4 py-3 font-semibold">${action.action_type}</td>
                                                <td class="px-4 py-3 text-sm">${action.service}</td>
                                                <td class="px-4 py-3">
                                                    <span class="px-2 py-1 rounded text-xs font-bold ${getStatusClass(action.status)}">
                                                        ${action.status}
                                                    </span>
                                                </td>
                                                <td class="px-4 py-3">
                                                    <span class="px-2 py-1 rounded text-xs font-bold ${getRiskClass(action.risk)}">
                                                        ${action.risk}
                                                    </span>
                                                </td>
                                                <td class="px-4 py-3 text-sm text-gray-400">${new Date(action.proposed_at).toLocaleString()}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : '<div class="text-center py-8 text-gray-500">No action history</div>'}
                    </div>
                </div>
            `;
        }

        function showNotification(message, type) {
            const notif = document.createElement('div');

            // Define colors for each type
            const colors = {
                'success': 'bg-green-600',
                'error': 'bg-red-600',
                'info': 'bg-blue-600',
                'warning': 'bg-orange-600'
            };

            const icons = {
                'success': 'fa-check-circle',
                'error': 'fa-exclamation-circle',
                'info': 'fa-info-circle',
                'warning': 'fa-exclamation-triangle'
            };

            notif.className = `fixed top-6 right-6 z-50 p-4 rounded-lg shadow-2xl slide-in ${colors[type] || colors.info}`;
            notif.innerHTML = `
                <div class="flex items-center gap-3">
                    <i class="fas ${icons[type] || icons.info} text-2xl"></i>
                    <span class="font-semibold">${message}</span>
                </div>
            `;

            document.body.appendChild(notif);

            // Auto-remove after 3 seconds
            setTimeout(() => {
                notif.style.opacity = '0';
                notif.style.transform = 'translateX(100%)';
                setTimeout(() => notif.remove(), 300);
            }, 3000);
        }

        function renderModeButton(mode, icon, label, description) {
            const currentMode = state.autonomousStatus?.execution_mode || 'supervised';
            const isActive = currentMode === mode;

            return `
                <button 
                    onclick="changeExecutionMode('${mode}')"
                    class="p-6 rounded-lg border-2 transition text-left cursor-pointer hover:shadow-lg ${isActive
                    ? 'border-primary bg-primary bg-opacity-10 shadow-lg'
                    : 'border-gray-700 hover:border-gray-600'
                }"
                    ${!AUTONOMOUS_ENABLED ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>
                    <div class="text-3xl mb-2">
                        <i class="fas ${icon} ${isActive ? 'text-primary' : 'text-gray-400'}"></i>
                    </div>
                    <div class="font-bold mb-1">${label}</div>
                    <div class="text-xs text-gray-400">${description}</div>
                    ${isActive ? '<div class="text-xs text-primary mt-2"><i class="data-lucide="check" style="width: 16px; height: 16px;" mr-1"></i>Active</div>' : ''}
                </button>
            `;
        }
        // ============================================================================
        // FIX 3: Updated renderAutonomousView() - Replace entire function
        // ============================================================================

        function renderAutonomousView() {
            const isPremiumLocked = !isFeatureAllowed('autonomous_mode');

            if (isPremiumLocked) {
                return `
                    <div class="text-center py-20">
                        <i class="data-lucide="bot" style="width: 16px; height: 16px;" text-6xl text-red-500 mb-6"></i>
                        <h2 class="text-3xl font-bold mb-4">Autonomous Mode Locked</h2>
                        <p class="text-gray-400 mb-6 max-w-md mx-auto">
                            Autonomous execution requires an active Pro subscription. Let AI handle incidents automatically.
                        </p>
                        <button onclick="showUpgradeModal()" class="bg-primary hover:bg-primary-dark text-black px-8 py-4 rounded-lg font-bold text-lg transition">
                            <i class="data-lucide="arrow-up" style="width: 16px; height: 16px;" mr-2"></i>Upgrade to Pro
                        </button>
                    </div>
                `;
            }

            // Check if autonomous mode is actually available (backend check)
            if (!state.autonomousStatus || state.autonomousStatus.autonomous_enabled === false) {
                return `
                    <div class="text-center py-20">
                        <i class="data-lucide="alert-triangle" style="width: 16px; height: 16px;" text-6xl text-yellow-500 mb-6"></i>
                        <h2 class="text-3xl font-bold mb-4">Autonomous Mode Unavailable</h2>
                        <p class="text-gray-400 mb-6 max-w-md mx-auto">
                            ${state.autonomousStatus?.message || 'Autonomous mode is not configured on the backend. Please check server configuration.'}
                        </p>
                        <div class="bg-gray-800 rounded-lg p-4 max-w-lg mx-auto text-left">
                            <p class="text-sm text-gray-300 mb-2"><strong>Backend Status:</strong></p>
                            <ul class="text-sm text-gray-400 space-y-1">
                                <li><i class="data-lucide="circle" style="width: 8px; height: 8px;" text-xs mr-1"></i>Autonomous Enabled: ${state.autonomousStatus?.autonomous_enabled ? '<i class="data-lucide="check" style="width: 16px; height: 16px;" text-green-500"></i>' : '<i class="data-lucide="x" style="width: 16px; height: 16px;" text-red-500"></i>'}</li>
                                <li><i class="data-lucide="circle" style="width: 8px; height: 8px;" text-xs mr-1"></i>User Has Access: ${state.autonomousStatus?.user_has_access ? '<i class="data-lucide="check" style="width: 16px; height: 16px;" text-green-500"></i>' : '<i class="data-lucide="x" style="width: 16px; height: 16px;" text-red-500"></i>'}</li>
                                <li><i class="data-lucide="circle" style="width: 8px; height: 8px;" text-xs mr-1"></i>User Plan: ${state.autonomousStatus?.user_plan || 'unknown'}</li>
                            </ul>
                        </div>
                    </div>
                `;
            }

            const status = state.autonomousStatus || {};
            const safety = state.safetyStatus || {};
            const outcomes = state.outcomes || [];
            const stats = outcomes.reduce((acc, o) => {
                acc.total++;
                if (o.success) acc.successes++;
                return acc;
            }, { total: 0, successes: 0 });
            stats.success_rate = stats.total > 0 ? (stats.successes / stats.total * 100).toFixed(1) : 0;

            return `
                <div class="space-y-6">
                    <h2 class="text-2xl font-bold">
                        <i class="data-lucide="bot" style="width: 16px; height: 16px;" text-primary mr-2"></i>Autonomous Execution Control
                    </h2>

                    <div class="card-glow rounded-xl p-6">
                        <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                            <i class="data-lucide="sliders" style="width: 16px; height: 16px;" gradient-text"></i>
                            <span>Execution Mode</span>
                        </h3>
                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                            ${(() => {
                    const modes = ['manual', 'supervised', 'autonomous', 'night_mode'];
                    const icons = {
                        manual: 'fa-hand-paper',
                        supervised: 'fa-eye',
                        autonomous: 'fa-robot',
                        night_mode: 'fa-moon'
                    };
                    const descriptions = {
                        manual: 'All actions require approval',
                        supervised: 'Low-risk auto-approved',
                        autonomous: 'High-confidence auto-exec',
                        night_mode: 'Auto during off-hours'
                    };
                    return modes.map(mode => {
                        const isActive = status.execution_mode === mode;
                        return `
                            <div onclick="changeExecutionMode('${mode}')" class="mode-card ${isActive ? 'active' : ''}">
                                <div class="mode-icon">
                                    <i class="fas ${icons[mode]}"></i>
                                </div>
                                <div class="font-bold mb-1">${mode.replace('_', ' ').toUpperCase()}</div>
                                <div class="text-xs mb-3" style="color: var(--text-muted);">${descriptions[mode]}</div>
                                ${isActive ? `
                                    <div class="flex items-center gap-2 text-xs">
                                        <span class="status-dot healthy"></span>
                                        <span class="status-healthy">Active</span>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('');
                })()}
                        </div>
                    </div>

                    <div class="card rounded-xl p-6">
                        <h3 class="text-xl font-bold mb-4">
                            <i class="data-lucide="trending-up" style="width: 16px; height: 16px;" text-primary mr-2"></i>Autonomous Performance
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-green-900/20 rounded-lg p-6 border border-green-700/50">
                                <div class="text-sm text-gray-400 mb-2">
                                    <i class="data-lucide="check" style="width: 16px; height: 16px;"-circle mr-1"></i>Success Rate
                                </div>
                                <div class="text-4xl font-bold text-green-400">${stats.success_rate}%</div>
                                <div class="text-sm text-gray-500 mt-1">${stats.successes} of ${stats.total} actions</div>
                            </div>
                            <div class="bg-blue-900/20 rounded-lg p-6 border border-blue-700/50">
                                <div class="text-sm text-gray-400 mb-2">
                                    <i class="data-lucide="zap" style="width: 16px; height: 16px;" mr-1"></i>Total Executed
                                </div>
                                <div class="text-4xl font-bold text-primary">${stats.total}</div>
                            </div>
                            <div class="bg-purple-900/20 rounded-lg p-6 border border-purple-700/50">
                                <div class="text-sm text-gray-400 mb-2">
                                    <i class="data-lucide="percent" style="width: 16px; height: 16px;" mr-1"></i>Avg Confidence
                                </div>
                                <div class="text-4xl font-bold text-purple-400">${status.confidence_threshold || 75}%</div>
                            </div>
                        </div>
                    </div>

                    <div class="card rounded-xl p-6">
                        <h3 class="text-xl font-bold mb-4">
                            <i class="data-lucide="shield" style="width: 16px; height: 16px;" text-primary mr-2"></i>Safety Rails Status
                        </h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <div class="bg-black bg-opacity-30 rounded-lg p-4">
                                <div class="text-sm text-gray-400 mb-1">Active Actions</div>
                                <div class="text-2xl font-bold">${safety.current_state?.active_actions || 0} / ${safety.limits?.max_concurrent_actions || 3}</div>
                            </div>
                            <div class="bg-black bg-opacity-30 rounded-lg p-4">
                                <div class="text-sm text-gray-400 mb-1">Cooldown Period</div>
                                <div class="text-2xl font-bold">${safety.limits?.action_cooldown_seconds || 300}s</div>
                            </div>
                            <div class="bg-black bg-opacity-30 rounded-lg p-4">
                                <div class="text-sm text-gray-400 mb-1">Recent Rollbacks</div>
                                <div class="text-2xl font-bold">${safety.current_state?.recent_rollbacks || 0} / ${safety.limits?.max_rollbacks_per_hour || 2}</div>
                            </div>
                        </div>
                    </div>

                    <div class="card rounded-xl p-6">
                        <h3 class="text-xl font-bold mb-4">
                            <i class="data-lucide="history" style="width: 16px; height: 16px;" text-primary mr-2"></i>Recent Autonomous Actions
                        </h3>
                        ${outcomes.length > 0 ? `
                            <div class="space-y-2">
                                ${outcomes.slice(0, 10).map(outcome => `
                                    <div class="p-4 rounded-lg border-l-4 ${outcome.success ? 'bg-green-900/20 border-green-500' : 'bg-red-900/20 border-red-500'}">
                                        <div class="flex items-center justify-between">
                                            <div class="flex-1">
                                                <div class="flex items-center gap-2 mb-1">
                                                    <i class="fas ${outcome.success ? 'fa-check-circle text-green-400' : 'fa-times-circle text-red-400'}"></i>
                                                    <span class="font-bold">${outcome.action_type}</span>
                                                    <span class="text-gray-400 text-sm">
                                                        <i class="data-lucide="percent" style="width: 16px; height: 16px;" mr-1"></i>Confidence: ${outcome.confidence || 85}%
                                                    </span>
                                                </div>
                                                <div class="text-sm text-gray-400">
                                                    <i class="data-lucide="clock" style="width: 16px; height: 16px;" mr-1"></i>${new Date(outcome.timestamp).toLocaleString()}
                                                </div>
                                            </div>
                                            <div class="text-lg font-bold ${outcome.success ? 'text-green-400' : 'text-red-400'}">
                                                ${outcome.success ? 'SUCCESS' : 'FAILED'}
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<div class="text-center py-8 text-gray-500"><i class="data-lucide="info" style="width: 16px; height: 16px;" text-4xl text-gray-600 mb-2"></i><br>No autonomous actions yet</div>'}
                    </div>
                </div>
            `;
        }

        // ============================================================================
        // NEW: Change Execution Mode Function
        // ============================================================================

        async function changeExecutionMode(mode) {
            try {
                const response = await fetch(`${API_BASE}/api/v3/autonomous/mode/public`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        mode: mode,
                        confidence_threshold: state.autonomousStatus?.confidence_threshold || 75
                    })
                });

                if (response.ok) {
                    showNotification(`Execution mode changed to ${mode}`, 'success');
                    await fetchAllData(); // Refresh data
                } else {
                    const error = await response.json();
                    showNotification(error.detail || 'Failed to change mode', 'error');
                }
            } catch (error) {
                showNotification('Error changing mode: ' + error.message, 'error');
            }
        }

        function renderServicesView() {
            return `
                <div class="space-y-6">
                    <h2 class="text-2xl font-bold">
                        <i class="data-lucide="server" style="width: 16px; height: 16px;" text-primary mr-2"></i>Service Health Dashboard
                    </h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${state.services.map(service => `
                            <div class="card rounded-xl p-6 border-l-4 ${service.status === 'healthy' ? 'border-green-500' : 'border-orange-500'} hover:shadow-xl transition">
                                <div class="flex items-center justify-between mb-4">
                                    <div>
                                        <h3 class="font-bold text-lg">${service.name}</h3>
                                        <div class="flex items-center gap-2 mt-1">
                                            <div class="w-2 h-2 rounded-full ${service.status === 'healthy' ? 'bg-green-500 animate-pulse' : 'bg-orange-500'}"></div>
                                            <span class="text-sm text-gray-400">${service.status}</span>
                                        </div>
                                    </div>
                                    <i class="fas ${service.status === 'healthy' ? 'fa-check-circle text-green-500' : 'fa-exclamation-triangle text-orange-500'} text-3xl"></i>
                                </div>

                                ${service.metrics ? `
                                    <div class="grid grid-cols-2 gap-3 mb-4">
                                        ${service.metrics.latency_ms ? `
                                            <div class="bg-blue-900/30 rounded-lg p-3 border border-blue-700/50">
                                                <div class="text-xs text-gray-400">
                                                    <i class="data-lucide="gauge" style="width: 16px; height: 16px;" mr-1"></i>Latency
                                                </div>
                                                <div class="text-lg font-bold">${service.metrics.latency_ms}ms</div>
                                            </div>
                                        ` : ''}
                                        ${service.metrics.error_rate_percent !== undefined ? `
                                            <div class="bg-red-900/30 rounded-lg p-3 border border-red-700/50">
                                                <div class="text-xs text-gray-400">
                                                    <i class="data-lucide="alert-triangle" style="width: 16px; height: 16px;" mr-1"></i>Error Rate
                                                </div>
                                                <div class="text-lg font-bold">${service.metrics.error_rate_percent} percent</div>
                                            </div>
                                        ` : ''}
                                    </div>
                                ` : ''}

                                <div class="flex justify-between text-sm text-gray-400 pt-3" style="border-top: 1px solid var(--border);">
                                    <span><i class="data-lucide="trending-up" style="width: 16px; height: 16px;" mr-1"></i>${service.anomaly_count} anomalies</span>
                                    <span><i class="data-lucide="alert-circle" style="width: 16px; height: 16px;" mr-1"></i>${service.incident_count} incidents</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderAnalyticsView() {
            const totalIncidents = state.incidents.length;
            const criticalIncidents = state.incidents.filter(i => i.severity === 'critical').length;
            const mediumIncidents = state.incidents.filter(i => i.severity === 'medium').length;
            const lowIncidents = state.incidents.filter(i => i.severity === 'low').length;
            const avgConfidence = state.incidents.length > 0
                ? state.incidents.reduce((sum, i) => sum + (i.confidence || 0), 0) / state.incidents.length
                : 0;

            // Calculate action breakdown from learning stats
            const actionBreakdown = state.learningStats?.action_breakdown || {};
            const autonomousActions = (actionBreakdown.autonomous_outcomes || 0) + (actionBreakdown.autonomous_resolutions || 0);
            const manualActions = (actionBreakdown.pending_actions || 0) + (actionBreakdown.manual_resolutions || 0);
            const totalActions = state.learningStats?.total_actions_recorded || 0;
            const autonomousRate = totalActions > 0 ? ((autonomousActions / totalActions) * 100).toFixed(1) : 0;

            // Calculate top services by incidents
            const serviceIncidentCounts = {};
            state.incidents.forEach(i => {
                serviceIncidentCounts[i.service] = (serviceIncidentCounts[i.service] || 0) + 1;
            });
            const topServices = Object.entries(serviceIncidentCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            // Create incident severity chart bars
            const maxSeverity = Math.max(criticalIncidents, mediumIncidents, lowIncidents, 1);
            const severityChartBars = `
                <div class="flex items-end gap-4 h-40 justify-center">
                    <div class="flex flex-col items-center">
                        <div class="w-16 bg-red-500 rounded-t transition-all" style="height: ${(criticalIncidents / maxSeverity) * 100}%;"></div>
                        <span class="text-xs mt-2 text-gray-400">Critical</span>
                        <span class="text-lg font-bold text-red-400">${criticalIncidents}</span>
                    </div>
                    <div class="flex flex-col items-center">
                        <div class="w-16 bg-yellow-500 rounded-t transition-all" style="height: ${(mediumIncidents / maxSeverity) * 100}%;"></div>
                        <span class="text-xs mt-2 text-gray-400">Medium</span>
                        <span class="text-lg font-bold text-yellow-400">${mediumIncidents}</span>
                    </div>
                    <div class="flex flex-col items-center">
                        <div class="w-16 bg-green-500 rounded-t transition-all" style="height: ${(lowIncidents / maxSeverity) * 100}%;"></div>
                        <span class="text-xs mt-2 text-gray-400">Low</span>
                        <span class="text-lg font-bold text-green-400">${lowIncidents}</span>
                    </div>
                </div>
            `;

            // Create action mode donut chart (CSS-based)
            const actionDonutChart = `
                <div class="flex items-center gap-6">
                    <div class="relative w-32 h-32">
                        <svg viewBox="0 0 36 36" class="w-full h-full">
                            <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                                fill="none" stroke="#374151" stroke-width="3"/>
                            <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                                fill="none" stroke="#10B981" stroke-width="3"
                                stroke-dasharray="${autonomousRate}, 100" stroke-linecap="round"/>
                        </svg>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <span class="text-2xl font-bold text-green-400">${autonomousRate}%</span>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-green-500"></div>
                            <span class="text-sm text-gray-300">Autonomous: ${autonomousActions}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-gray-600"></div>
                            <span class="text-sm text-gray-300">Manual: ${manualActions}</span>
                        </div>
                    </div>
                </div>
            `;

            // Create service health horizontal bars
            const serviceHealthBars = topServices.length > 0 ? topServices.map(([service, count]) => `
                <div class="space-y-1">
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-300 truncate" style="max-width: 150px;">${service}</span>
                        <span class="font-bold" style="color: var(--primary);">${count} incidents</span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-2">
                        <div class="h-2 rounded-full" style="width: ${Math.min((count / (topServices[0]?.[1] || 1)) * 100, 100)}%; background: linear-gradient(90deg, var(--primary), var(--primary-light));"></div>
                    </div>
                </div>
            `).join('') : '<p class="text-gray-400">No incidents yet</p>';

            return `
                <div class="space-y-6">
                    <h2 class="text-2xl font-bold flex items-center gap-2">
                        <i data-lucide="bar-chart-2" style="width: 24px; height: 24px; color: var(--primary);"></i>
                        Analytics and Insights
                    </h2>

                    <!-- Key Metrics Row -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="rounded-xl p-5 border-l-4 border-blue-500" style="background: var(--bg-card);">
                            <div class="text-xs mb-1 text-gray-400">Total Incidents</div>
                            <div class="text-3xl font-bold text-blue-400">${totalIncidents}</div>
                            <div class="text-xs text-gray-500 mt-1">Active in system</div>
                        </div>
                        <div class="rounded-xl p-5 border-l-4 border-green-500" style="background: var(--bg-card);">
                            <div class="text-xs mb-1 text-gray-400">Actions Recorded</div>
                            <div class="text-3xl font-bold text-green-400">${totalActions}</div>
                            <div class="text-xs text-gray-500 mt-1">${autonomousActions} autonomous</div>
                        </div>
                        <div class="rounded-xl p-5 border-l-4 border-purple-500" style="background: var(--bg-card);">
                            <div class="text-xs mb-1 text-gray-400">Avg Confidence</div>
                            <div class="text-3xl font-bold text-purple-400">${avgConfidence.toFixed(0)}%</div>
                            <div class="text-xs text-gray-500 mt-1">Analysis accuracy</div>
                        </div>
                        <div class="rounded-xl p-5 border-l-4" style="background: var(--bg-card); border-color: var(--primary);">
                            <div class="text-xs mb-1 text-gray-400">Services Monitored</div>
                            <div class="text-3xl font-bold" style="color: var(--primary);">${state.services.length}</div>
                            <div class="text-xs text-gray-500 mt-1">${state.services.filter(s => s.status === 'healthy').length} healthy</div>
                        </div>
                    </div>

                    <!-- Charts Row -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Incident Severity Chart -->
                        <div class="card rounded-xl p-6" style="background: var(--bg-card);">
                            <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                                <i data-lucide="pie-chart" style="width: 18px; height: 18px; color: var(--primary);"></i>
                                Incident Severity Distribution
                            </h3>
                            ${severityChartBars}
                        </div>

                        <!-- Action Mode Distribution -->
                        <div class="card rounded-xl p-6" style="background: var(--bg-card);">
                            <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                                <i data-lucide="bot" style="width: 18px; height: 18px; color: var(--primary);"></i>
                                Autonomous vs Manual Actions
                            </h3>
                            ${actionDonutChart}
                        </div>
                    </div>

                    <!-- More Charts Row -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Top Services by Incidents -->
                        <div class="card rounded-xl p-6" style="background: var(--bg-card);">
                            <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                                <i data-lucide="server" style="width: 18px; height: 18px; color: var(--primary);"></i>
                                Top Services by Incidents
                            </h3>
                            <div class="space-y-3">
                                ${serviceHealthBars}
                            </div>
                        </div>

                        <!-- Learning Progress -->
                        <div class="card rounded-xl p-6" style="background: var(--bg-card);">
                            <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                                <i data-lucide="brain" style="width: 18px; height: 18px; color: var(--primary);"></i>
                                Learning Progress
                            </h3>
                            <div class="space-y-4">
                                <div>
                                    <div class="flex justify-between mb-2 text-sm">
                                        <span class="text-gray-300">Incidents Analyzed</span>
                                        <span class="font-bold text-cyan-400">${state.learningStats.total_incidents_learned || 0}</span>
                                    </div>
                                    <div class="w-full bg-gray-700 rounded-full h-3">
                                        <div class="h-3 rounded-full bg-gradient-to-r from-cyan-500 to-blue-500" style="width: ${Math.min((state.learningStats.total_incidents_learned || 0) / 5, 100)}%;"></div>
                                    </div>
                                </div>
                                <div>
                                    <div class="flex justify-between mb-2 text-sm">
                                        <span class="text-gray-300">Patterns Recognized</span>
                                        <span class="font-bold text-purple-400">${state.learningStats.total_patterns || 580}</span>
                                    </div>
                                    <div class="w-full bg-gray-700 rounded-full h-3">
                                        <div class="h-3 rounded-full bg-gradient-to-r from-purple-500 to-pink-500" style="width: ${Math.min((state.learningStats.total_patterns || 580) / 10, 100)}%;"></div>
                                    </div>
                                </div>
                                <div>
                                    <div class="flex justify-between mb-2 text-sm">
                                        <span class="text-gray-300">Success Rate</span>
                                        <span class="font-bold text-green-400">${state.learningStats.success_rate || 94}%</span>
                                    </div>
                                    <div class="w-full bg-gray-700 rounded-full h-3">
                                        <div class="h-3 rounded-full bg-gradient-to-r from-green-500 to-emerald-500" style="width: ${state.learningStats.success_rate || 94}%;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Service Health Distribution -->
                    <div class="card rounded-xl p-6" style="background: var(--bg-card);">
                        <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                            <i data-lucide="heart-pulse" style="width: 18px; height: 18px; color: var(--primary);"></i>
                            Service Health Distribution
                        </h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            ${renderHealthMetric('Healthy', state.services.filter(s => s.status === 'healthy').length, 'green')}
                            ${renderHealthMetric('Degraded', state.services.filter(s => s.status === 'degraded').length, 'orange')}
                            ${renderHealthMetric('Critical', state.services.filter(s => s.status === 'critical').length, 'red')}
                            ${renderHealthMetric('Total', state.services.length, 'primary')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderHealthMetric(label, value, colorClass) {
            const borderColorMap = {
                'green': 'border-green-500',
                'orange': 'border-orange-500',
                'red': 'border-red-500',
                'primary': 'border-primary'
            };

            const textColorMap = {
                'green': 'text-green-400',
                'orange': 'text-orange-400',
                'red': 'text-red-400',
                'primary': 'text-primary'
            };

            const barColorMap = {
                'green': 'background: #22c55e',
                'orange': 'background: #f97316',
                'red': 'background: #ef4444',
                'primary': 'background: var(--primary)'
            };

            return `
                <div class="rounded-lg p-4 border-l-4 ${borderColorMap[colorClass] || 'border-primary'}" style="background: var(--bg-card);">
                    <div class="text-sm text-gray-400 mb-2">${label}</div>
                    <div class="text-3xl font-bold ${textColorMap[colorClass] || 'text-primary'}">${value}</div>
                    <div class="w-full h-1 rounded-full mt-2" style="${barColorMap[colorClass] || 'background: var(--primary)'}"></div>
                </div>
            `;
        }

        function getRiskClass(risk) {
            const classes = {
                low: 'bg-green-900/50 text-green-300',
                medium: 'bg-orange-900/50 text-orange-300',
                high: 'bg-red-900/50 text-red-300'
            };
            return classes[risk] || classes.medium;
        }

        function renderNotifications() {
            const criticalIncidents = state.incidents.filter(i => i.severity === 'critical').length;
            const urgentActions = state.pendingActions.filter(a => a.risk === 'high').length;

            if (criticalIncidents === 0 && urgentActions === 0) return '';

            return `
                <div class="fixed bottom-6 right-6 space-y-3 max-w-md z-50">
                    ${criticalIncidents > 0 ? `
                        <div class="bg-red-900 border-2 border-red-600 rounded-lg p-4 shadow-2xl slide-in">
                            <div class="flex items-center gap-3">
                                <i class="data-lucide="alert-circle" style="width: 16px; height: 16px;" text-3xl text-red-400 animate-pulse"></i>
                                <div>
                                    <div class="font-bold">Critical Alert</div>
                                    <div class="text-sm">${criticalIncidents} critical incident${criticalIncidents > 1 ? 's' : ''} detected</div>
                                </div>
                                <button onclick="switchView('incidents')" class="ml-auto bg-red-700 hover:bg-red-600 px-3 py-1 rounded text-sm font-bold">
                                    View
                                </button>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${urgentActions > 0 ? `
                        <div class="bg-orange-900 border-2 border-orange-600 rounded-lg p-4 shadow-2xl slide-in">
                            <div class="flex items-center gap-3">
                                <i class="data-lucide="zap" style="width: 16px; height: 16px;" text-3xl text-orange-400 animate-pulse"></i>
                                <div>
                                    <div class="font-bold">Action Required</div>
                                    <div class="text-sm">${urgentActions} high-risk action${urgentActions > 1 ? 's' : ''} pending</div>
                                </div>
                                <button onclick="switchView('actions')" class="ml-auto bg-orange-700 hover:bg-orange-600 px-3 py-1 rounded text-sm font-bold">
                                    Review
                                </button>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // Helper functions
        function getSeverityClass(severity) {
            const classes = {
                critical: 'bg-red-900/50 text-red-300',
                high: 'bg-orange-900/50 text-orange-300',
                medium: 'bg-yellow-900/50 text-yellow-300',
                low: 'bg-blue-900/50 text-blue-300'
            };
            return classes[severity] || classes.medium;
        }

        function getStatusClass(status) {
            const classes = {
                pending: 'bg-yellow-900/50 text-yellow-300',
                approved: 'bg-blue-900/50 text-blue-300',
                success: 'bg-green-900/50 text-green-300',
                failed: 'bg-red-900/50 text-red-300'
            };
            return classes[status] || classes.pending;
        }

        async function approveAction(actionId) {
            if (!confirm('Approve this action for execution?')) return;

            try {
                const response = await fetch(`${API_BASE}/api/v2/actions/approve`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action_id: actionId,
                        approved_by: 'dashboard_user',
                        notes: 'Approved via Deployr dashboard'
                    })
                });

                if (response.ok) {
                    showNotification('Action approved successfully', 'success');
                    fetchAllData();
                } else {
                    showNotification('Failed to approve action', 'error');
                }
            } catch (error) {
                showNotification('Error: ' + error.message, 'error');
            }
        }

        // Chart.js Initialization
        let incidentChart = null;
        let serviceHealthChart = null;

        function initializeCharts() {
            // Wait for canvas to be available
            setTimeout(() => {
                initIncidentTrendChart();
            }, 100);
        }

        function initIncidentTrendChart() {
            const canvas = document.getElementById('incidentTrendChart');
            if (!canvas) return;

            // Destroy existing chart if any
            if (incidentChart) {
                incidentChart.destroy();
            }

            const ctx = canvas.getContext('2d');

            // Generate sample data for last 24 hours
            const labels = [];
            const data = [];
            for (let i = 23; i >= 0; i--) {
                const hour = new Date();
                hour.setHours(hour.getHours() - i);
                labels.push(hour.getHours() + ':00');
                data.push(Math.floor(Math.random() * 5) + (i < 5 ? 2 : 0));
            }

            // Create gradient
            const gradient = ctx.createLinearGradient(0, 0, 0, 200);
            gradient.addColorStop(0, 'rgba(0, 188, 212, 0.4)');
            gradient.addColorStop(1, 'rgba(0, 188, 212, 0.0)');

            incidentChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Incidents',
                        data: data,
                        borderColor: '#00BCD4',
                        backgroundColor: gradient,
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#00BCD4',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 1,
                        pointRadius: 3,
                        pointHoverRadius: 6,
                        pointHoverBackgroundColor: '#00BCD4',
                        pointHoverBorderColor: '#fff',
                        pointHoverBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(22, 27, 34, 0.9)',
                            titleColor: '#fff',
                            bodyColor: '#B8C4CE',
                            borderColor: '#30363D',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: false
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(48, 54, 61, 0.5)',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#64748B',
                                maxRotation: 0,
                                maxTicksLimit: 8
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(48, 54, 61, 0.5)',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#64748B',
                                stepSize: 1
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        // ============================================================================
        // INTEGRATION TAB BUTTON HANDLERS
        // ============================================================================

        // State variables for integration features
        let apiKeyVisible = false;
        const demoApiKey = 'sk_live_deployr_7f9a3b2e1c4d5f6e8a9b0c1d2e3f4a5b';
        const currentWebhookUrl = 'https://api.deployr.io/v1/webhook/YOUR_ENDPOINT';

        function copyApiKey() {
            const apiKey = apiKeyVisible ? demoApiKey : demoApiKey;
            navigator.clipboard.writeText(apiKey).then(() => {
                showNotification('API Key copied to clipboard!', 'success');
            }).catch(err => {
                showNotification('Failed to copy API key', 'error');
            });
        }

        function showApiKey() {
            apiKeyVisible = !apiKeyVisible;
            const codeElement = document.querySelector('.card-glow code');
            if (codeElement) {
                if (apiKeyVisible) {
                    codeElement.textContent = demoApiKey;
                    codeElement.style.color = 'var(--primary)';
                } else {
                    codeElement.textContent = 'sk_live_deployr_‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                    codeElement.style.color = '';
                }
            }
            showNotification(apiKeyVisible ? 'API Key revealed' : 'API Key hidden', 'info');
        }

        function regenerateApiKey() {
            if (!confirm('Are you sure you want to regenerate your API key? The current key will be invalidated immediately.')) {
                return;
            }

            // Simulate API key regeneration
            const newKey = 'sk_live_deployr_' + Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
            showNotification('API Key regenerated successfully! Make sure to update your integrations.', 'success');

            // Update the UI
            setTimeout(() => {
                render();
            }, 500);
        }

        function copyWebhook() {
            navigator.clipboard.writeText(currentWebhookUrl).then(() => {
                showNotification('Webhook URL copied to clipboard!', 'success');
            }).catch(err => {
                showNotification('Failed to copy webhook URL', 'error');
            });
        }

        function configureWebhooks() {
            // Create and show a webhook configuration modal
            const modal = document.createElement('div');
            modal.id = 'webhookConfigModal';
            modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4';
            modal.style.background = 'rgba(0, 0, 0, 0.8)';
            modal.style.backdropFilter = 'blur(8px)';

            modal.innerHTML = `
                <div class="card-glow rounded-xl p-6 max-w-lg w-full" style="background: var(--bg-card); border: 1px solid var(--primary);">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-white flex items-center gap-2">
                            <i data-lucide="webhook" class="text-purple-400" style="width: 24px; height: 24px;"></i>
                            Webhook Configuration
                        </h3>
                        <button onclick="closeWebhookModal()" class="text-gray-400 hover:text-white transition">
                            <i data-lucide="x" style="width: 24px; height: 24px;"></i>
                        </button>
                    </div>
                    
                    <div class="space-y-4 mb-6">
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Endpoint URL</label>
                            <input type="url" id="webhookEndpoint" placeholder="https://your-server.com/webhook" 
                                class="w-full bg-black bg-opacity-50 border border-gray-700 rounded-lg p-3 text-white focus:border-primary focus:outline-none transition"
                                value="">
                        </div>
                        
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Events to Subscribe</label>
                            <div class="space-y-2">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" checked class="form-checkbox text-primary rounded">
                                    <span class="text-sm text-gray-300">Incident Created</span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" checked class="form-checkbox text-primary rounded">
                                    <span class="text-sm text-gray-300">Incident Resolved</span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" class="form-checkbox text-primary rounded">
                                    <span class="text-sm text-gray-300">Action Proposed</span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" class="form-checkbox text-primary rounded">
                                    <span class="text-sm text-gray-300">Action Executed</span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" class="form-checkbox text-primary rounded">
                                    <span class="text-sm text-gray-300">Service Status Change</span>
                                </label>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Secret Key (for signature verification)</label>
                            <input type="text" placeholder="whsec_‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
                                class="w-full bg-black bg-opacity-50 border border-gray-700 rounded-lg p-3 text-white focus:border-primary focus:outline-none transition">
                        </div>
                    </div>
                    
                    <div class="flex gap-3">
                        <button onclick="saveWebhookConfig()" class="flex-1 bg-primary hover:bg-primary-dark text-black py-3 rounded-lg font-bold transition">
                            Save Configuration
                        </button>
                        <button onclick="testWebhook()" class="px-6 py-3 border border-primary/50 text-primary rounded-lg font-medium hover:bg-primary/10 transition">
                            Test
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Reinitialize Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        function closeWebhookModal() {
            const modal = document.getElementById('webhookConfigModal');
            if (modal) {
                modal.remove();
            }
        }

        function saveWebhookConfig() {
            const endpoint = document.getElementById('webhookEndpoint')?.value;
            if (!endpoint) {
                showNotification('Please enter a valid endpoint URL', 'warning');
                return;
            }

            showNotification('Webhook configuration saved successfully!', 'success');
            closeWebhookModal();
        }

        function testWebhook() {
            const endpoint = document.getElementById('webhookEndpoint')?.value;
            if (!endpoint) {
                showNotification('Please enter an endpoint URL first', 'warning');
                return;
            }

            showNotification('Sending test webhook...', 'info');

            // Simulate a test webhook
            setTimeout(() => {
                showNotification('Test webhook sent successfully!', 'success');
            }, 1500);
        }

        // ============================================================================
        // SDK INSTALLATION HANDLERS
        // ============================================================================

        const sdkInfo = {
            python: {
                name: 'Python',
                color: '#3776AB',
                install: 'pip install deployr-agent',
                version: '1.2.3',
                docs: 'https://docs.deployr.io/sdk/python',
                quickstart: 'from deployr import DeployrAgent\n\n# Initialize the agent\nagent = DeployrAgent(api_key="YOUR_API_KEY")\n\n# Start monitoring\nagent.connect()\nagent.start_monitoring()',
                requirements: 'Python 3.8+ required'
            },
            nodejs: {
                name: 'Node.js',
                color: '#68A063',
                install: 'npm install @deployr/agent',
                version: '2.1.0',
                docs: 'https://docs.deployr.io/sdk/nodejs',
                quickstart: 'const { DeployrAgent } = require("@deployr/agent");\n\n// Initialize the agent\nconst agent = new DeployrAgent({\n  apiKey: "YOUR_API_KEY"\n});\n\n// Start monitoring\nawait agent.connect();\nawait agent.startMonitoring();',
                requirements: 'Node.js 16+ required'
            },
            go: {
                name: 'Go',
                color: '#00ADD8',
                install: 'go get github.com/deployr/agent-go',
                version: '0.9.1',
                docs: 'https://docs.deployr.io/sdk/go',
                quickstart: 'package main\n\nimport "github.com/deployr/agent-go"\n\nfunc main() {\n    agent := deployr.NewAgent(deployr.Config{\n        APIKey: "YOUR_API_KEY",\n    })\n    agent.Connect()\n    agent.StartMonitoring()\n}',
                requirements: 'Go 1.19+ required'
            },
            java: {
                name: 'Java',
                color: '#ED8B00',
                install: 'Maven: com.deployr:agent:1.0.0',
                version: '1.0.0',
                docs: 'https://docs.deployr.io/sdk/java',
                quickstart: 'import com.deployr.Agent;\n\npublic class Main {\n    public static void main(String[] args) {\n        Agent agent = new Agent("YOUR_API_KEY");\n        agent.connect();\n        agent.startMonitoring();\n    }\n}',
                requirements: 'Java 11+ required'
            }
        };

        function showSDKInstall(language) {
            const sdk = sdkInfo[language];
            if (!sdk) {
                showNotification('SDK not found', 'error');
                return;
            }

            const modal = document.createElement('div');
            modal.id = 'sdkInstallModal';
            modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4';
            modal.style.background = 'rgba(0, 0, 0, 0.85)';
            modal.style.backdropFilter = 'blur(8px)';

            modal.innerHTML = '<div class="card-glow rounded-xl p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto" style="background: var(--bg-card); border: 1px solid ' + sdk.color + ';">' +
                '<div class="flex items-center justify-between mb-6">' +
                '<h3 class="text-xl font-bold text-white flex items-center gap-3">' +
                '<div class="w-10 h-10 rounded-lg flex items-center justify-center" style="background: ' + sdk.color + '20;">' +
                '<i data-lucide="file-code" style="width: 24px; height: 24px; color: ' + sdk.color + ';"></i>' +
                '</div>' +
                sdk.name + ' SDK ' +
                '<span class="text-sm font-normal text-gray-400">v' + sdk.version + '</span>' +
                '</h3>' +
                '<button onclick="closeSDKModal()" class="text-gray-400 hover:text-white transition">' +
                '<i data-lucide="x" style="width: 24px; height: 24px;"></i>' +
                '</button>' +
                '</div>' +
                '<div class="space-y-5">' +
                '<div>' +
                '<h4 class="text-sm font-semibold text-gray-400 mb-2 flex items-center gap-2">' +
                '<i data-lucide="terminal" style="width: 16px; height: 16px;"></i> Installation' +
                '</h4>' +
                '<div class="bg-black bg-opacity-50 rounded-lg p-4 flex items-center justify-between">' +
                '<code class="text-green-400 text-sm">' + sdk.install + '</code>' +
                '<button onclick="copyToClipboard(\'' + sdk.install + '\')" class="text-gray-400 hover:text-white transition">' +
                '<i data-lucide="copy" style="width: 18px; height: 18px;"></i>' +
                '</button>' +
                '</div>' +
                '<p class="text-xs text-gray-500 mt-2">' + sdk.requirements + '</p>' +
                '</div>' +
                '<div>' +
                '<h4 class="text-sm font-semibold text-gray-400 mb-2 flex items-center gap-2">' +
                '<i data-lucide="code" style="width: 16px; height: 16px;"></i> Quick Start' +
                '</h4>' +
                '<div class="bg-black bg-opacity-50 rounded-lg p-4 relative">' +
                '<button onclick="copySDKQuickstart(\'' + language + '\')" class="absolute top-3 right-3 text-gray-400 hover:text-white transition">' +
                '<i data-lucide="copy" style="width: 16px; height: 16px;"></i>' +
                '</button>' +
                '<pre class="text-sm text-gray-300 overflow-x-auto whitespace-pre-wrap">' + sdk.quickstart.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</pre>' +
                '</div>' +
                '</div>' +
                '<div class="flex gap-3 pt-2">' +
                '<button onclick="openSDKDocs(\'' + language + '\')" class="flex-1 py-3 rounded-lg font-medium transition flex items-center justify-center gap-2" style="background: ' + sdk.color + '20; color: ' + sdk.color + '; border: 1px solid ' + sdk.color + '40;">' +
                '<i data-lucide="book-open" style="width: 18px; height: 18px;"></i> View Full Docs' +
                '</button>' +
                '<button onclick="copyToClipboard(\'' + sdk.install + '\'); closeSDKModal();" class="flex-1 py-3 rounded-lg font-medium transition flex items-center justify-center gap-2" style="background: ' + sdk.color + '; color: #000;">' +
                '<i data-lucide="copy" style="width: 18px; height: 18px;"></i> Copy Install Command' +
                '</button>' +
                '</div>' +
                '</div>' +
                '</div>';

            document.body.appendChild(modal);
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function closeSDKModal() {
            const modal = document.getElementById('sdkInstallModal');
            if (modal) modal.remove();
        }

        function copySDKQuickstart(language) {
            const sdk = sdkInfo[language];
            if (sdk) {
                navigator.clipboard.writeText(sdk.quickstart).then(() => {
                    showNotification('Quick start code copied!', 'success');
                });
            }
        }

        function openSDKDocs(language) {
            const sdk = sdkInfo[language];
            if (sdk) {
                showNotification('Opening ' + sdk.name + ' documentation...', 'info');
                window.open(sdk.docs, '_blank');
            }
        }

        function showAllSDKs() {
            const modal = document.createElement('div');
            modal.id = 'allSDKsModal';
            modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4';
            modal.style.background = 'rgba(0, 0, 0, 0.85)';
            modal.style.backdropFilter = 'blur(8px)';

            let sdkCards = '';
            Object.entries(sdkInfo).forEach(function ([key, sdk]) {
                sdkCards += '<div class="bg-black bg-opacity-30 rounded-lg p-4 border border-gray-700 hover:border-primary/50 transition cursor-pointer" onclick="closeAllSDKsModal(); showSDKInstall(\'' + key + '\');">' +
                    '<div class="flex items-center gap-3 mb-3">' +
                    '<div class="w-10 h-10 rounded-lg flex items-center justify-center" style="background: ' + sdk.color + '20;">' +
                    '<i data-lucide="file-code" style="width: 20px; height: 20px; color: ' + sdk.color + ';"></i>' +
                    '</div>' +
                    '<div>' +
                    '<h4 class="font-bold text-white">' + sdk.name + '</h4>' +
                    '<span class="text-xs text-gray-400">v' + sdk.version + '</span>' +
                    '</div>' +
                    '</div>' +
                    '<code class="text-xs text-green-400 bg-black bg-opacity-50 rounded px-2 py-1 block truncate">' + sdk.install + '</code>' +
                    '<p class="text-xs text-gray-500 mt-2">' + sdk.requirements + '</p>' +
                    '</div>';
            });

            modal.innerHTML = '<div class="card-glow rounded-xl p-6 max-w-3xl w-full max-h-[90vh] overflow-y-auto" style="background: var(--bg-card); border: 1px solid var(--primary);">' +
                '<div class="flex items-center justify-between mb-6">' +
                '<h3 class="text-xl font-bold text-white flex items-center gap-2">' +
                '<i data-lucide="package" class="text-green-400" style="width: 24px; height: 24px;"></i> Available SDKs & Agents' +
                '</h3>' +
                '<button onclick="closeAllSDKsModal()" class="text-gray-400 hover:text-white transition">' +
                '<i data-lucide="x" style="width: 24px; height: 24px;"></i>' +
                '</button>' +
                '</div>' +
                '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">' + sdkCards + '</div>' +
                '<div class="mt-6 p-4 bg-primary/10 border border-primary/30 rounded-lg">' +
                '<h4 class="font-semibold text-primary mb-2 flex items-center gap-2">' +
                '<i data-lucide="info" style="width: 16px; height: 16px;"></i> Need a different language?' +
                '</h4>' +
                '<p class="text-sm text-gray-400">Contact us at <span class="text-primary">support@deployr.io</span> to request support for your preferred language.</p>' +
                '</div>' +
                '</div>';

            document.body.appendChild(modal);
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function closeAllSDKsModal() {
            const modal = document.getElementById('allSDKsModal');
            if (modal) modal.remove();
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showNotification('Copied to clipboard!', 'success');
            }).catch(err => {
                showNotification('Failed to copy', 'error');
            });
        }

        // ============================================================================
        // DOCUMENTATION HANDLERS
        // ============================================================================

        const documentationContent = {
            'getting-started': {
                title: 'Getting Started with Deployr',
                icon: 'rocket',
                sections: [
                    { title: '1. Create Your Account', content: 'Sign up for a Deployr account at deployr.io. You\'ll receive an API key upon registration.' },
                    { title: '2. Install the Agent', content: 'Choose your preferred SDK and install it using the package manager:\n‚Ä¢ Python: pip install deployr-agent\n‚Ä¢ Node.js: npm install @deployr/agent\n‚Ä¢ Go: go get github.com/deployr/agent-go\n‚Ä¢ Java: Add Maven dependency' },
                    { title: '3. Initialize & Connect', content: 'Initialize the agent with your API key and call connect() to establish a connection to the Deployr platform.' },
                    { title: '4. Start Monitoring', content: 'Call startMonitoring() to begin automatic detection of anomalies and incidents in your infrastructure.' },
                    { title: '5. Configure Webhooks', content: 'Set up webhooks to receive real-time notifications for incidents, actions, and service status changes.' }
                ]
            },
            'api-reference': {
                title: 'API Reference',
                icon: 'code',
                sections: [
                    { title: 'Authentication', content: 'All API requests require an API key in the Authorization header:\n\nAuthorization: Bearer sk_live_deployr_xxxxx' },
                    { title: 'Base URL', content: 'All API endpoints are relative to: https://api.deployr.io/v1' },
                    { title: 'Core Endpoints', content: '‚Ä¢ GET /incidents - List incidents\n‚Ä¢ GET /incidents/:id - Get incident details\n‚Ä¢ POST /incidents/:id/resolve - Resolve incident\n‚Ä¢ GET /services - List monitored services\n‚Ä¢ GET /actions - List pending actions\n‚Ä¢ POST /actions/:id/approve - Approve action' },
                    { title: 'Rate Limits', content: '‚Ä¢ Free tier: 100 requests/minute\n‚Ä¢ Advanced: 1,000 requests/minute\n‚Ä¢ Ultimate: 10,000 requests/minute' }
                ]
            },
            'security-guide': {
                title: 'Security Guide',
                icon: 'shield',
                sections: [
                    { title: 'API Key Security', content: '‚Ä¢ Never expose your API key in client-side code\n‚Ä¢ Store API keys in environment variables\n‚Ä¢ Rotate keys regularly (every 90 days recommended)\n‚Ä¢ Use separate keys for development and production' },
                    { title: 'Data Encryption', content: '‚Ä¢ All data in transit is encrypted using TLS 1.3\n‚Ä¢ Data at rest is encrypted using AES-256\n‚Ä¢ Webhook payloads are signed with HMAC-SHA256' },
                    { title: 'Compliance', content: '‚Ä¢ SOC 2 Type II certified\n‚Ä¢ GDPR compliant\n‚Ä¢ HIPAA compliant (Ultimate plan)\n‚Ä¢ ISO 27001 certified' }
                ]
            },
            'faq': {
                title: 'Frequently Asked Questions',
                icon: 'help-circle',
                sections: [
                    { title: 'What is Deployr?', content: 'Deployr is an AI-powered DevOps automation platform that monitors your infrastructure, detects anomalies, and automatically remediates issues before they impact your users.' },
                    { title: 'How does the AI learn?', content: 'Our AI learns from your infrastructure patterns, historical incidents, and human decisions. The more it observes, the better it becomes at predicting and preventing issues.' },
                    { title: 'Is my data safe?', content: 'Yes! All data is encrypted in transit and at rest. We are SOC 2 Type II certified and GDPR compliant. We never share your data with third parties.' },
                    { title: 'Can I use Deployr with Kubernetes?', content: 'Absolutely! Deployr has native Kubernetes integration. Install our operator to automatically monitor pods, deployments, and cluster health.' }
                ]
            }
        };

        function showDocumentation(docId) {
            const doc = documentationContent[docId];
            if (!doc) {
                showNotification('Documentation not found', 'error');
                return;
            }

            const modal = document.createElement('div');
            modal.id = 'docModal';
            modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4';
            modal.style.background = 'rgba(0, 0, 0, 0.85)';
            modal.style.backdropFilter = 'blur(8px)';

            let sectionsHtml = '';
            doc.sections.forEach(function (section) {
                sectionsHtml += '<div class="bg-black bg-opacity-30 rounded-lg p-4 border-l-2 border-primary">' +
                    '<h4 class="font-bold text-white mb-2">' + section.title + '</h4>' +
                    '<div class="text-sm text-gray-300 whitespace-pre-line">' + section.content + '</div>' +
                    '</div>';
            });

            modal.innerHTML = '<div class="card-glow rounded-xl max-w-3xl w-full max-h-[90vh] overflow-hidden flex flex-col" style="background: var(--bg-card); border: 1px solid var(--primary);">' +
                '<div class="flex items-center justify-between p-6 border-b" style="border-color: var(--border);">' +
                '<h3 class="text-xl font-bold text-white flex items-center gap-3">' +
                '<i data-lucide="' + doc.icon + '" class="text-primary" style="width: 24px; height: 24px;"></i> ' + doc.title +
                '</h3>' +
                '<button onclick="closeDocModal()" class="text-gray-400 hover:text-white transition">' +
                '<i data-lucide="x" style="width: 24px; height: 24px;"></i>' +
                '</button>' +
                '</div>' +
                '<div class="p-6 overflow-y-auto flex-1">' +
                '<div class="space-y-4">' + sectionsHtml + '</div>' +
                '</div>' +
                '<div class="p-4 border-t flex gap-3" style="border-color: var(--border);">' +
                '<button onclick="showNotification(\'Opening full documentation...\', \'info\');" class="flex-1 py-2 rounded-lg font-medium transition flex items-center justify-center gap-2 bg-primary/10 text-primary border border-primary/30 hover:bg-primary/20">' +
                '<i data-lucide="external-link" style="width: 16px; height: 16px;"></i> Open Full Docs' +
                '</button>' +
                '<button onclick="closeDocModal()" class="px-6 py-2 rounded-lg font-medium transition bg-gray-700 text-gray-300 hover:bg-gray-600">Close</button>' +
                '</div>' +
                '</div>';

            document.body.appendChild(modal);
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function closeDocModal() {
            const modal = document.getElementById('docModal');
            if (modal) modal.remove();
        }

        // ============================================================================
        // INCIDENTS VIEW - FILTER AND EXPORT HANDLERS
        // ============================================================================

        function showFilterModal() {
            const modal = document.createElement('div');
            modal.id = 'filterModal';
            modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4';
            modal.style.background = 'rgba(0, 0, 0, 0.8)';
            modal.style.backdropFilter = 'blur(8px)';

            // Get unique services from incidents
            const services = [...new Set(state.incidents.map(i => i.service))];

            // Build service options
            let serviceOptions = '<option value="all">All Services</option>';
            services.forEach(function (s) {
                const selected = incidentFilters.service === s ? ' selected' : '';
                serviceOptions += '<option value="' + s + '"' + selected + '>' + s + '</option>';
            });

            modal.innerHTML = '<div class="card-glow rounded-xl p-6 max-w-md w-full" style="background: var(--bg-card); border: 1px solid var(--primary);">' +
                '<div class="flex items-center justify-between mb-6">' +
                '<h3 class="text-xl font-bold text-white flex items-center gap-2">' +
                '<i data-lucide="filter" class="text-primary" style="width: 24px; height: 24px;"></i>' +
                'Filter Incidents' +
                '</h3>' +
                '<button onclick="closeFilterModal()" class="text-gray-400 hover:text-white transition">' +
                '<i data-lucide="x" style="width: 24px; height: 24px;"></i>' +
                '</button>' +
                '</div>' +
                '<div class="space-y-4 mb-6">' +
                '<div>' +
                '<label class="block text-sm text-gray-400 mb-2">Severity</label>' +
                '<select id="filterSeverity" class="w-full bg-black bg-opacity-50 border border-gray-700 rounded-lg p-3 text-white focus:border-primary focus:outline-none transition">' +
                '<option value="all"' + (incidentFilters.severity === 'all' ? ' selected' : '') + '>All Severities</option>' +
                '<option value="critical"' + (incidentFilters.severity === 'critical' ? ' selected' : '') + '>Critical</option>' +
                '<option value="high"' + (incidentFilters.severity === 'high' ? ' selected' : '') + '>High</option>' +
                '<option value="medium"' + (incidentFilters.severity === 'medium' ? ' selected' : '') + '>Medium</option>' +
                '<option value="low"' + (incidentFilters.severity === 'low' ? ' selected' : '') + '>Low</option>' +
                '</select>' +
                '</div>' +
                '<div>' +
                '<label class="block text-sm text-gray-400 mb-2">Service</label>' +
                '<select id="filterService" class="w-full bg-black bg-opacity-50 border border-gray-700 rounded-lg p-3 text-white focus:border-primary focus:outline-none transition">' +
                serviceOptions +
                '</select>' +
                '</div>' +
                '<div>' +
                '<label class="block text-sm text-gray-400 mb-2">Date Range</label>' +
                '<select id="filterDateRange" class="w-full bg-black bg-opacity-50 border border-gray-700 rounded-lg p-3 text-white focus:border-primary focus:outline-none transition">' +
                '<option value="24h"' + (incidentFilters.dateRange === '24h' ? ' selected' : '') + '>Last 24 Hours</option>' +
                '<option value="7d"' + (incidentFilters.dateRange === '7d' ? ' selected' : '') + '>Last 7 Days</option>' +
                '<option value="30d"' + (incidentFilters.dateRange === '30d' ? ' selected' : '') + '>Last 30 Days</option>' +
                '<option value="all"' + (incidentFilters.dateRange === 'all' ? ' selected' : '') + '>All Time</option>' +
                '</select>' +
                '</div>' +
                '</div>' +
                '<div class="flex gap-3">' +
                '<button onclick="applyFilters()" class="flex-1 bg-primary hover:bg-primary-dark text-black py-3 rounded-lg font-bold transition">Apply Filters</button>' +
                '<button onclick="resetFilters()" class="px-6 py-3 border border-gray-600 text-gray-300 rounded-lg font-medium hover:bg-gray-700 transition">Reset</button>' +
                '</div>' +
                '</div>';

            document.body.appendChild(modal);
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function closeFilterModal() {
            const modal = document.getElementById('filterModal');
            if (modal) modal.remove();
        }

        async function resolveIncident(incidentId, mode) {
            // Find the incident before removing it
            const incident = state.incidents.find(i => i.id === incidentId);
            if (!incident) {
                showNotification('Incident not found', 'error');
                return;
            }

            try {
                if (mode === 'autonomous') {
                    // === AUTONOMOUS RESOLUTION ===
                    // 1. Mark as resolved in backend (PERSISTENT - survives refresh)
                    try {
                        await fetch(`${API_BASE}/api/incidents/mark-resolved`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                incident_id: incidentId,
                                mode: 'autonomous',
                                service: incident.service
                            })
                        });
                    } catch (markError) {
                        console.warn('Failed to mark incident as resolved:', markError);
                    }

                    // 2. Create log entry for permanent record
                    const logEntry = {
                        action_id: `auto_${incidentId}`,
                        incident_id: incidentId,
                        action_type: incident.recommended_actions?.[0]?.action || 'restart',
                        mode: 'autonomous',
                        service: incident.service,
                        status: 'completed',
                        success: true,
                        confidence: incident.confidence || 85,
                        description: `Auto-resolved: ${incident.root_cause || incident.service + ' incident'}`,
                        reason: `AI Autopilot executed autonomous remediation for ${incident.service}`,
                        executed_by: 'AI Autopilot'
                    };

                    // Add to logs via API (permanent storage)
                    try {
                        await fetch(`${API_BASE}/api/logs`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(logEntry)
                        });
                    } catch (logError) {
                        console.warn('Failed to create log entry:', logError);
                    }

                    // 2. Remove from incidents list
                    state.incidents = state.incidents.filter(i => i.id !== incidentId);

                    // 3. Add to resolved history for display
                    state.resolvedIncidents.unshift({
                        ...incident,
                        resolution_mode: 'autonomous',
                        resolved_at: new Date().toISOString(),
                        resolved_by: 'AI Autopilot'
                    });

                    // 4. Add to outcomes for tracking (local state)
                    const outcomeData = {
                        action_id: `resolve_${incidentId}`,
                        action_type: logEntry.action_type,
                        service: incident.service,
                        success: true,
                        auto_executed: true,
                        confidence: incident.confidence || 85,
                        timestamp: new Date().toISOString(),
                        incident_id: incidentId,
                        reason: `Auto-resolved: ${incident.root_cause || incident.service}`,
                        executed_by: 'AI Autopilot'
                    };
                    state.outcomes.unshift(outcomeData);

                    // 5. Store outcome in backend (PERSISTENT - survives refresh)
                    try {
                        await fetch(`${API_BASE}/api/v3/autonomous/outcomes`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(outcomeData)
                        });
                    } catch (outcomeError) {
                        console.warn('Failed to store outcome:', outcomeError);
                    }

                    showNotification(`‚úì Incident auto-resolved! Check Autonomous & Logs tabs.`, 'success');

                    // Refresh logs to show new entry
                    if (currentView === 'logs') {
                        loadLogs();
                    }

                    render();

                } else {
                    // === MANUAL RESOLUTION ===
                    // 0. Mark as resolved in backend (PERSISTENT - survives refresh)
                    try {
                        await fetch(`${API_BASE}/api/incidents/mark-resolved`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                incident_id: incidentId,
                                mode: 'manual',
                                service: incident.service
                            })
                        });
                    } catch (markError) {
                        console.warn('Failed to mark incident as resolved:', markError);
                    }

                    // 1. Create pending action for Actions tab
                    const actionId = `manual_action_${incidentId}_${Date.now()}`;
                    const pendingAction = {
                        id: actionId,
                        incident_id: incidentId,
                        action_type: incident.recommended_actions?.[0]?.action || 'investigate',
                        service: incident.service,
                        reasoning: incident.root_cause || `Manual review required for ${incident.service} incident`,
                        risk: incident.severity === 'critical' ? 'high' : 'medium',
                        status: 'pending_review',
                        proposed_at: new Date().toISOString(),
                        proposed_by: 'manual_request',
                        incident_details: {
                            title: incident.service,
                            severity: incident.severity,
                            confidence: incident.confidence || 60,
                            timestamp: incident.timestamp,
                            anomalies: incident.anomaly_count || 0,
                            root_cause: incident.root_cause
                        }
                    };

                    // 2. Add to pending actions (local state)
                    state.pendingActions.unshift(pendingAction);

                    // 3. Store pending action in backend (PERSISTENT - survives refresh)
                    try {
                        await fetch(`${API_BASE}/api/v2/actions/pending`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(pendingAction)
                        });
                    } catch (actionError) {
                        console.warn('Failed to store pending action:', actionError);
                    }

                    // 4. Remove from incidents
                    state.incidents = state.incidents.filter(i => i.id !== incidentId);

                    // 4. Create log entry for manual action
                    try {
                        await fetch(`${API_BASE}/api/logs`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                action_id: actionId,
                                incident_id: incidentId,
                                action_type: 'manual_review',
                                mode: 'manual',
                                service: incident.service,
                                status: 'pending',
                                success: false,
                                confidence: incident.confidence || 60,
                                description: `Manual review requested for ${incident.service}`,
                                reason: incident.root_cause || 'Awaiting manual investigation',
                                executed_by: 'dashboard_user'
                            })
                        });
                    } catch (logError) {
                        console.warn('Failed to create log entry:', logError);
                    }

                    showNotification(`Incident sent to Actions tab for manual review.`, 'info');

                    // Navigate to Actions tab after short delay
                    render();
                    setTimeout(() => {
                        switchView('actions');
                    }, 1500);
                }
            } catch (error) {
                console.error('Error resolving incident:', error);
                showNotification(`Error: ${error.message}`, 'error');
                if (incident && mode === 'manual') {
                    const actionId = `manual_action_${incidentId}_${Date.now()}`;
                    state.pendingActions.unshift({
                        id: actionId,
                        incident_id: incidentId,
                        action_type: 'investigate',
                        service: incident.service,
                        reasoning: `Manual review for ${incident.service}`,
                        risk: 'medium',
                        status: 'pending_review',
                        proposed_at: new Date().toISOString(),
                        proposed_by: 'manual_request',
                        incident_details: {
                            title: incident.title || incident.service,
                            severity: incident.severity,
                            confidence: incident.confidence || 60
                        }
                    });
                    state.incidents = state.incidents.filter(i => i.id !== incidentId);
                    showNotification(`Incident sent to Actions for review`, 'info');
                } else if (incident) {
                    // Autonomous fallback
                    state.resolvedIncidents.unshift({
                        ...incident,
                        resolution_mode: mode,
                        resolved_at: new Date().toISOString(),
                        resolved_by: mode === 'autonomous' ? 'AI Autopilot' : 'Dashboard User'
                    });
                    state.incidents = state.incidents.filter(i => i.id !== incidentId);
                    showNotification(`Incident resolved (${mode})`, 'success');
                }
                render();
            }
        }

        function showNotification(message, type = 'info') {
            const colors = {
                success: 'bg-green-600',
                error: 'bg-red-600',
                warning: 'bg-orange-600',
                info: 'bg-blue-600'
            };

            const notification = document.createElement('div');
            notification.className = `fixed bottom-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center gap-2 slide-in`;
            notification.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-times-circle' : 'fa-info-circle'}"></i>
                <span>${message}</span>
            `;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                notification.style.transition = 'all 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }

        async function approveAction(actionId) {
            const action = state.pendingActions.find(a => a.id === actionId);
            if (!action) {
                showNotification('Action not found', 'error');
                return;
            }

            try {
                // Execute the action via API
                const response = await fetch(`${API_BASE}/api/v3/autonomous/execute/${actionId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        approved_by: 'dashboard_user',
                        execute_immediately: true
                    })
                });

                // Remove from pending
                state.pendingActions = state.pendingActions.filter(a => a.id !== actionId);

                // Add to action history as executed
                state.actionHistory.unshift({
                    ...action,
                    status: 'executed',
                    executed_at: new Date().toISOString(),
                    approved_by: 'Dashboard User'
                });

                // Also add to outcomes for visibility in Autonomous tab
                state.outcomes.unshift({
                    action_id: actionId,
                    action_type: action.action_type,
                    service: action.service,
                    success: true,
                    auto_executed: false,
                    confidence: action.incident_details?.confidence || 80,
                    timestamp: new Date().toISOString()
                });

                // Add incident to resolved
                if (action.incident_details) {
                    state.resolvedIncidents.unshift({
                        id: action.incident_id,
                        service: action.service,
                        title: action.incident_details.title,
                        severity: action.incident_details.severity,
                        resolution_mode: 'manual_approved',
                        resolved_at: new Date().toISOString(),
                        resolved_by: 'Dashboard User (Approved)'
                    });
                }

                showNotification(`Action "${action.action_type}" approved and executed for ${action.service}!`, 'success');
                render();

            } catch (error) {
                console.error('Error executing action:', error);

                // Still mark as executed locally for demo
                state.pendingActions = state.pendingActions.filter(a => a.id !== actionId);
                state.actionHistory.unshift({
                    ...action,
                    status: 'executed',
                    executed_at: new Date().toISOString()
                });

                showNotification(`Action "${action.action_type}" executed for ${action.service}`, 'success');
                render();
            }
        }

        async function rejectAction(actionId) {
            const action = state.pendingActions.find(a => a.id === actionId);
            if (!action) {
                showNotification('Action not found', 'error');
                return;
            }

            try {
                // Notify API of rejection
                await fetch(`${API_BASE}/api/v3/autonomous/reject/${actionId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        rejected_by: 'dashboard_user',
                        reason: 'Manually rejected via dashboard'
                    })
                });
            } catch (e) {
                console.log('API rejection failed, continuing locally');
            }

            // Remove from pending
            state.pendingActions = state.pendingActions.filter(a => a.id !== actionId);

            // Add to action history as rejected
            state.actionHistory.unshift({
                ...action,
                status: 'rejected',
                rejected_at: new Date().toISOString(),
                rejected_by: 'Dashboard User'
            });

            showNotification(`Action "${action.action_type}" rejected for ${action.service}`, 'warning');
            render();
        }

        function applyFilters() {
            incidentFilters = {
                severity: document.getElementById('filterSeverity')?.value || 'all',
                service: document.getElementById('filterService')?.value || 'all',
                dateRange: document.getElementById('filterDateRange')?.value || '7d',
                status: 'all'
            };

            closeFilterModal();
            showNotification('Filters applied!', 'success');
            render();
        }

        function resetFilters() {
            incidentFilters = {
                severity: 'all',
                status: 'all',
                service: 'all',
                dateRange: '7d'
            };

            closeFilterModal();
            showNotification('Filters reset', 'info');
            render();
        }

        function showExportModal() {
            const modal = document.createElement('div');
            modal.id = 'exportModal';
            modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4';
            modal.style.background = 'rgba(0, 0, 0, 0.8)';
            modal.style.backdropFilter = 'blur(8px)';

            modal.innerHTML = '<div class="card-glow rounded-xl p-6 max-w-md w-full" style="background: var(--bg-card); border: 1px solid var(--primary);">' +
                '<div class="flex items-center justify-between mb-6">' +
                '<h3 class="text-xl font-bold text-white flex items-center gap-2">' +
                '<i data-lucide="download" class="text-primary" style="width: 24px; height: 24px;"></i>' +
                'Export Incidents' +
                '</h3>' +
                '<button onclick="closeExportModal()" class="text-gray-400 hover:text-white transition">' +
                '<i data-lucide="x" style="width: 24px; height: 24px;"></i>' +
                '</button>' +
                '</div>' +
                '<div class="space-y-4 mb-6">' +
                '<div>' +
                '<label class="block text-sm text-gray-400 mb-2">Export Format</label>' +
                '<select id="exportFormat" class="w-full bg-black bg-opacity-50 border border-gray-700 rounded-lg p-3 text-white focus:border-primary focus:outline-none transition">' +
                '<option value="csv">CSV (.csv)</option>' +
                '<option value="json">JSON (.json)</option>' +
                '<option value="pdf">PDF Report (.pdf)</option>' +
                '</select>' +
                '</div>' +
                '<div>' +
                '<label class="block text-sm text-gray-400 mb-2">Date Range</label>' +
                '<div class="grid grid-cols-2 gap-3">' +
                '<div>' +
                '<label class="block text-xs text-gray-500 mb-1">From</label>' +
                '<input type="date" id="exportStartDate" class="w-full bg-black bg-opacity-50 border border-gray-700 rounded-lg p-2 text-white focus:border-primary focus:outline-none transition text-sm">' +
                '</div>' +
                '<div>' +
                '<label class="block text-xs text-gray-500 mb-1">To</label>' +
                '<input type="date" id="exportEndDate" class="w-full bg-black bg-opacity-50 border border-gray-700 rounded-lg p-2 text-white focus:border-primary focus:outline-none transition text-sm">' +
                '</div>' +
                '</div>' +
                '</div>' +
                '<div>' +
                '<label class="block text-sm text-gray-400 mb-2">Include</label>' +
                '<div class="space-y-2">' +
                '<label class="flex items-center gap-2 cursor-pointer">' +
                '<input type="checkbox" checked id="exportIncludeDetails" class="form-checkbox text-primary rounded">' +
                '<span class="text-sm text-gray-300">Incident Details</span>' +
                '</label>' +
                '<label class="flex items-center gap-2 cursor-pointer">' +
                '<input type="checkbox" checked id="exportIncludeActions" class="form-checkbox text-primary rounded">' +
                '<span class="text-sm text-gray-300">Related Actions</span>' +
                '</label>' +
                '<label class="flex items-center gap-2 cursor-pointer">' +
                '<input type="checkbox" id="exportIncludeMetrics" class="form-checkbox text-primary rounded">' +
                '<span class="text-sm text-gray-300">Service Metrics</span>' +
                '</label>' +
                '</div>' +
                '</div>' +
                '</div>' +
                '<div class="p-3 bg-blue-900/20 border border-blue-500/30 rounded-lg mb-4">' +
                '<div class="text-sm text-blue-300">' +
                '<i data-lucide="info" style="width: 16px; height: 16px; display: inline; vertical-align: middle; margin-right: 4px;"></i>' +
                state.incidents.length + ' incidents will be exported based on current filters' +
                '</div>' +
                '</div>' +
                '<button onclick="exportIncidents()" class="w-full bg-primary hover:bg-primary-dark text-black py-3 rounded-lg font-bold transition flex items-center justify-center gap-2">' +
                '<i data-lucide="download" style="width: 18px; height: 18px;"></i>' +
                'Download Export' +
                '</button>' +
                '</div>';

            document.body.appendChild(modal);

            // Set default dates
            const today = new Date();
            const lastMonth = new Date(today);
            lastMonth.setMonth(lastMonth.getMonth() - 1);

            document.getElementById('exportEndDate').value = today.toISOString().split('T')[0];
            document.getElementById('exportStartDate').value = lastMonth.toISOString().split('T')[0];

            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function closeExportModal() {
            const modal = document.getElementById('exportModal');
            if (modal) {
                modal.remove();
            }
        }

        function exportIncidents() {
            const format = document.getElementById('exportFormat')?.value || 'csv';
            const startDate = document.getElementById('exportStartDate')?.value;
            const endDate = document.getElementById('exportEndDate')?.value;

            let dataToExport = getFilteredIncidents();

            // Filter by date range if specified
            if (startDate && endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                end.setHours(23, 59, 59, 999);

                dataToExport = dataToExport.filter(i => {
                    const incidentDate = new Date(i.timestamp);
                    return incidentDate >= start && incidentDate <= end;
                });
            }

            if (dataToExport.length === 0) {
                showNotification('No incidents to export in the selected date range', 'warning');
                return;
            }

            closeExportModal();

            if (format === 'csv') {
                exportAsCSV(dataToExport);
            } else if (format === 'json') {
                exportAsJSON(dataToExport);
            } else if (format === 'pdf') {
                showNotification('PDF export initiated. The report will download shortly...', 'info');
                // Simulate PDF generation
                setTimeout(() => {
                    exportAsCSV(dataToExport); // Fallback to CSV for demo
                    showNotification('Exported as CSV (PDF generation requires premium)', 'success');
                }, 1000);
            }
        }

        function exportAsCSV(incidents) {
            const headers = ['ID', 'Service', 'Severity', 'Type', 'Description', 'Root Cause', 'Confidence', 'Timestamp'];
            const rows = incidents.map(i => [
                i.id || '',
                i.service || '',
                i.severity || '',
                i.type || '',
                (i.description || '').replace(/,/g, ';').replace(/\n/g, ' '),
                (i.root_cause || '').replace(/,/g, ';').replace(/\n/g, ' '),
                i.confidence || '',
                i.timestamp || ''
            ]);

            const csvContent = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
            downloadFile(csvContent, 'deployr_incidents_export.csv', 'text/csv');
            showNotification(`Exported ${incidents.length} incidents as CSV`, 'success');
        }

        function exportAsJSON(incidents) {
            const jsonContent = JSON.stringify(incidents, null, 2);
            downloadFile(jsonContent, 'deployr_incidents_export.json', 'application/json');
            showNotification(`Exported ${incidents.length} incidents as JSON`, 'success');
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ============================================================================
        // SDK DOWNLOAD HANDLERS
        // ============================================================================

        function downloadSDK(language) {
            const sdkUrls = {
                'python': 'https://pypi.org/project/deployr-agent/',
                'nodejs': 'https://www.npmjs.com/package/@deployr/agent',
                'go': 'https://pkg.go.dev/github.com/deployr/agent-go',
                'java': 'https://mvnrepository.com/artifact/io.deployr/agent'
            };

            showNotification(`Opening ${language} SDK installation page...`, 'info');
            // In a real app, this would open the URL
            setTimeout(() => {
                showNotification(`${language} SDK: pip install deployr - agent(demo)`, 'success');
            }, 1000);
        }

        // ============================================================================
        // INTELLIGENCE PANEL RENDER FUNCTIONS
        // ============================================================================

        function renderIntelligenceModel() {
            return `
                <div class="space-y-6">
                    <!-- Header -->
                    <div class="flex items-center justify-between">
                        <div>
                            <h1 class="text-2xl font-bold" style="color: var(--text-primary);">
                                <i data-lucide="network" class="inline-block mr-2" style="width: 28px; height: 28px; color: var(--primary); vertical-align: middle;"></i>
                                Production Knowledge Model
                            </h1>
                            <p class="text-sm" style="color: var(--text-muted);">Living representation of production architecture and dependencies</p>
                        </div>
                    </div>

                    <!-- Model Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="card rounded-xl p-5">
                            <div class="flex items-center gap-3 mb-2">
                                <i data-lucide="server" style="width: 20px; height: 20px; color: var(--primary);"></i>
                                <span class="text-sm" style="color: var(--text-muted);">Total Services</span>
                            </div>
                            <div class="text-3xl font-bold" style="color: var(--text-primary);">12</div>
                        </div>
                        <div class="card rounded-xl p-5">
                            <div class="flex items-center gap-3 mb-2">
                                <i data-lucide="git-branch" style="width: 20px; height: 20px; color: var(--purple);"></i>
                                <span class="text-sm" style="color: var(--text-muted);">Dependencies</span>
                            </div>
                            <div class="text-3xl font-bold" style="color: var(--text-primary);">28</div>
                        </div>
                        <div class="card rounded-xl p-5">
                            <div class="flex items-center gap-3 mb-2">
                                <i data-lucide="shield-check" style="width: 20px; height: 20px; color: var(--success);"></i>
                                <span class="text-sm" style="color: var(--text-muted);">Tier-1 Services</span>
                            </div>
                            <div class="text-3xl font-bold" style="color: var(--success);">4</div>
                        </div>
                        <div class="card rounded-xl p-5">
                            <div class="flex items-center gap-3 mb-2">
                                <i data-lucide="alert-triangle" style="width: 20px; height: 20px; color: var(--warning);"></i>
                                <span class="text-sm" style="color: var(--text-muted);">Arch Drifts</span>
                            </div>
                            <div class="text-3xl font-bold" style="color: var(--warning);">2</div>
                        </div>
                    </div>

                    <!-- Service Dependency Graph -->
                    <div class="card-glow rounded-xl p-6">
                        <h3 class="text-lg font-bold mb-4" style="color: var(--text-primary);">
                            <i data-lucide="git-pull-request" class="inline-block mr-2" style="width: 20px; height: 20px; color: var(--primary); vertical-align: middle;"></i>
                            Service Dependency Graph
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${['api-gateway', 'payment-service', 'user-service', 'order-service', 'redis-cluster', 'postgres-primary'].map((svc, i) => `
                                <div class="bg-black bg-opacity-30 rounded-lg p-4 border border-gray-700 hover:border-primary/50 transition">
                                    <div class="flex items-center justify-between mb-3">
                                        <span class="font-semibold text-white">${svc}</span>
                                        <span class="text-xs px-2 py-1 rounded ${i < 2 ? 'bg-red-500/20 text-red-400' : 'bg-green-500/20 text-green-400'}">${i < 2 ? 'Tier 1' : 'Tier 2'}</span>
                                    </div>
                                    <div class="text-xs text-gray-400 mb-2">Dependencies: ${Math.floor(Math.random() * 4) + 1}</div>
                                    <div class="text-xs text-gray-400">Dependents: ${Math.floor(Math.random() * 3)}</div>
                                    <div class="mt-3 pt-3 border-t border-gray-700 flex justify-between text-xs">
                                        <span style="color: var(--text-muted);">Blast Radius</span>
                                        <span class="${i < 2 ? 'text-red-400' : 'text-green-400'}">${i < 2 ? '85%' : '25%'}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Learning Status -->
                    <div class="card rounded-xl p-6">
                        <h3 class="text-lg font-bold mb-4" style="color: var(--text-primary);">
                            <i data-lucide="brain" class="inline-block mr-2" style="width: 20px; height: 20px; color: var(--purple); vertical-align: middle;"></i>
                            Behavioral Learning Status
                        </h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                            <div>
                                <div class="text-2xl font-bold text-primary">1,247</div>
                                <div class="text-xs text-gray-400">Metrics Samples</div>
                            </div>
                            <div>
                                <div class="text-2xl font-bold text-green-400">89%</div>
                                <div class="text-xs text-gray-400">Baseline Confidence</div>
                            </div>
                            <div>
                                <div class="text-2xl font-bold text-purple-400">12</div>
                                <div class="text-xs text-gray-400">Traffic Patterns</div>
                            </div>
                            <div>
                                <div class="text-2xl font-bold text-warning">3h ago</div>
                                <div class="text-xs text-gray-400">Last Update</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAlertTriage() {
            const stats = state.alertTriageStats || {};
            const suppression = stats.suppression_rules || {};
            const neverSuppress = stats.never_suppress_patterns || ['security', 'data_loss', 'corruption', 'breach', 'pii', 'payment_failure', 'database_down'];

            const totalAlerts = stats.total_alerts_received || 847;
            const suppressed = stats.alerts_suppressed || 612;
            const noiseReduction = stats.noise_reduction_percent || 72;
            const escalated = Math.floor((totalAlerts - suppressed) * 0.18) || 42;
            const paged = Math.floor((totalAlerts - suppressed) * 0.034) || 8;
            const flapping = suppression.flapping_detection || 15;

            return `
                <div class="space-y-6">
                    <!-- Header -->
                    <div class="flex items-center justify-between">
                        <div>
                            <h1 class="text-2xl font-bold" style="color: var(--text-primary);">
                                <i data-lucide="bell-off" class="inline-block mr-2" style="width: 28px; height: 28px; color: var(--primary); vertical-align: middle;"></i>
                                Alert Triage & Noise Suppression
                            </h1>
                            <p class="text-sm" style="color: var(--text-muted);">Intelligent alert filtering to reduce noise and escalate actionable incidents</p>
                        </div>
                        <div class="text-xs px-3 py-1 bg-green-600/20 text-green-400 rounded-full">
                            <i data-lucide="activity" class="inline-block mr-1" style="width: 12px; height: 12px;"></i> LIVE
                        </div>
                    </div>

                    <!-- Suppression Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                        <div class="card rounded-xl p-5">
                            <div class="text-xs uppercase tracking-wider mb-2" style="color: var(--text-muted);">Alerts Today</div>
                            <div class="text-3xl font-bold" style="color: var(--text-primary);">${totalAlerts}</div>
                        </div>
                        <div class="card rounded-xl p-5">
                            <div class="text-xs uppercase tracking-wider mb-2" style="color: var(--text-muted);">Suppressed</div>
                            <div class="text-3xl font-bold" style="color: var(--success);">${suppressed}</div>
                            <div class="text-xs text-success mt-1">${noiseReduction}% noise reduction</div>
                        </div>
                        <div class="card rounded-xl p-5">
                            <div class="text-xs uppercase tracking-wider mb-2" style="color: var(--text-muted);">Escalated</div>
                            <div class="text-3xl font-bold" style="color: var(--warning);">${escalated}</div>
                        </div>
                        <div class="card rounded-xl p-5">
                            <div class="text-xs uppercase tracking-wider mb-2" style="color: var(--text-muted);">Paged</div>
                            <div class="text-3xl font-bold" style="color: var(--error);">${paged}</div>
                        </div>
                        <div class="card rounded-xl p-5">
                            <div class="text-xs uppercase tracking-wider mb-2" style="color: var(--text-muted);">Flapping</div>
                            <div class="text-3xl font-bold" style="color: var(--purple);">${flapping}</div>
                        </div>
                    </div>

                    <!-- Triage Rules -->
                    <div class="card-glow rounded-xl p-6">
                        <h3 class="text-lg font-bold mb-4" style="color: var(--text-primary);">
                            <i data-lucide="filter" class="inline-block mr-2" style="width: 20px; height: 20px; color: var(--primary); vertical-align: middle;"></i>
                            Suppression Rules Active
                        </h3>
                        <div class="space-y-3">
                            ${[
                    { rule: 'Duplicate Alert (5min window)', suppressed: suppression.duplicate_alert || 312, icon: 'copy' },
                    { rule: 'Flapping Detection (5+ changes/10min)', suppressed: suppression.flapping_detection || 89, icon: 'repeat' },
                    { rule: 'Low Actionability (<40%)', suppressed: suppression.low_actionability || 156, icon: 'thumb-down' },
                    { rule: 'Maintenance Window', suppressed: suppression.maintenance_window || 55, icon: 'wrench' }
                ].map(r => `
                                <div class="flex items-center justify-between p-3 bg-black bg-opacity-30 rounded-lg">
                                    <div class="flex items-center gap-3">
                                        <i data-lucide="${r.icon}" style="width: 18px; height: 18px; color: var(--text-muted);"></i>
                                        <span class="text-white">${r.rule}</span>
                                    </div>
                                    <span class="text-green-400 font-semibold">${r.suppressed} suppressed</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Never Suppress Patterns -->
                    <div class="card rounded-xl p-6">
                        <h3 class="text-lg font-bold mb-4" style="color: var(--text-primary);">
                            <i data-lucide="shield-alert" class="inline-block mr-2" style="width: 20px; height: 20px; color: var(--error); vertical-align: middle;"></i>
                            Never-Suppress Patterns
                        </h3>
                        <div class="flex flex-wrap gap-2">
                            ${neverSuppress.map(p => `
                                <span class="px-3 py-1 bg-red-500/20 text-red-400 rounded-full text-sm">${p.replace('_', ' ')}</span>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderMTTREngine() {
            // Use live data from API - ensure numeric values with parseFloat
            const stats = state.mttrStats || {};
            const avgResolutionTime = parseFloat(stats.avg_resolution_time_minutes || 2.4).toFixed(1);
            const parallelSpeedup = parseFloat(stats.parallel_speedup || 4.2).toFixed(1);
            const rootCauseAccuracy = parseInt(stats.root_cause_accuracy) || 94;
            const resolutionsToday = parseInt(stats.resolutions_today) || (state.outcomes?.length || 0);
            const timeSaved = parseFloat(stats.time_saved_hours || 3.2).toFixed(1);
            const improvementPercent = parseInt(stats.improvement_percent) || 65;

            return `
                <div class="space-y-6">
                    <!-- Header -->
                    <div class="flex items-center justify-between">
                        <div>
                            <h1 class="text-2xl font-bold" style="color: var(--text-primary);">
                                <i data-lucide="gauge" class="inline-block mr-2" style="width: 28px; height: 28px; color: var(--primary); vertical-align: middle;"></i>
                                MTTR Acceleration Engine
                            </h1>
                            <p class="text-sm" style="color: var(--text-muted);">Parallel analysis to minimize Mean Time To Resolution</p>
                        </div>
                        <div class="text-xs px-3 py-1 bg-green-600/20 text-green-400 rounded-full">
                            <i data-lucide="activity" class="inline-block mr-1" style="width: 12px; height: 12px;"></i> LIVE
                        </div>
                    </div>

                    <!-- MTTR Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="card-glow rounded-xl p-5">
                            <div class="text-xs uppercase tracking-wider mb-2" style="color: var(--text-muted);">Avg Resolution Time</div>
                            <div class="text-3xl font-bold text-primary">${avgResolutionTime} min</div>
                            <div class="text-xs text-green-400 mt-1">‚Üì ${improvementPercent}% vs manual</div>
                        </div>
                        <div class="card rounded-xl p-5">
                            <div class="text-xs uppercase tracking-wider mb-2" style="color: var(--text-muted);">Parallel Speedup</div>
                            <div class="text-3xl font-bold" style="color: var(--success);">${parallelSpeedup}x</div>
                            <div class="text-xs text-gray-400 mt-1">${timeSaved}h saved today</div>
                        </div>
                        <div class="card rounded-xl p-5">
                            <div class="text-xs uppercase tracking-wider mb-2" style="color: var(--text-muted);">Root Cause Accuracy</div>
                            <div class="text-3xl font-bold" style="color: var(--purple);">${rootCauseAccuracy}%</div>
                        </div>
                        <div class="card rounded-xl p-5">
                            <div class="text-xs uppercase tracking-wider mb-2" style="color: var(--text-muted);">Resolutions Today</div>
                            <div class="text-3xl font-bold" style="color: var(--text-primary);">${resolutionsToday}</div>
                        </div>
                    </div>

                    <!-- Analysis Strategies -->
                    <div class="card-glow rounded-xl p-6">
                        <h3 class="text-lg font-bold mb-4" style="color: var(--text-primary);">
                            <i data-lucide="layers" class="inline-block mr-2" style="width: 20px; height: 20px; color: var(--primary); vertical-align: middle;"></i>
                            Parallel Analysis Strategies
                        </h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            ${[
                    { name: 'Log Analysis', icon: 'file-text', time: '45ms', confidence: 85 },
                    { name: 'Metric Correlation', icon: 'activity', time: '32ms', confidence: 80 },
                    { name: 'Deployment Check', icon: 'rocket', time: '28ms', confidence: 92 },
                    { name: 'Dependency Check', icon: 'git-branch', time: '55ms', confidence: 78 },
                    { name: 'Pattern Matching', icon: 'search', time: '22ms', confidence: 88 },
                    { name: 'Historical Lookup', icon: 'history', time: '38ms', confidence: 72 }
                ].map(s => `
                                <div class="bg-black bg-opacity-30 rounded-lg p-4 border border-gray-700">
                                    <div class="flex items-center gap-2 mb-3">
                                        <i data-lucide="${s.icon}" style="width: 18px; height: 18px; color: var(--primary);"></i>
                                        <span class="font-semibold text-white">${s.name}</span>
                                    </div>
                                    <div class="flex justify-between text-sm">
                                        <span class="text-gray-400">Avg Time: <span class="text-green-400">${s.time}</span></span>
                                        <span class="text-gray-400">Conf: <span class="text-purple-400">${s.confidence}%</span></span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Pre-computed Remediations -->
                    <div class="card rounded-xl p-6">
                        <h3 class="text-lg font-bold mb-4" style="color: var(--text-primary);">
                            <i data-lucide="zap" class="inline-block mr-2" style="width: 20px; height: 20px; color: var(--warning); vertical-align: middle;"></i>
                            Speculative Remediation Plans (Pre-computed)
                        </h3>
                        <div class="flex flex-wrap gap-3">
                            ${['Rollback', 'Scale Up', 'Restart', 'Circuit Breaker', 'Config Rollback'].map(p => `
                                <span class="px-4 py-2 bg-primary/10 text-primary border border-primary/30 rounded-lg text-sm font-medium">${p}</span>
                            `).join('')}
                        </div>
                        <p class="text-xs text-gray-400 mt-3">Remediation plans are pre-computed during analysis for instant execution</p>
                    </div>
                </div>
            `;
        }

        function renderTimelineView() {
            return `
                <div class="space-y-6">
                    <!-- Header -->
                    <div class="flex items-center justify-between">
                        <div>
                            <h1 class="text-2xl font-bold" style="color: var(--text-primary);">
    Incident Timeline
                            </h1>
                            <p class="text-sm" style="color: var(--text-muted);">Unified chronological view correlating all incident events</p>
                        </div>
                    </div>

                    <!-- Timeline Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="card rounded-xl p-5">
                            <div class="text-xs uppercase tracking-wider mb-2" style="color: var(--text-muted);">Event Sources</div>
                            <div class="text-3xl font-bold text-primary">7</div>
                        </div>
                        <div class="card rounded-xl p-5">
                            <div class="text-xs uppercase tracking-wider mb-2" style="color: var(--text-muted);">Events Today</div>
                            <div class="text-3xl font-bold" style="color: var(--text-primary);">156</div>
                        </div>
                        <div class="card rounded-xl p-5">
                            <div class="text-xs uppercase tracking-wider mb-2" style="color: var(--text-muted);">Root Causes Found</div>
                            <div class="text-3xl font-bold" style="color: var(--success);">12</div>
                        </div>
                        <div class="card rounded-xl p-5">
                            <div class="text-xs uppercase tracking-wider mb-2" style="color: var(--text-muted);">Avg Correlation</div>
                            <div class="text-3xl font-bold" style="color: var(--purple);">89%</div>
                        </div>
                    </div>

                    <!-- Sample Timeline -->
                    <div class="card-glow rounded-xl p-6">
                        <h3 class="text-lg font-bold mb-4" style="color: var(--text-primary);">
Recent Incident Timeline
                        </h3>
                        <div class="relative pl-6 space-y-4">
                            <!-- Timeline line -->
                            <div class="absolute left-2 top-2 bottom-2 w-0.5 bg-gray-700"></div>
                            
                            ${[
                    { time: '14:32:00', color: 'warning', title: 'Deployment', desc: 'payment-service v2.3.1 deployed', tag: 'ROOT CAUSE' },
                    { time: '14:34:15', color: 'error', title: 'Metric Anomaly', desc: 'latency_p99 = 2450ms (baseline: 250ms)', tag: '' },
                    { time: '14:35:00', color: 'error', title: 'Alert Triggered', desc: 'High Latency Alert on payment-service', tag: '' },
                    { time: '14:36:22', color: 'primary', title: 'Action Proposed', desc: 'Rollback to v2.3.0 (confidence: 92%)', tag: '' },
                    { time: '14:37:00', color: 'success', title: 'Rollback Executed', desc: 'Reverted to payment-service v2.3.0', tag: '' },
                    { time: '14:42:00', color: 'success', title: 'Incident Resolved', desc: 'Latency normalized, service healthy', tag: 'RESOLUTION' }
                ].map(e => `
                                <div class="relative flex items-start gap-4">
                                    <div class="absolute -left-4 w-3 h-3 rounded-full ${e.color === 'primary' ? '' : e.color === 'success' ? 'bg-green-500' : e.color === 'warning' ? 'bg-yellow-500' : 'bg-red-500'} border-2 border-gray-900" style="${e.color === 'primary' ? 'background: var(--primary);' : ''}"></div>
                                    <div class="flex-1 bg-black bg-opacity-30 rounded-lg p-3 border border-gray-700">
                                        <div class="flex items-center justify-between mb-1">
                                            <div class="flex items-center gap-2">
                                                <span class="font-semibold" style="color: var(--${e.color === 'primary' ? 'text-primary' : e.color});">${e.title}</span>
                                                ${e.tag ? `<span class="text-xs px-2 py-0.5 rounded ${e.tag === 'ROOT CAUSE' ? 'bg-red-500/20 text-red-400' : 'bg-green-500/20 text-green-400'}">${e.tag}</span>` : ''}
                                            </div>
                                            <span class="text-xs text-gray-500">${e.time}</span>
                                        </div>
                                        <p class="text-sm text-gray-400">${e.desc}</p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Event Sources -->
                    <div class="card rounded-xl p-6">
                        <h3 class="text-lg font-bold mb-4" style="color: var(--text-primary);">
Correlated Event Sources
                        </h3>
                        <div class="flex flex-wrap gap-3">
                            ${['Deployments', 'Metric Anomalies', 'Alerts', 'Actions', 'Decisions', 'Log Errors', 'Incident Lifecycle'].map(s => `
                                <span class="px-4 py-2 bg-purple-500/10 text-purple-400 border border-purple-500/30 rounded-lg text-sm">${s}</span>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderCostInsights() {
            // Use live data from API - ensure numeric values
            const stats = state.costStats || {};
            const todaysSpend = parseInt(stats.todays_spend) || 1247;
            const monthlyBudget = parseInt(stats.monthly_budget) || 45000;
            const budgetUsedPercent = parseInt(stats.budget_used_percent) || 42;
            const underBudgetPercent = parseInt(stats.under_budget_percent) || 18;
            const costAnomalies = parseInt(stats.cost_anomalies) || 3;
            const savingsThisMonth = parseInt(stats.savings_this_month) || 2340;
            const anomalyDetails = stats.anomaly_details || [
                { type: 'Cost Spike', service: 'data-pipeline', amount: '$340/hr', severity: 'high', action: 'Scale Down Proposed' },
                { type: 'Unused Resources', service: 'ml-training', amount: '$120/day', severity: 'medium', action: 'Terminate Idle Instances' },
                { type: 'Over-provisioned', service: 'api-gateway', amount: '$85/day', severity: 'low', action: 'Rightsize Suggested' }
            ];

            return `
                <div class="space-y-6">
                    <!-- Header -->
                    <div class="flex items-center justify-between">
                        <div>
                            <h1 class="text-2xl font-bold" style="color: var(--text-primary);">
                                <i data-lucide="dollar-sign" class="inline-block mr-2" style="width: 28px; height: 28px; color: var(--primary); vertical-align: middle;"></i>
                                Cloud Cost Intelligence
                            </h1>
                            <p class="text-sm" style="color: var(--text-muted);">Cost anomaly detection and budget monitoring</p>
                        </div>
                        <div class="text-xs px-3 py-1 bg-green-600/20 text-green-400 rounded-full">
                            <i data-lucide="activity" class="inline-block mr-1" style="width: 12px; height: 12px;"></i> LIVE
                        </div>
                    </div>

                    <!-- Cost Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="card-glow rounded-xl p-5">
                            <div class="text-xs uppercase tracking-wider mb-2" style="color: var(--text-muted);">Today's Spend</div>
                            <div class="text-3xl font-bold text-primary">$${todaysSpend.toLocaleString()}</div>
                            <div class="text-xs text-green-400 mt-1">${underBudgetPercent}% under budget</div>
                        </div>
                        <div class="card rounded-xl p-5">
                            <div class="text-xs uppercase tracking-wider mb-2" style="color: var(--text-muted);">Monthly Budget</div>
                            <div class="text-3xl font-bold" style="color: var(--text-primary);">$${monthlyBudget.toLocaleString()}</div>
                            <div class="w-full bg-gray-700 rounded-full h-2 mt-2">
                                <div class="bg-primary rounded-full h-2" style="width: ${budgetUsedPercent}%;"></div>
                            </div>
                        </div>
                        <div class="card rounded-xl p-5">
                            <div class="text-xs uppercase tracking-wider mb-2" style="color: var(--text-muted);">Cost Anomalies</div>
                            <div class="text-3xl font-bold" style="color: var(--warning);">${costAnomalies}</div>
                        </div>
                        <div class="card rounded-xl p-5">
                            <div class="text-xs uppercase tracking-wider mb-2" style="color: var(--text-muted);">Savings This Month</div>
                            <div class="text-3xl font-bold" style="color: var(--success);">$${savingsThisMonth.toLocaleString()}</div>
                        </div>
                    </div>

                    <!-- Cost Anomalies -->
                    <div class="card-glow rounded-xl p-6">
                        <h3 class="text-lg font-bold mb-4" style="color: var(--text-primary);">
                            <i data-lucide="alert-triangle" class="inline-block mr-2" style="width: 20px; height: 20px; color: var(--warning); vertical-align: middle;"></i>
                            Active Cost Anomalies
                        </h3>
                        <div class="space-y-3">
                            ${[
                    { type: 'Cost Spike', service: 'data-pipeline', amount: '$340/hr', severity: 'high', action: 'Scale Down Proposed' },
                    { type: 'Zombie Resource', service: 'dev-cluster', amount: '$45/day', severity: 'medium', action: 'Terminate Proposed' },
                    { type: 'Data Transfer', service: 'cdn-origin', amount: '$120/hr', severity: 'medium', action: 'Rate Limit Proposed' }
                ].map(a => `
                                <div class="flex items-center justify-between p-4 bg-black bg-opacity-30 rounded-lg border ${a.severity === 'high' ? 'border-red-500/30' : 'border-yellow-500/30'}">
                                    <div class="flex items-center gap-4">
                                        <div class="w-10 h-10 rounded-lg ${a.severity === 'high' ? 'bg-red-500/20' : 'bg-yellow-500/20'} flex items-center justify-center">
                                            <i data-lucide="trending-up" style="width: 20px; height: 20px;" class="${a.severity === 'high' ? 'text-red-400' : 'text-yellow-400'}"></i>
                                        </div>
                                        <div>
                                            <div class="font-semibold text-white">${a.type}: ${a.service}</div>
                                            <div class="text-sm text-gray-400">${a.action}</div>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-lg font-bold ${a.severity === 'high' ? 'text-red-400' : 'text-yellow-400'}">${a.amount}</div>
                                        <div class="text-xs text-gray-500">excess cost</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Budget Thresholds -->
                    <div class="card rounded-xl p-6">
                        <h3 class="text-lg font-bold mb-4" style="color: var(--text-primary);">
                            <i data-lucide="target" class="inline-block mr-2" style="width: 20px; height: 20px; color: var(--primary); vertical-align: middle;"></i>
                            Budget Alert Thresholds
                        </h3>
                        <div class="grid grid-cols-4 gap-4">
                            ${[
                    { pct: '50%', status: 'passed', color: 'green' },
                    { pct: '75%', status: 'upcoming', color: 'yellow' },
                    { pct: '90%', status: 'not reached', color: 'gray' },
                    { pct: '100%', status: 'not reached', color: 'gray' }
                ].map(t => `
                                <div class="text-center p-4 bg-black bg-opacity-30 rounded-lg border border-${t.color}-500/30">
                                    <div class="text-2xl font-bold text-${t.color}-400">${t.pct}</div>
                                    <div class="text-xs text-gray-400 mt-1">${t.status}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await initializeSubscription();
            // Try to fetch live API data first, fall back to demo data if API unavailable
            const hasLiveData = await fetchAllData();
            if (!hasLiveData) {
                console.log('‚ÑπÔ∏è API unavailable, loading demo data');
                await loadDemoData();
                state.loading = false;
                render();
            }
            initializeCharts();
            // Auto-refresh every 10 seconds for live data
            setInterval(async () => {
                if (!state.loading) {
                    await fetchAllData();
                }
            }, 10000);
        });
    </script>
</body>

</html>